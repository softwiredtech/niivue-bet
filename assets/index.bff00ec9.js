const $s=function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerpolicy&&(o.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?o.credentials="include":s.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}};$s();var M=function(t,i,e){var n=this;this.program=Os(t,i,e);var s=/uniform[^;]+[ ](\w+);/g,o=/uniform[^;]+[ ](\w+);/;this.uniforms={};var r=i.match(s),a=e.match(s);r&&r.forEach(function(l){var h=l.match(o);n.uniforms[h[1]]=-1}),a&&a.forEach(function(l){var h=l.match(o);n.uniforms[h[1]]=-1});for(var c in this.uniforms)this.uniforms[c]=t.getUniformLocation(this.program,c)};M.prototype.use=function(t){t.useProgram(this.program)};var Os=function(t,i,e){var n=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(n,i),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))return alert("Vertex shader failed to compile, see console for log"),console.log(t.getShaderInfoLog(n)),null;var s=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(s,e),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))return alert("Fragment shader failed to compile, see console for log"),console.log(t.getShaderInfoLog(s)),null;var o=t.createProgram();return t.attachShader(o,n),t.attachShader(o,s),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)?o:(alert("Shader failed to link, see console for log"),console.log(t.getProgramInfoLog(o)),null)},j=typeof Float32Array!="undefined"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var t=0,i=arguments.length;i--;)t+=arguments[i]*arguments[i];return Math.sqrt(t)});function zs(t,i,e,n,s,o,r,a,c){var l=new j(9);return l[0]=t,l[1]=i,l[2]=e,l[3]=n,l[4]=s,l[5]=o,l[6]=r,l[7]=a,l[8]=c,l}function it(){var t=new j(16);return j!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function K(t){var i=new j(16);return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i}function Gs(t,i){return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],t}function zt(t,i,e,n,s,o,r,a,c,l,h,p,f,u,v,g){var m=new j(16);return m[0]=t,m[1]=i,m[2]=e,m[3]=n,m[4]=s,m[5]=o,m[6]=r,m[7]=a,m[8]=c,m[9]=l,m[10]=h,m[11]=p,m[12]=f,m[13]=u,m[14]=v,m[15]=g,m}function Vs(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function ue(t,i){if(t===i){var e=i[1],n=i[2],s=i[3],o=i[6],r=i[7],a=i[11];t[1]=i[4],t[2]=i[8],t[3]=i[12],t[4]=e,t[6]=i[9],t[7]=i[13],t[8]=n,t[9]=o,t[11]=i[14],t[12]=s,t[13]=r,t[14]=a}else t[0]=i[0],t[1]=i[4],t[2]=i[8],t[3]=i[12],t[4]=i[1],t[5]=i[5],t[6]=i[9],t[7]=i[13],t[8]=i[2],t[9]=i[6],t[10]=i[10],t[11]=i[14],t[12]=i[3],t[13]=i[7],t[14]=i[11],t[15]=i[15];return t}function Gt(t,i){var e=i[0],n=i[1],s=i[2],o=i[3],r=i[4],a=i[5],c=i[6],l=i[7],h=i[8],p=i[9],f=i[10],u=i[11],v=i[12],g=i[13],m=i[14],_=i[15],b=e*a-n*r,x=e*c-s*r,d=e*l-o*r,E=n*c-s*a,A=n*l-o*a,T=s*l-o*c,I=h*g-p*v,R=h*m-f*v,S=h*_-u*v,w=p*m-f*g,k=p*_-u*g,U=f*_-u*m,D=b*U-x*k+d*w+E*S-A*R+T*I;return D?(D=1/D,t[0]=(a*U-c*k+l*w)*D,t[1]=(s*k-n*U-o*w)*D,t[2]=(g*T-m*A+_*E)*D,t[3]=(f*A-p*T-u*E)*D,t[4]=(c*S-r*U-l*R)*D,t[5]=(e*U-s*S+o*R)*D,t[6]=(m*d-v*T-_*x)*D,t[7]=(h*T-f*d+u*x)*D,t[8]=(r*k-a*S+l*I)*D,t[9]=(n*S-e*k-o*I)*D,t[10]=(v*A-g*d+_*b)*D,t[11]=(p*d-h*A-u*b)*D,t[12]=(a*R-r*w-c*I)*D,t[13]=(e*w-n*R+s*I)*D,t[14]=(g*x-v*E-m*b)*D,t[15]=(h*E-p*x+f*b)*D,t):null}function Be(t,i,e){var n=i[0],s=i[1],o=i[2],r=i[3],a=i[4],c=i[5],l=i[6],h=i[7],p=i[8],f=i[9],u=i[10],v=i[11],g=i[12],m=i[13],_=i[14],b=i[15],x=e[0],d=e[1],E=e[2],A=e[3];return t[0]=x*n+d*a+E*p+A*g,t[1]=x*s+d*c+E*f+A*m,t[2]=x*o+d*l+E*u+A*_,t[3]=x*r+d*h+E*v+A*b,x=e[4],d=e[5],E=e[6],A=e[7],t[4]=x*n+d*a+E*p+A*g,t[5]=x*s+d*c+E*f+A*m,t[6]=x*o+d*l+E*u+A*_,t[7]=x*r+d*h+E*v+A*b,x=e[8],d=e[9],E=e[10],A=e[11],t[8]=x*n+d*a+E*p+A*g,t[9]=x*s+d*c+E*f+A*m,t[10]=x*o+d*l+E*u+A*_,t[11]=x*r+d*h+E*v+A*b,x=e[12],d=e[13],E=e[14],A=e[15],t[12]=x*n+d*a+E*p+A*g,t[13]=x*s+d*c+E*f+A*m,t[14]=x*o+d*l+E*u+A*_,t[15]=x*r+d*h+E*v+A*b,t}function He(t,i,e){var n=e[0],s=e[1],o=e[2],r,a,c,l,h,p,f,u,v,g,m,_;return i===t?(t[12]=i[0]*n+i[4]*s+i[8]*o+i[12],t[13]=i[1]*n+i[5]*s+i[9]*o+i[13],t[14]=i[2]*n+i[6]*s+i[10]*o+i[14],t[15]=i[3]*n+i[7]*s+i[11]*o+i[15]):(r=i[0],a=i[1],c=i[2],l=i[3],h=i[4],p=i[5],f=i[6],u=i[7],v=i[8],g=i[9],m=i[10],_=i[11],t[0]=r,t[1]=a,t[2]=c,t[3]=l,t[4]=h,t[5]=p,t[6]=f,t[7]=u,t[8]=v,t[9]=g,t[10]=m,t[11]=_,t[12]=r*n+h*s+v*o+i[12],t[13]=a*n+p*s+g*o+i[13],t[14]=c*n+f*s+m*o+i[14],t[15]=l*n+u*s+_*o+i[15]),t}function $n(t,i,e){var n=Math.sin(e),s=Math.cos(e),o=i[4],r=i[5],a=i[6],c=i[7],l=i[8],h=i[9],p=i[10],f=i[11];return i!==t&&(t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15]),t[4]=o*s+l*n,t[5]=r*s+h*n,t[6]=a*s+p*n,t[7]=c*s+f*n,t[8]=l*s-o*n,t[9]=h*s-r*n,t[10]=p*s-a*n,t[11]=f*s-c*n,t}function On(t,i,e){var n=Math.sin(e),s=Math.cos(e),o=i[0],r=i[1],a=i[2],c=i[3],l=i[4],h=i[5],p=i[6],f=i[7];return i!==t&&(t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15]),t[0]=o*s+l*n,t[1]=r*s+h*n,t[2]=a*s+p*n,t[3]=c*s+f*n,t[4]=l*s-o*n,t[5]=h*s-r*n,t[6]=p*s-a*n,t[7]=f*s-c*n,t}function Hs(t,i,e,n,s,o,r){var a=1/(i-e),c=1/(n-s),l=1/(o-r);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*c,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(i+e)*a,t[13]=(s+n)*c,t[14]=(r+o)*l,t[15]=1,t}var Oi=Hs;function It(){var t=new j(3);return j!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Zs(t){var i=new j(3);return i[0]=t[0],i[1]=t[1],i[2]=t[2],i}function Xs(t){var i=t[0],e=t[1],n=t[2];return Math.hypot(i,e,n)}function z(t,i,e){var n=new j(3);return n[0]=t,n[1]=i,n[2]=e,n}function zi(t,i){return t[0]=i[0],t[1]=i[1],t[2]=i[2],t}function Gi(t,i,e){return t[0]=i[0]+e[0],t[1]=i[1]+e[1],t[2]=i[2]+e[2],t}function bt(t,i,e){return t[0]=i[0]-e[0],t[1]=i[1]-e[1],t[2]=i[2]-e[2],t}function Ys(t,i,e){return t[0]=Math.min(i[0],e[0]),t[1]=Math.min(i[1],e[1]),t[2]=Math.min(i[2],e[2]),t}function js(t,i,e){return t[0]=Math.max(i[0],e[0]),t[1]=Math.max(i[1],e[1]),t[2]=Math.max(i[2],e[2]),t}function qs(t,i){return t[0]=-i[0],t[1]=-i[1],t[2]=-i[2],t}function Fe(t,i){var e=i[0],n=i[1],s=i[2],o=e*e+n*n+s*s;return o>0&&(o=1/Math.sqrt(o)),t[0]=i[0]*o,t[1]=i[1]*o,t[2]=i[2]*o,t}function Ws(t,i){return t[0]*i[0]+t[1]*i[1]+t[2]*i[2]}function Ks(t,i,e){var n=i[0],s=i[1],o=i[2],r=e[0],a=e[1],c=e[2];return t[0]=s*c-o*a,t[1]=o*r-n*c,t[2]=n*a-s*r,t}function Qs(t,i,e,n){var s=i[0],o=i[1],r=i[2];return t[0]=s+n*(e[0]-s),t[1]=o+n*(e[1]-o),t[2]=r+n*(e[2]-r),t}function Ze(t,i){var e=t[0],n=t[1],s=t[2],o=i[0],r=i[1],a=i[2],c=Math.sqrt(e*e+n*n+s*s),l=Math.sqrt(o*o+r*r+a*a),h=c*l,p=h&&Ws(t,i)/h;return Math.acos(Math.min(Math.max(p,-1),1))}var Js=Xs;(function(){var t=It();return function(i,e,n,s,o,r){var a,c;for(e||(e=3),n||(n=0),s?c=Math.min(s*e+n,i.length):c=i.length,a=n;a<c;a+=e)t[0]=i[a],t[1]=i[a+1],t[2]=i[a+2],o(t,t,r),i[a]=t[0],i[a+1]=t[1],i[a+2]=t[2];return i}})();function to(){var t=new j(4);return j!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function yt(t,i,e,n){var s=new j(4);return s[0]=t,s[1]=i,s[2]=e,s[3]=n,s}function eo(t,i,e){return t[0]=i[0]+e[0],t[1]=i[1]+e[1],t[2]=i[2]+e[2],t[3]=i[3]+e[3],t}function io(t,i,e){return t[0]=i[0]*e[0],t[1]=i[1]*e[1],t[2]=i[2]*e[2],t[3]=i[3]*e[3],t}function Zt(t,i,e){var n=i[0],s=i[1],o=i[2],r=i[3];return t[0]=e[0]*n+e[4]*s+e[8]*o+e[12]*r,t[1]=e[1]*n+e[5]*s+e[9]*o+e[13]*r,t[2]=e[2]*n+e[6]*s+e[10]*o+e[14]*r,t[3]=e[3]*n+e[7]*s+e[11]*o+e[15]*r,t}var no=io;(function(){var t=to();return function(i,e,n,s,o,r){var a,c;for(e||(e=4),n||(n=0),s?c=Math.min(s*e+n,i.length):c=i.length,a=n;a<c;a+=e)t[0]=i[a],t[1]=i[a+1],t[2]=i[a+2],t[3]=i[a+3],o(t,t,r),i[a]=t[0],i[a+1]=t[1],i[a+2]=t[2],i[a+3]=t[3];return i}})();var ve=`#version 300 es
#line 4
layout(location=0) in vec3 pos;
layout(location=1) in vec3 texCoords;
uniform mat4 mvpMtx;
out vec3 vColor;
void main(void) {
	gl_Position = mvpMtx * vec4(pos, 1.0); //vec4(2.0 * (pos.xyz - 0.5), 1.0);
	vColor = texCoords;
}`;const zn=`vec3 GetBackPosition(vec3 startPositionTex) {
	vec3 startPosition = startPositionTex * volScale; 
	vec3 invR = 1.0 / rayDir;
	vec3 tbot = invR * (vec3(0.0)-startPosition);
	vec3 ttop = invR * (volScale-startPosition);
	vec3 tmax = max(ttop, tbot);
	vec2 t = min(tmax.xx, tmax.yz);
	vec3 endPosition = startPosition + (rayDir * min(t.x, t.y));
	//convert world position back to texture position:
	endPosition = endPosition / volScale;
	return endPosition;
}
vec4 applyClip (vec3 dir, inout vec4 samplePos, inout float len, inout bool isClip) {
	float cdot = dot(dir,clipPlane.xyz);
	isClip = false;
	if  ((clipPlane.a > 1.0) || (cdot == 0.0)) return samplePos;
	bool frontface = (cdot > 0.0);
	float clipThick = 2.0;
	float dis = (-clipPlane.a - dot(clipPlane.xyz, samplePos.xyz-0.5)) / cdot;
	float  disBackFace = (-(clipPlane.a-clipThick) - dot(clipPlane.xyz, samplePos.xyz-0.5)) / cdot;
	if (((frontface) && (dis >= len)) || ((!frontface) && (dis <= 0.0))) {
		samplePos.a = len + 1.0;
		return samplePos;
	}
	if (frontface) {
		dis = max(0.0, dis);
		samplePos = vec4(samplePos.xyz+dir * dis, dis);
		if (dis > 0.0) isClip = true;
		len = min(disBackFace, len);
	}
	if (!frontface) {
		len = min(dis, len);
		disBackFace = max(0.0, disBackFace);
		if (len == dis) isClip = true;
		samplePos = vec4(samplePos.xyz+dir * disBackFace, disBackFace);
	}
	return samplePos;
}`;var so=`#version 300 es
#line 14
precision highp int;
precision highp float;
uniform vec3 rayDir;
uniform vec3 texVox;
uniform vec3 volScale;
uniform vec4 clipPlane;
uniform highp sampler3D volume, overlay;
uniform float overlays;
uniform float backOpacity;
uniform mat4 mvpMtx;
uniform mat4 matRAS;
uniform vec4 clipPlaneColor;
in vec3 vColor;
out vec4 fColor;
`+zn+`
float frac2ndc(vec3 frac) {
//https://stackoverflow.com/questions/7777913/how-to-render-depth-linearly-in-modern-opengl-with-gl-fragcoord-z-in-fragment-sh
	vec4 pos = vec4(frac.xyz, 1.0); //fraction
	vec4 dim = vec4(vec3(textureSize(volume, 0)), 1.0);
	pos = pos * dim;
	vec4 shim = vec4(-0.5, -0.5, -0.5, 0.0);
	pos += shim;
	vec4 mm = transpose(matRAS) * pos;
	float z_ndc = (mvpMtx * vec4(mm.xyz, 1.0)).z;
	return (z_ndc + 1.0) / 2.0;
	
}
void main() {
	fColor = vec4(0.0,0.0,0.0,0.0);
	//fColor = vec4(vColor.rgb, 1.0); return;
	vec3 start = vColor;
	gl_FragDepth = 0.0;
	vec3 backPosition = GetBackPosition(start);
	// fColor = vec4(backPosition, 1.0); return;
	vec3 dir = backPosition - start;
	float len = length(dir);
	float lenVox = length((texVox * start) - (texVox * backPosition));
	if ((lenVox < 0.5) || (len > 3.0)) { //length limit for parallel rays
		return;
	}
	float sliceSize = len / lenVox; //e.g. if ray length is 1.0 and traverses 50 voxels, each voxel is 0.02 in unit cube
	float stepSize = sliceSize; //quality: larger step is faster traversal, but fewer samples
	float opacityCorrection = stepSize/sliceSize;
	dir = normalize(dir);
	vec4 deltaDir = vec4(dir.xyz * stepSize, stepSize);
	vec4 samplePos = vec4(start.xyz, 0.0); //ray position
	float lenNoClip = len;
	bool isClip = false;
	vec4 clipPos = applyClip(dir, samplePos, len, isClip);
	//start: OPTIONAL fast pass: rapid traversal until first hit
	float stepSizeFast = sliceSize * 1.9;
	vec4 deltaDirFast = vec4(dir.xyz * stepSizeFast, stepSizeFast);
	while (samplePos.a <= len) {
		float val = texture(volume, samplePos.xyz).a;
		if (val > 0.01) break;
		samplePos += deltaDirFast; //advance ray position
	}
	if ((samplePos.a >= len) && (overlays < 1.0)) {
		if (isClip)
			fColor += clipPlaneColor;
		return;
	}
	fColor = vec4(1.0, 1.0, 1.0, 1.0);
	//gl_FragDepth = frac2ndc(samplePos.xyz); //crude due to fast pass resolution
	samplePos -= deltaDirFast;
	if (samplePos.a < 0.0)
		vec4 samplePos = vec4(start.xyz, 0.0); //ray position
	//end: fast pass
	vec4 colAcc = vec4(0.0,0.0,0.0,0.0);
	vec4 firstHit = colAcc;
	const float earlyTermination = 0.95;
	float backNearest = len; //assume no hit
	float ran = fract(sin(gl_FragCoord.x * 12.9898 + gl_FragCoord.y * 78.233) * 43758.5453);
	samplePos += deltaDir * ran; //jitter ray
	while (samplePos.a <= len) {
		vec4 colorSample = texture(volume, samplePos.xyz);
		samplePos += deltaDir; //advance ray position
		if (colorSample.a < 0.01) continue;
		if (firstHit.a == 0.0)
			firstHit = samplePos;
		backNearest = min(backNearest, samplePos.a);
		colorSample.a = 1.0-pow((1.0 - colorSample.a), opacityCorrection);
		colorSample.rgb *= colorSample.a;
		colAcc= (1.0 - colAcc.a) * colorSample + colAcc;
		if ( colAcc.a > earlyTermination )
			break;
	}
	if (firstHit.a != 0.0)
		gl_FragDepth = frac2ndc(firstHit.xyz);
	colAcc.a = (colAcc.a / earlyTermination) * backOpacity;
	fColor = colAcc;
	if (overlays < 1.0) return;
	//overlay pass
	len = lenNoClip;
	samplePos = vec4(start.xyz, 0.0); //ray position
	//start: OPTIONAL fast pass: rapid traversal until first hit
	stepSizeFast = sliceSize * 1.9;
	deltaDirFast = vec4(dir.xyz * stepSizeFast, stepSizeFast);
	while (samplePos.a <= len) {
		float val = texture(overlay, samplePos.xyz).a;
		if (val > 0.01) break;
		samplePos += deltaDirFast; //advance ray position
	}
	if (samplePos.a >= len) {
		if (isClip && (fColor.a == 0.0))
			fColor += clipPlaneColor;
		return;
	}
	samplePos -= deltaDirFast;
	if (samplePos.a < 0.0)
		vec4 samplePos = vec4(start.xyz, 0.0); //ray position
	//end: fast pass
	float overFarthest = len;
	colAcc = vec4(0.0, 0.0, 0.0, 0.0);
	samplePos += deltaDir * ran; //jitter ray
	while (samplePos.a <= len) {
		vec4 colorSample = texture(overlay, samplePos.xyz);
		samplePos += deltaDir; //advance ray position
		if (colorSample.a < 0.01) continue;
		colorSample.a = 1.0-pow((1.0 - colorSample.a), opacityCorrection);
		colorSample.rgb *= colorSample.a;
		colAcc= (1.0 - colAcc.a) * colorSample + colAcc;
		overFarthest = samplePos.a;
		if ( colAcc.a > earlyTermination )
			break;
	}
	float overMix = colAcc.a;
	float overlayDepth = 0.3;
	if (fColor.a <= 0.0)
			overMix = 1.0;
	else if (((overFarthest) > backNearest)) {
		float dx = (overFarthest - backNearest)/1.73;
		dx = fColor.a * pow(dx, overlayDepth);
		overMix *= 1.0 - dx;
	}
	fColor.rgb = mix(fColor.rgb, colAcc.rgb, overMix);
	fColor.a = max(fColor.a, colAcc.a);
}`,oo=`#version 300 es
#line 150
layout(location=0) in vec3 pos;
uniform int axCorSag;
uniform float slice;
uniform vec2 canvasWidthHeight;
uniform vec4 leftTopWidthHeight;
out vec3 texPos;
void main(void) {
	//convert pixel x,y space 1..canvasWidth,1..canvasHeight to WebGL 1..-1,-1..1
	vec2 frac;
	frac.x = (leftTopWidthHeight.x + (pos.x * leftTopWidthHeight.z)) / canvasWidthHeight.x; //0..1
	frac.y = 1.0 - ((leftTopWidthHeight.y + ((1.0 - pos.y) * leftTopWidthHeight.w)) / canvasWidthHeight.y); //1..0
	frac = (frac * 2.0) - 1.0;
	gl_Position = vec4(frac, 0.0, 1.0);
	if (axCorSag == 1)
		texPos = vec3(pos.x, slice, pos.y);
	else if (axCorSag == 2)
		texPos = vec3(slice, pos.x, pos.y);
	else
		texPos = vec3(pos.xy, slice);
}`,ro=`#version 300 es
#line 173
precision highp int;
precision highp float;
uniform highp sampler3D volume, overlay;
uniform float overlays;
uniform float opacity;
in vec3 texPos;
out vec4 color;
void main() {
	color = vec4(texture(volume, texPos).rgb, opacity);
	vec4 ocolor = vec4(0.0);
	if (overlays < 1.0) {
	 ocolor = vec4(0.0, 0.0, 0.0, 0.0);
	} else {
		ocolor = texture(overlay, texPos);
	}
	float aout = ocolor.a + (1.0 - ocolor.a) * color.a;
	if (aout <= 0.0) return;
	color.rgb = ((ocolor.rgb * ocolor.a) + (color.rgb * color.a * (1.0 - ocolor.a))) / aout;
	color.a = aout;
}`,ao=`#version 300 es
#line 189
precision highp int;
precision highp float;
uniform vec4 lineColor;
out vec4 color;
void main() {
	color = lineColor;
}`,lo=`#version 300 es
#line 200
layout(location=0) in vec3 pos;
uniform vec2 canvasWidthHeight;
uniform vec4 leftTopWidthHeight;
out vec2 vColor;
void main(void) {
	//convert pixel x,y space 1..canvasWidth,1..canvasHeight to WebGL 1..-1,-1..1
	vec2 frac;
	frac.x = (leftTopWidthHeight.x + (pos.x * leftTopWidthHeight.z)) / canvasWidthHeight.x; //0..1
	frac.y = 1.0 - ((leftTopWidthHeight.y + ((1.0 - pos.y) * leftTopWidthHeight.w)) / canvasWidthHeight.y); //1..0
	frac = (frac * 2.0) - 1.0;
	gl_Position = vec4(frac, 0.0, 1.0);
	vColor = pos.xy;
}`,ho=`#version 300 es
#line 217
precision highp int;
precision highp float;
uniform highp sampler2D colormap;
in vec2 vColor;
out vec4 color;
void main() {
	color = vec4(texture(colormap, vColor).rgb, 1.0);
}`,co=`#version 300 es
#line 229
layout(location=0) in vec3 pos;
uniform vec2 canvasWidthHeight;
uniform vec4 leftTopWidthHeight;
void main(void) {
	//convert pixel x,y space 1..canvasWidth,1..canvasHeight to WebGL 1..-1,-1..1
	vec2 frac;
	frac.x = (leftTopWidthHeight.x + (pos.x * leftTopWidthHeight.z)) / canvasWidthHeight.x; //0..1
	frac.y = 1.0 - ((leftTopWidthHeight.y + ((1.0 - pos.y) * leftTopWidthHeight.w)) / canvasWidthHeight.y); //1..0
	frac = (frac * 2.0) - 1.0;
	gl_Position = vec4(frac, 0.0, 1.0);
}`,Gn=`#version 300 es
#line 244
layout(location=0) in vec3 pos;
uniform vec2 canvasWidthHeight;
uniform vec4 leftTopWidthHeight;
uniform vec4 uvLeftTopWidthHeight;
out vec2 vUV;
void main(void) {
	//convert pixel x,y space 1..canvasWidth,1..canvasHeight to WebGL 1..-1,-1..1
	vec2 frac;
	frac.x = (leftTopWidthHeight.x + (pos.x * leftTopWidthHeight.z)) / canvasWidthHeight.x; //0..1
	frac.y = 1.0 - ((leftTopWidthHeight.y + ((1.0 - pos.y) * leftTopWidthHeight.w)) / canvasWidthHeight.y); //1..0
	frac = (frac * 2.0) - 1.0;
	gl_Position = vec4(frac, 0.0, 1.0);
	vUV = vec2(uvLeftTopWidthHeight.x + (pos.x * uvLeftTopWidthHeight.z), uvLeftTopWidthHeight.y  + ((1.0 - pos.y) * uvLeftTopWidthHeight.w) );
}`,Vn=`#version 300 es
#line 262
precision highp int;
precision highp float;
uniform highp sampler2D fontTexture;
uniform vec4 fontColor;
uniform float screenPxRange;
in vec2 vUV;
out vec4 color;
float median(float r, float g, float b) {
    return max(min(r, g), min(max(r, g), b));
}
void main() {
	vec3 msd = texture(fontTexture, vUV).rgb;
	float sd = median(msd.r, msd.g, msd.b);
    float screenPxDistance = screenPxRange*(sd - 0.5);
    float opacity = clamp(screenPxDistance + 0.5, 0.0, 1.0);
	color = vec4(fontColor.rgb , fontColor.a * opacity);
}`,Qt=`#version 300 es
#line 283
precision highp int;
precision highp float;
in vec3 vPos;
out vec2 TexCoord;
void main() {
    TexCoord = vPos.xy;
    gl_Position = vec4( (vPos.xy-vec2(0.5,0.5)) * 2.0, 0.0, 1.0);
}`,Xe=`#version 300 es
uniform highp usampler3D intensityVol;
`,fo=`#version 300 es
uniform highp isampler3D intensityVol;
`,uo=`#version 300 es
uniform highp sampler3D intensityVol;
`,mo=`#line 309
precision highp int;
precision highp float;
in vec2 TexCoord;
out vec4 FragColor;
uniform float coordZ;
uniform float layer;
uniform float numLayers;
uniform highp sampler2D colormap;
uniform lowp sampler3D blend3D;
uniform float opacity;
uniform vec3 xyzFrac;
uniform mat4 mtx;
void main(void) {
 vec4 vx = vec4(TexCoord.x, TexCoord.y, coordZ, 1.0) * mtx;
 uint idx = texture(intensityVol, vx.xyz).r;
 FragColor = vec4(0.0, 0.0, 0.0, 0.0);
 if (idx == uint(0))
   return;
 if (xyzFrac.x > 0.0) { //outline
   vx = vec4(TexCoord.x+xyzFrac.x, TexCoord.y, coordZ, 1.0) * mtx;
   uint R = texture(intensityVol, vx.xyz).r;
   vx = vec4(TexCoord.x-xyzFrac.x, TexCoord.y, coordZ, 1.0) * mtx;
   uint L = texture(intensityVol, vx.xyz).r;
   vx = vec4(TexCoord.x, TexCoord.y+xyzFrac.y, coordZ, 1.0) * mtx;
   uint A = texture(intensityVol, vx.xyz).r;
   vx = vec4(TexCoord.x, TexCoord.y-xyzFrac.y, coordZ, 1.0) * mtx;
   uint P = texture(intensityVol, vx.xyz).r;
   vx = vec4(TexCoord.x, TexCoord.y, coordZ+xyzFrac.z, 1.0) * mtx;
   uint S = texture(intensityVol, vx.xyz).r;
   vx = vec4(TexCoord.x, TexCoord.y, coordZ-xyzFrac.z, 1.0) * mtx;
   uint I = texture(intensityVol, vx.xyz).r;
   if ((idx == R) && (idx == L) && (idx == A) && (idx == P) && (idx == S) && (idx == I))
     return;
 }
 idx = ((idx - uint(1)) % uint(100))+uint(1);
 float fx = (float(idx)+0.5) / 256.0;
 float y = (2.0 * layer + 1.0)/(2.0 * numLayers);
 FragColor = texture(colormap, vec2(fx, y)).rgba;
 FragColor.a *= opacity;
 if (layer < 2.0) return;
 vec2 texXY = TexCoord.xy*0.5 +vec2(0.5,0.5);
 vec4 prevColor = texture(blend3D, vec3(texXY, coordZ));
 // https://en.wikipedia.org/wiki/Alpha_compositing
 float aout = FragColor.a + (1.0 - FragColor.a) * prevColor.a;
 if (aout <= 0.0) return;
 FragColor.rgb = ((FragColor.rgb * FragColor.a) + (prevColor.rgb * prevColor.a * (1.0 - FragColor.a))) / aout;
 FragColor.a = aout;
}`,Ye=`#line 309
precision highp int;
precision highp float;
in vec2 TexCoord;
out vec4 FragColor;
uniform float coordZ;
uniform float layer;
uniform float numLayers;
uniform float scl_slope;
uniform float scl_inter;
uniform float cal_max;
uniform float cal_min;
uniform highp sampler2D colormap;
uniform lowp sampler3D blend3D;
uniform float opacity;
uniform mat4 mtx;
void main(void) {
 vec4 vx = vec4(TexCoord.xy, coordZ, 1.0) * mtx;
 float f = (scl_slope * float(texture(intensityVol, vx.xyz).r)) + scl_inter;
 float r = max(0.00001, abs(cal_max - cal_min));
 float mn = min(cal_min, cal_max);
 f = mix(0.0, 1.0, (f - mn) / r);
 //float y = 1.0 / numLayers;
 //y = ((layer + 0.5) * y);
 //https://stackoverflow.com/questions/5879403/opengl-texture-coordinates-in-pixel-space
 float y = (2.0 * layer + 1.0)/(2.0 * numLayers);
 FragColor = texture(colormap, vec2(f, y)).rgba;
 FragColor.a *= opacity;
 if (layer < 2.0) return;
 vec2 texXY = TexCoord.xy*0.5 +vec2(0.5,0.5);
 vec4 prevColor = texture(blend3D, vec3(texXY, coordZ));
 // https://en.wikipedia.org/wiki/Alpha_compositing
 float aout = FragColor.a + (1.0 - FragColor.a) * prevColor.a;
 if (aout <= 0.0) return;
 FragColor.rgb = ((FragColor.rgb * FragColor.a) + (prevColor.rgb * prevColor.a * (1.0 - FragColor.a))) / aout;
 FragColor.a = aout;
}`,po=`#line 309
precision highp int;
precision highp float;
in vec2 TexCoord;
out vec4 FragColor;
uniform float coordZ;
uniform float layer;
uniform float numLayers;
uniform float scl_slope;
uniform float scl_inter;
uniform float cal_max;
uniform float cal_min;
uniform highp sampler2D colormap;
uniform lowp sampler3D blend3D;
uniform float opacity;
uniform mat4 mtx;
uniform bool hasAlpha;
void main(void) {
 vec4 vx = vec4(TexCoord.xy, coordZ, 1.0) * mtx;
 uvec4 aColor = texture(intensityVol, vx.xyz);
 FragColor = vec4(float(aColor.r) / 255.0, float(aColor.g) / 255.0, float(aColor.b) / 255.0, float(aColor.a) / 255.0);
 if (!hasAlpha)
   FragColor.a = (FragColor.r * 0.21 + FragColor.g * 0.72 + FragColor.b * 0.07);
 FragColor.a *= opacity;
}`,go=`#version 300 es
#line 283
precision highp int;
precision highp float;
in vec3 vPos;
out vec2 TexCoord;
void main() {
    TexCoord = vPos.xy;
    gl_Position = vec4(vPos.x, vPos.y, 0.0, 1.0);
}`,_o=`#version 300 es
precision highp int;
precision highp float;
in vec2 TexCoord;
out vec4 FragColor;
uniform float coordZ;
uniform lowp sampler3D in3D;
void main(void) {
 FragColor = texture(in3D, vec3(TexCoord.xy, coordZ));
}`,vo=`#version 300 es
layout(location=0) in vec3 pos;
uniform mat4 mvpMtx;
void main(void) {
	gl_Position = mvpMtx * vec4(pos, 1.0);
}`,xo=`#version 300 es
precision highp int;
precision highp float;
uniform vec4 surfaceColor;
out vec4 color;
void main() {
	color = surfaceColor;
}`,bo=`#version 300 es
precision highp int;
precision highp float;
uniform int id;
in vec3 vColor;
out vec4 color;
void main() {
	color = vec4(vColor, float(id & 255) / 255.0);
}`,Vi=`#version 300 es
#line 506
//precision highp int;
precision highp float;
uniform vec3 rayDir;
uniform vec3 volScale;
uniform vec3 texVox;
uniform vec4 clipPlane;
uniform highp sampler3D volume, overlay;
uniform float overlays;
uniform int id;
in vec3 vColor;
out vec4 fColor;
`+zn+`
void main() {
	vec3 start = vColor;
	fColor = vec4(0.0, 0.0, 0.0, 0.0); //assume no hit: ID = 0
	float fid = float(id & 255)/ 255.0;
	vec3 backPosition = GetBackPosition(start);
	vec3 dir = backPosition - start;
	float len = length(dir);
	float lenVox = length((texVox * start) - (texVox * backPosition));
	if ((lenVox < 0.5) || (len > 3.0)) return;//discard; //length limit for parallel rays
	float sliceSize = len / lenVox; //e.g. if ray length is 1.0 and traverses 50 voxels, each voxel is 0.02 in unit cube
	float stepSize = sliceSize; //quality: larger step is faster traversal, but fewer samples
	float opacityCorrection = stepSize/sliceSize;
	dir = normalize(dir);
	vec4 samplePos = vec4(start.xyz, 0.0); //ray position
	float lenNoClip = len;
	bool isClip = false;
	vec4 clipPos = applyClip(dir, samplePos, len, isClip);
	if (isClip) fColor = vec4(samplePos.xyz, 253.0 / 255.0); //assume no hit: ID = 0
	//start: OPTIONAL fast pass: rapid traversal until first hit
	float stepSizeFast = sliceSize * 1.9;
	vec4 deltaDirFast = vec4(dir.xyz * stepSizeFast, stepSizeFast);
	while (samplePos.a <= len) {
		float val = texture(volume, samplePos.xyz).a;
		if (val > 0.01) {
			fColor = vec4(samplePos.rgb, fid);
			break;
		}
		samplePos += deltaDirFast; //advance ray position
	}
	//end: fast pass
	if (overlays < 1.0) {
		//if (fColor.a == 0.0) discard; //no hit, no overlays
		return; //background hit, no overlays
	}
	//overlay pass
	len = min(lenNoClip, samplePos.a); //only find overlay closer than background
	samplePos = vec4(start.xyz, 0.0); //ray position
	while (samplePos.a <= len) {
		float val = texture(overlay, samplePos.xyz).a;
		if (val > 0.01) {
			fColor = vec4(samplePos.rgb, fid);
			return;
		}
		samplePos += deltaDirFast; //advance ray position
	}
	//if (fColor.a == 0.0) discard; //no hit in either background or overlays
	//you only get here if there is a hit with the background that is closer than any overlay
}`;const yo=0,To=0,Eo=[0,0,24,248,255],Ao=[0,0,177,254,0],So=[0,136,0,0,0],wo=[0,32,64,78,128],Io=[0,64,128,156,255];var Ro={min:yo,max:To,R:Eo,G:Ao,B:So,A:wo,I:Io};const Do=0,Bo=0,Fo=[0,0,0],No=[0,0,0],Co=[0,128,255],Uo=[0,64,128],ko=[0,128,255];var Po={min:Do,max:Bo,R:Fo,G:No,B:Co,A:Uo,I:ko};const Mo=0,Lo=0,$o=[0,0,0,0,196,255],Oo=[0,32,128,128,128,32],zo=[0,255,196,0,0,0],Go=[0,128,64,64,64,128],Vo=[0,1,64,128,192,255];var Ho={min:Mo,max:Lo,R:$o,G:Oo,B:zo,A:Go,I:Vo};const Zo=0,Xo=0,Yo=[0,0,0,0],jo=[0,1,128,255],qo=[0,222,127,32],Wo=[0,0,64,128],Ko=[0,1,128,255];var Qo={min:Zo,max:Xo,R:Yo,G:jo,B:qo,A:Wo,I:Ko};const Jo=0,tr=0,er=[0,103,255],ir=[0,126,255],nr=[0,165,255],sr=[0,76,128],or=[0,153,255];var rr={min:Jo,max:tr,R:er,G:ir,B:nr,A:sr,I:or};const ar=0,lr=0,hr=[0,43,103,199,216,255],cr=[0,0,37,155,213,255],fr=[0,0,20,97,201,255],ur=[0,44,48,54,56,56],dr=[0,64,128,196,240,255];var mr={min:ar,max:lr,R:hr,G:cr,B:fr,A:ur,I:dr};const pr=0,gr=0,_r=[0,86,166,255],vr=[32,92,156,233],xr=[76,108,117,69],br=[0,56,80,88],yr=[0,64,192,255];var Tr={min:pr,max:gr,R:_r,G:vr,B:xr,A:br,I:yr};const Er=0,Ar=0,Sr=[0,0,0],wr=[127,196,254],Ir=[255,255,255],Rr=[0,64,128],Dr=[0,128,255];var Br={min:Er,max:Ar,R:Sr,G:wr,B:Ir,A:Rr,I:Dr};const Fr=0,Nr=0,Cr=[0,61,122,183,244,255],Ur=[0,41,81,122,163,203],kr=[0,25,51,76,102,127],Pr=[0,25,51,71,102,128],Mr=[0,51,102,153,204,255];var Lr={min:Fr,max:Nr,R:Cr,G:Ur,B:kr,A:Pr,I:Mr};const $r=0,Or=0,zr=[0,61,122,183,244,255],Gr=[0,41,81,122,163,255],Vr=[0,25,51,76,102,255],Hr=[0,25,51,71,102,128],Zr=[0,51,102,153,204,255];var Xr={min:$r,max:Or,R:zr,G:Gr,B:Vr,A:Hr,I:Zr};const Yr=-643,jr=-235,qr=[0,0,0],Wr=[154,154,154],Kr=[179,179,101],Qr=[0,32,0],Jr=[0,163,255];var ta={min:Yr,max:jr,R:qr,G:Wr,B:Kr,A:Qr,I:Jr};const ea=180,ia=600,na=[0,0,113,255],sa=[0,0,109,250],oa=[0,0,101,245],ra=[0,0,100,160],aa=[0,1,128,255];var la={min:ea,max:ia,R:na,G:sa,B:oa,A:ra,I:aa};const ha=-10,ca=110,fa=[0,199,255],ua=[0,127,255],da=[0,127,255],ma=[0,48,128],pa=[0,124,255];var ga={min:ha,max:ca,R:fa,G:ua,B:da,A:ma,I:pa};const _a=-10,va=110,xa=[0,127,255],ba=[0,127,255],ya=[0,127,255],Ta=[0,48,128],Ea=[0,124,255];var Aa={min:_a,max:va,R:xa,G:ba,B:ya,A:Ta,I:Ea};const Sa=-80,wa=1e3,Ia=[0,189,150,150,150,150,255],Ra=[0,169,54,54,54,54,240],Da=[0,153,52,52,52,52,242],Ba=[0,32,64,0,0,64,64],Fa=[0,1,82,92,234,242,255];var Na={min:Sa,max:wa,R:Ia,G:Ra,B:Da,A:Ba,I:Fa};const Ca=-590,Ua=600,ka=[0,241,241,248,248,178,178,232,255,255,255],Pa=[0,156,156,222,222,36,36,51,255,255,255],Ma=[0,130,130,169,169,24,24,37,255,255,255],La=[0,8,0,0,0,64,64,0,0,222,222],$a=[0,2,3,64,122,142,172,182,252,253,255];var Oa={min:Ca,max:Ua,R:ka,G:Pa,B:Ma,A:La,I:$a};const za=114,Ga=302,Va=[0,255,255],Ha=[0,129,255],Za=[0,0,255],Xa=[0,88,228],Ya=[0,103,255];var ja={min:za,max:Ga,R:Va,G:Ha,B:Za,A:Xa,I:Ya};const qa=-23,Wa=246,Ka=[0,44,255,255,255],Qa=[0,128,90,255,255],Ja=[0,0,70,0,255],tl=[0,0,82,184,228],el=[0,64,131,196,255];var il={min:qa,max:Wa,R:Ka,G:Qa,B:Ja,A:tl,I:el};const nl=-100,sl=246,ol=[0,128,159,255,255,255,255],rl=[0,0,56,90,0,255,255],al=[0,0,41,70,0,0,255],ll=[0,63,105,135,167,184,228],hl=[0,100,128,155,180,209,255];var cl={min:nl,max:sl,R:ol,G:rl,B:al,A:ll,I:hl};const fl=-590,ul=600,dl=[0,241,241,248,248,178,232,255,255],ml=[0,156,156,222,222,36,51,255,255],pl=[0,130,130,169,169,24,37,255,255],gl=[0,63,105,135,167,184,228,228,228],_l=[0,1,52,127,137,162,172,252,255];var vl={min:fl,max:ul,R:dl,G:ml,B:pl,A:gl,I:_l};const xl=140,bl=1024,yl=[0,2,113,255],Tl=[0,1,109,250],El=[0,1,101,245],Al=[0,1,96,168],Sl=[0,1,128,255];var wl={min:xl,max:bl,R:yl,G:Tl,B:El,A:Al,I:Sl};const Il=-923,Rl=679,Dl=[0,0,0,0,0,255,255,255],Bl=[154,154,154,154,0,0,254,255],Fl=[179,179,179,179,0,0,0,255],Nl=[0,3,8,0,0,10,15,20],Cl=[0,30,62,88,170,200,232,255];var Ul={min:Il,max:Rl,R:Dl,G:Bl,B:Fl,A:Nl,I:Cl};const kl=-10,Pl=110,Ml=[0,199,255],Ll=[0,127,255],$l=[0,127,255],Ol=[0,48,128],zl=[0,124,255];var Gl={min:kl,max:Pl,R:Ml,G:Ll,B:$l,A:Ol,I:zl};const Vl=-600,Hl=100,Zl=[0,134,255],Xl=[0,109,250],Yl=[0,101,245],jl=[0,60,148],ql=[0,128,255];var Wl={min:Vl,max:Hl,R:Zl,G:Xl,B:Yl,A:jl,I:ql};const Kl=114,Ql=246,Jl=[0,255,255],t0=[0,128,255],e0=[0,128,255],i0=[0,64,96],n0=[0,87,255];var s0={min:Kl,max:Ql,R:Jl,G:t0,B:e0,A:i0,I:n0};const o0=50,r0=1e3,a0=[98,210,169,128,255],l0=[94,26,77,128,255],h0=[45,21,74,128,255],c0=[0,25,0,4,168],f0=[0,41,87,154,255];var u0={min:o0,max:r0,R:a0,G:l0,B:h0,A:c0,I:f0};const d0=0,m0=0,p0=[0,13,21,26,27,25,22,21,22,28,39,54,75,98,124,148,171,189,202,210,213,211,206,200,195,193,195,201,211,225,240,255],g0=[0,5,11,20,31,44,58,72,86,99,109,116,120,122,122,122,121,121,124,129,137,147,161,175,190,205,218,229,238,245,251,255],_0=[0,14,30,46,61,71,77,78,75,68,60,52,48,47,53,65,83,105,131,157,183,205,222,235,241,243,242,240,239,240,245,255],v0=[0,4,8,12,17,21,25,29,33,37,41,45,50,54,58,62,66,70,74,78,83,87,91,95,99,103,107,111,116,120,124,128],x0=[0,8,16,25,33,41,49,58,66,74,82,90,99,107,115,123,132,140,148,156,165,173,181,189,197,206,214,222,230,239,247,255];var b0={min:d0,max:m0,R:p0,G:g0,B:_0,A:v0,I:x0};const y0=0,T0=0,E0=[0,10,136,255],A0=[0,39,220,255],S0=[0,223,253,255],w0=[0,48,64,70],I0=[0,92,192,255];var R0={min:y0,max:T0,R:E0,G:A0,B:S0,A:w0,I:I0};const D0=0,B0=0,F0=[0,0,128,255,255],N0=[0,128,0,128,255],C0=[0,125,255,0,255],U0=[0,32,64,96,128],k0=[0,63,128,192,255];var P0={min:D0,max:B0,R:F0,G:N0,B:C0,A:U0,I:k0};const M0=0,L0=0,$0=[0,142,227,255],O0=[0,85,170,255],z0=[0,14,76,255],G0=[0,42,84,128],V0=[0,85,170,255];var H0={min:M0,max:L0,R:$0,G:O0,B:z0,A:G0,I:V0};const Z0=0,X0=0,Y0=[0,255],j0=[0,255],q0=[0,255],W0=[0,128],K0=[0,255];var Q0={min:Z0,max:X0,R:Y0,G:j0,B:q0,A:W0,I:K0};const J0=0,th=0,eh=[0,0,0],ih=[0,128,255],nh=[0,0,0],sh=[0,64,128],oh=[0,128,255];var rh={min:J0,max:th,R:eh,G:ih,B:nh,A:sh,I:oh};const ah=0,lh=0,hh=[3,255,255,255],ch=[0,0,255,255],fh=[0,0,0,255],uh=[0,48,96,128],dh=[0,95,191,255];var mh={min:ah,max:lh,R:hh,G:ch,B:fh,A:uh,I:dh};const ph=0,gh=0,_h=[0,255,255,255],vh=[0,0,126,255],xh=[0,0,0,255],bh=[0,64,96,128],yh=[0,128,191,255];var Th={min:ph,max:gh,R:_h,G:vh,B:xh,A:bh,I:yh};const Eh=0,Ah=0,Sh=[255,255,0,0,0,255,255],wh=[0,255,255,255,0,0,0],Ih=[0,0,0,255,255,255,0],Rh=[0,14,28,43,57,71,85],Dh=[0,43,85,128,170,213,255];var Bh={min:Eh,max:Ah,R:Sh,G:wh,B:Ih,A:Rh,I:Dh};const Fh=0,Nh=0,Ch=[0,120,237,240],Uh=[0,28,105,249],kh=[4,109,37,33],Ph=[0,56,80,88],Mh=[0,64,192,255];var Lh={min:Fh,max:Nh,R:Ch,G:Uh,B:kh,A:Ph,I:Mh};const $h=0,Oh=0,zh=[0,0,127,255,127],Gh=[0,127,255,127,0],Vh=[127,255,127,0,0],Hh=[0,32,64,96,128],Zh=[0,63,128,192,255];var Xh={min:$h,max:Oh,R:zh,G:Gh,B:Vh,A:Hh,I:Zh};const Yh=0,jh=0,qh=[94,50,90,152,215,238,249,254,252,241,209,158],Wh=[79,131,186,214,240,244,237,210,157,100,57,1],Kh=[162,189,167,164,155,169,168,123,86,68,79,66],Qh=[0,12,23,35,47,58,70,81,93,105,116,128],Jh=[0,23,46,70,93,116,139,162,185,209,232,255];var tc={min:Yh,max:jh,R:qh,G:Wh,B:Kh,A:Qh,I:Jh};const ec=0,ic=0,nc=[0,148,183,223,247,252],sc=[0,44,55,74,112,253],oc=[4,128,121,104,92,191],rc=[0,44,53,64,75,107],ac=[0,107,128,154,179,255];var lc={min:ec,max:ic,R:nc,G:sc,B:oc,A:rc,I:ac};const hc=0,cc=0,fc=[11,59,55,222],uc=[4,45,165,245],dc=[5,91,172,229],mc=[0,23,70,107],pc=[0,56,167,255];var gc={min:hc,max:cc,R:fc,G:uc,B:dc,A:mc,I:pc};const _c=0,vc=0,xc=[0,85,0,0,0,0,0,0,85,255,255,255,172],bc=[0,0,0,0,85,170,255,255,255,255,85,0,0],yc=[0,170,85,255,255,170,170,0,85,0,0,0,0],Tc=[0,5,10,21,26,32,37,42,48,53,64,72,85],Ec=[0,15,31,63,79,95,111,127,143,159,191,217,255];var Ac={min:_c,max:vc,R:xc,G:bc,B:yc,A:Tc,I:Ec};const Sc=0,wc=0,Ic=[13,156,237,240],Rc=[8,23,121,249],Dc=[135,158,83,33],Bc=[0,56,80,88],Fc=[0,64,192,255];var Nc={min:Sc,max:wc,R:Ic,G:Rc,B:Dc,A:Bc,I:Fc};const Cc=0,Uc=255,kc=[208,71,33,192,32,195,208,173,233,202,25,210,145,89,87,245,246,38,3,25,57,167,245,86,227,208,81,64,90,199,140,48,212,180,70,120,9,192,245,177,65,157,9,193,100,181,125,145,62,8,108,36,140,237,242,248,161,189,41,114,65,121,97,50,238,149,44,214,124,167,40,167,127,178,231,30,173,244,193,203,204,238,139,135,71,234,234,217,66,14,129,19,97,165,112,244,35,73,192,12,149,71,33,192,32,195,208,173,233,202,25,210,145,89,87,245,246,38,3,25,57,167,245,86,227,208,81,64,90,199,140,48,212,180,70,120,9,192,245,177,65,157,9,193,100,181,125,145,62,8,108,36,140,237,242,248,161,189,41,114,65,121,97,50,238,149,44,214,124,167,40,167,127,178,231,30,173,244,193,203,204,238,139,135,71,234,234,217,66,14,129,19,97,165,112,244,35,73,192,12,149,71,33,192,32,195,208,173,233,202,25,210,145,89,87,245,246,38,3,25,57,167,245,86,227,208,81,64,90,199,140,48,212,180,70,120,9,192,245,177,65,157,9,193,100,181,125,145,62,8,108,36,140,237,242,248],Pc=[182,46,78,199,79,89,41,208,135,20,154,35,21,43,230,113,191,147,208,37,28,27,86,203,25,209,148,187,139,111,48,102,76,110,106,130,37,160,34,222,90,165,245,222,102,47,19,130,4,232,137,211,240,11,140,21,42,22,241,61,99,115,199,166,114,190,204,60,233,66,115,230,125,103,203,125,13,176,94,131,39,198,167,124,67,175,254,1,15,198,62,237,159,31,218,58,244,47,61,67,94,46,78,199,79,89,41,208,135,20,154,35,21,43,230,113,191,147,208,37,28,27,86,203,25,209,148,187,139,111,48,102,76,110,106,130,37,160,34,222,90,165,245,222,102,47,19,130,4,232,137,211,240,11,140,21,42,22,241,61,99,115,199,166,114,190,204,60,233,66,115,230,125,103,203,125,13,176,94,131,39,198,167,124,67,175,254,1,15,198,62,237,159,31,218,58,244,47,61,67,94,46,78,199,79,89,41,208,135,20,154,35,21,43,230,113,191,147,208,37,28,27,86,203,25,209,148,187,139,111,48,102,76,110,106,130,37,160,34,222,90,165,245,222,102,47,19,130,4,232,137,211,240,11,140,21],Mc=[191,154,43,10,207,204,164,231,136,58,239,30,147,230,101,111,150,35,128,57,252,79,173,120,25,126,81,85,8,7,122,237,190,152,246,182,130,219,67,76,167,178,235,250,28,61,186,250,199,67,58,50,86,182,108,77,89,112,59,125,226,50,205,227,125,128,104,27,59,66,53,133,159,203,97,125,139,159,158,7,215,47,140,226,223,231,44,110,184,61,233,47,67,148,22,120,173,156,117,181,94,154,43,10,207,204,164,231,136,58,239,30,147,230,101,111,150,35,128,57,252,79,173,120,25,126,81,85,8,7,122,237,190,152,246,182,130,219,67,76,167,178,235,250,28,61,186,250,199,67,58,50,86,182,108,77,89,112,59,125,226,50,205,227,125,128,104,27,59,66,53,133,159,203,97,125,139,159,158,7,215,47,140,226,223,231,44,110,184,61,233,47,67,148,22,120,173,156,117,181,94,154,43,10,207,204,164,231,136,58,239,30,147,230,101,111,150,35,128,57,252,79,173,120,25,126,81,85,8,7,122,237,190,152,246,182,130,219,67,76,167,178,235,250,28,61,186,250,199,67,58,50,86,182,108,77],Lc=[0,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],$c=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255];var Oc={min:Cc,max:Uc,R:kc,G:Pc,B:Mc,A:Lc,I:$c};const zc=0,Gc=0,Vc=[0,128,255],Hc=[0,0,0],Zc=[0,0,0],Xc=[0,64,128],Yc=[0,128,255];var jc={min:zc,max:Gc,R:Vc,G:Hc,B:Zc,A:Xc,I:Yc};const qc=0,Wc=0,Kc=[192,224,255],Qc=[1,128,255],Jc=[0,0,0],t1=[0,64,128],e1=[1,128,255];var i1={min:qc,max:Wc,R:Kc,G:Qc,B:Jc,A:t1,I:e1};const n1=0,s1=0,o1=[3,112,144,188,236,246,255],r1=[5,31,29,22,76,158,250],a1=[26,87,91,86,62,117,235],l1=[0,30,38,49,67,85,107],h1=[0,73,92,118,160,205,255];var c1={min:n1,max:s1,R:o1,G:r1,B:a1,A:l1,I:h1};const f1=0,u1=0,d1=[1,240,255],m1=[1,128,255],p1=[1,128,255],g1=[0,76,128],_1=[0,153,255];var v1={min:f1,max:u1,R:d1,G:m1,B:p1,A:g1,I:_1};const x1=0,b1=0,y1=[0,128,255],T1=[0,0,0],E1=[0,128,255],A1=[0,64,128],S1=[0,128,255];var w1={min:x1,max:b1,R:y1,G:T1,B:E1,A:A1,I:S1};const I1=0,R1=0,D1=[68,49,53,253],B1=[1,104,183,231],F1=[84,142,121,37],N1=[0,56,80,88],C1=[0,64,192,255];var U1={min:I1,max:R1,R:D1,G:B1,B:F1,A:N1,I:C1};const k1=0,P1=0,M1=[255,255,255],L1=[127,196,254],$1=[0,0,0],O1=[0,64,128],z1=[0,128,255];var G1={min:k1,max:P1,R:M1,G:L1,B:$1,A:O1,I:z1};const V1=0,H1=0,Z1=[0,0,0],X1=[0,128,255],Y1=[255,196,128],j1=[0,64,128],q1=[0,128,255];var W1={min:V1,max:H1,R:Z1,G:X1,B:Y1,A:j1,I:q1};const K1=0,Q1=0,J1=[3,64,0,0,255,255,255],tf=[0,0,0,255,255,192,3],ef=[0,32,48,56,64,96,128],nf=[0,8,16,24,32,52,80],sf=[0,32,64,96,160,192,255];var of={min:K1,max:Q1,R:J1,G:tf,B:ef,A:nf,I:sf},$=Object.freeze(Object.defineProperty({__proto__:null,actc:Ro,blue:Po,blue2red:Ho,bluegrn:Qo,bone:rr,bronze:mr,cividis:Tr,cool:Br,copper:Lr,copper2:Xr,ct_airways:ta,ct_bones:la,ct_brain:ga,ct_brain_gray:Aa,ct_cardiac:Na,ct_head:Oa,ct_kidneys:ja,ct_liver:il,ct_muscles:cl,ct_scalp:vl,ct_skull:wl,ct_soft:Ul,ct_soft_tissue:Gl,ct_surface:Wl,ct_vessels:s0,ct_w_contrast:u0,cubehelix:b0,electric_blue:R0,ge_color:P0,gold:H0,gray:Q0,green:rh,hot:mh,hotiron:Th,hsv:Bh,inferno:Lh,jet:Xh,linspecer:tc,magma:lc,mako:gc,nih:Ac,plasma:Nc,random:Oc,red:jc,redyell:i1,rocket:c1,surface:v1,violet:w1,viridis:U1,warm:G1,winter:W1,x_rain:of},Symbol.toStringTag,{value:"Module"})),fi=function(t,i){return fi=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])},fi(t,i)};function Le(t,i){if(typeof i!="function"&&i!==null)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");fi(t,i);function e(){this.constructor=t}t.prototype=i===null?Object.create(i):(e.prototype=i.prototype,new e)}function ui(t){var i=typeof Symbol=="function"&&Symbol.iterator,e=i&&t[i],n=0;if(e)return e.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(i?"Object is not iterable.":"Symbol.iterator is not defined.")}function Ne(t,i){var e=typeof Symbol=="function"&&t[Symbol.iterator];if(!e)return t;var n=e.call(t),s,o=[],r;try{for(;(i===void 0||i-- >0)&&!(s=n.next()).done;)o.push(s.value)}catch(a){r={error:a}}finally{try{s&&!s.done&&(e=n.return)&&e.call(n)}finally{if(r)throw r.error}}return o}function Ce(t,i,e){if(e||arguments.length===2)for(var n=0,s=i.length,o;n<s;n++)(o||!(n in i))&&(o||(o=Array.prototype.slice.call(i,0,n)),o[n]=i[n]);return t.concat(o||Array.prototype.slice.call(i))}function ft(t){return typeof t=="function"}function Hn(t){var i=function(n){Error.call(n),n.stack=new Error().stack},e=t(i);return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}var je=Hn(function(t){return function(e){t(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(n,s){return s+1+") "+n.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}});function di(t,i){if(t){var e=t.indexOf(i);0<=e&&t.splice(e,1)}}var $e=function(){function t(i){this.initialTeardown=i,this.closed=!1,this._parentage=null,this._finalizers=null}return t.prototype.unsubscribe=function(){var i,e,n,s,o;if(!this.closed){this.closed=!0;var r=this._parentage;if(r)if(this._parentage=null,Array.isArray(r))try{for(var a=ui(r),c=a.next();!c.done;c=a.next()){var l=c.value;l.remove(this)}}catch(g){i={error:g}}finally{try{c&&!c.done&&(e=a.return)&&e.call(a)}finally{if(i)throw i.error}}else r.remove(this);var h=this.initialTeardown;if(ft(h))try{h()}catch(g){o=g instanceof je?g.errors:[g]}var p=this._finalizers;if(p){this._finalizers=null;try{for(var f=ui(p),u=f.next();!u.done;u=f.next()){var v=u.value;try{Hi(v)}catch(g){o=o!=null?o:[],g instanceof je?o=Ce(Ce([],Ne(o)),Ne(g.errors)):o.push(g)}}}catch(g){n={error:g}}finally{try{u&&!u.done&&(s=f.return)&&s.call(f)}finally{if(n)throw n.error}}}if(o)throw new je(o)}},t.prototype.add=function(i){var e;if(i&&i!==this)if(this.closed)Hi(i);else{if(i instanceof t){if(i.closed||i._hasParent(this))return;i._addParent(this)}(this._finalizers=(e=this._finalizers)!==null&&e!==void 0?e:[]).push(i)}},t.prototype._hasParent=function(i){var e=this._parentage;return e===i||Array.isArray(e)&&e.includes(i)},t.prototype._addParent=function(i){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(i),e):e?[e,i]:i},t.prototype._removeParent=function(i){var e=this._parentage;e===i?this._parentage=null:Array.isArray(e)&&di(e,i)},t.prototype.remove=function(i){var e=this._finalizers;e&&di(e,i),i instanceof t&&i._removeParent(this)},t.EMPTY=function(){var i=new t;return i.closed=!0,i}(),t}(),Zn=$e.EMPTY;function Xn(t){return t instanceof $e||t&&"closed"in t&&ft(t.remove)&&ft(t.add)&&ft(t.unsubscribe)}function Hi(t){ft(t)?t():t.unsubscribe()}var Bi={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},mi={setTimeout:function(t,i){for(var e=[],n=2;n<arguments.length;n++)e[n-2]=arguments[n];var s=mi.delegate;return s!=null&&s.setTimeout?s.setTimeout.apply(s,Ce([t,i],Ne(e))):setTimeout.apply(void 0,Ce([t,i],Ne(e)))},clearTimeout:function(t){var i=mi.delegate;return((i==null?void 0:i.clearTimeout)||clearTimeout)(t)},delegate:void 0};function rf(t){mi.setTimeout(function(){throw t})}function Zi(){}var xe=null;function Ie(t){if(Bi.useDeprecatedSynchronousErrorHandling){var i=!xe;if(i&&(xe={errorThrown:!1,error:null}),t(),i){var e=xe,n=e.errorThrown,s=e.error;if(xe=null,n)throw s}}else t()}var Yn=function(t){Le(i,t);function i(e){var n=t.call(this)||this;return n.isStopped=!1,e?(n.destination=e,Xn(e)&&e.add(n)):n.destination=cf,n}return i.create=function(e,n,s){return new pi(e,n,s)},i.prototype.next=function(e){this.isStopped||this._next(e)},i.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},i.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},i.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this),this.destination=null)},i.prototype._next=function(e){this.destination.next(e)},i.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},i.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},i}($e),af=Function.prototype.bind;function qe(t,i){return af.call(t,i)}var lf=function(){function t(i){this.partialObserver=i}return t.prototype.next=function(i){var e=this.partialObserver;if(e.next)try{e.next(i)}catch(n){be(n)}},t.prototype.error=function(i){var e=this.partialObserver;if(e.error)try{e.error(i)}catch(n){be(n)}else be(i)},t.prototype.complete=function(){var i=this.partialObserver;if(i.complete)try{i.complete()}catch(e){be(e)}},t}(),pi=function(t){Le(i,t);function i(e,n,s){var o=t.call(this)||this,r;if(ft(e)||!e)r={next:e!=null?e:void 0,error:n!=null?n:void 0,complete:s!=null?s:void 0};else{var a;o&&Bi.useDeprecatedNextContext?(a=Object.create(e),a.unsubscribe=function(){return o.unsubscribe()},r={next:e.next&&qe(e.next,a),error:e.error&&qe(e.error,a),complete:e.complete&&qe(e.complete,a)}):r=e}return o.destination=new lf(r),o}return i}(Yn);function be(t){rf(t)}function hf(t){throw t}var cf={closed:!0,next:Zi,error:hf,complete:Zi},ff=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function uf(t){return t}function df(t){return t.length===0?uf:t.length===1?t[0]:function(e){return t.reduce(function(n,s){return s(n)},e)}}var Xi=function(){function t(i){i&&(this._subscribe=i)}return t.prototype.lift=function(i){var e=new t;return e.source=this,e.operator=i,e},t.prototype.subscribe=function(i,e,n){var s=this,o=pf(i)?i:new pi(i,e,n);return Ie(function(){var r=s,a=r.operator,c=r.source;o.add(a?a.call(o,c):c?s._subscribe(o):s._trySubscribe(o))}),o},t.prototype._trySubscribe=function(i){try{return this._subscribe(i)}catch(e){i.error(e)}},t.prototype.forEach=function(i,e){var n=this;return e=Yi(e),new e(function(s,o){var r=new pi({next:function(a){try{i(a)}catch(c){o(c),r.unsubscribe()}},error:o,complete:s});n.subscribe(r)})},t.prototype._subscribe=function(i){var e;return(e=this.source)===null||e===void 0?void 0:e.subscribe(i)},t.prototype[ff]=function(){return this},t.prototype.pipe=function(){for(var i=[],e=0;e<arguments.length;e++)i[e]=arguments[e];return df(i)(this)},t.prototype.toPromise=function(i){var e=this;return i=Yi(i),new i(function(n,s){var o;e.subscribe(function(r){return o=r},function(r){return s(r)},function(){return n(o)})})},t.create=function(i){return new t(i)},t}();function Yi(t){var i;return(i=t!=null?t:Bi.Promise)!==null&&i!==void 0?i:Promise}function mf(t){return t&&ft(t.next)&&ft(t.error)&&ft(t.complete)}function pf(t){return t&&t instanceof Yn||mf(t)&&Xn(t)}var gf=Hn(function(t){return function(){t(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),Re=function(t){Le(i,t);function i(){var e=t.call(this)||this;return e.closed=!1,e.currentObservers=null,e.observers=[],e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return i.prototype.lift=function(e){var n=new ji(this,this);return n.operator=e,n},i.prototype._throwIfClosed=function(){if(this.closed)throw new gf},i.prototype.next=function(e){var n=this;Ie(function(){var s,o;if(n._throwIfClosed(),!n.isStopped){n.currentObservers||(n.currentObservers=Array.from(n.observers));try{for(var r=ui(n.currentObservers),a=r.next();!a.done;a=r.next()){var c=a.value;c.next(e)}}catch(l){s={error:l}}finally{try{a&&!a.done&&(o=r.return)&&o.call(r)}finally{if(s)throw s.error}}}})},i.prototype.error=function(e){var n=this;Ie(function(){if(n._throwIfClosed(),!n.isStopped){n.hasError=n.isStopped=!0,n.thrownError=e;for(var s=n.observers;s.length;)s.shift().error(e)}})},i.prototype.complete=function(){var e=this;Ie(function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var n=e.observers;n.length;)n.shift().complete()}})},i.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(i.prototype,"observed",{get:function(){var e;return((e=this.observers)===null||e===void 0?void 0:e.length)>0},enumerable:!1,configurable:!0}),i.prototype._trySubscribe=function(e){return this._throwIfClosed(),t.prototype._trySubscribe.call(this,e)},i.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},i.prototype._innerSubscribe=function(e){var n=this,s=this,o=s.hasError,r=s.isStopped,a=s.observers;return o||r?Zn:(this.currentObservers=null,a.push(e),new $e(function(){n.currentObservers=null,di(a,e)}))},i.prototype._checkFinalizedStatuses=function(e){var n=this,s=n.hasError,o=n.thrownError,r=n.isStopped;s?e.error(o):r&&e.complete()},i.prototype.asObservable=function(){var e=new Xi;return e.source=this,e},i.create=function(e,n){return new ji(e,n)},i}(Xi),ji=function(t){Le(i,t);function i(e,n){var s=t.call(this)||this;return s.destination=e,s.source=n,s}return i.prototype.next=function(e){var n,s;(s=(n=this.destination)===null||n===void 0?void 0:n.next)===null||s===void 0||s.call(n,e)},i.prototype.error=function(e){var n,s;(s=(n=this.destination)===null||n===void 0?void 0:n.error)===null||s===void 0||s.call(n,e)},i.prototype.complete=function(){var e,n;(n=(e=this.destination)===null||e===void 0?void 0:e.complete)===null||n===void 0||n.call(e)},i.prototype._subscribe=function(e){var n,s;return(s=(n=this.source)===null||n===void 0?void 0:n.subscribe(e))!==null&&s!==void 0?s:Zn},i}(Re),Y=function(t,i,e,n,s=null,o=null){this.BLEND=1,this.CULL_FACE=2,this.CULL_FRONT=4,this.CULL_BACK=8,this.ENABLE_DEPTH_TEST=16,this.renderShaders=[],this.pickingShader=null,this.isVisible=!0,this.isPickable=!0,this.vertexBuffer=i,this.indexCount=n,this.indexBuffer=s,this.textureCoordinateBuffer=o,this.mode=e,this.glFlags=0,this.id=t,this.colorId=[(t>>0&255)/255,(t>>8&255)/255,(t>>16&255)/255,(t>>24&255)/255],this.modelMatrix=it(),this.scale=[1,1,1],this.position=[0,0,0],this.rotation=[0,0,0],this.rotationRadians=0,this.extentsMin=[],this.extentsMax=[]};Y.generateCrosshairs=function(t,i,e,n,s,o,r=20){let a=this.generateCrosshairsGeometry(t,e,n,s,o,r);return new Y(i,a.vertexBuffer,t.TRIANGLES,a.indexCount,a.indexBuffer)};Y.generateCrosshairsGeometry=function(t,i,e,n,s,o=20){let r=[],a=[],c=z(e[0],i[1],i[2]),l=z(n[0],i[1],i[2]);Y.makeCylinder(r,a,c,l,s,o),c=z(i[0],e[1],i[2]),l=z(i[0],n[1],i[2]),Y.makeCylinder(r,a,c,l,s,o),c=z(i[0],i[1],e[2]),l=z(i[0],i[1],n[2]),Y.makeCylinder(r,a,c,l,s,o);let h=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,h),t.bufferData(t.ARRAY_BUFFER,new Float32Array(r),t.STATIC_DRAW);let p=t.createBuffer();return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,p),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(a),t.STATIC_DRAW),{vertexBuffer:h,indexBuffer:p,indexCount:a.length}};Y.getFirstPerpVector=function(t){let i=z(0,0,0);return t[0]===0?i[0]=1:t[1]===0?i[1]=1:t[2]===0?i[2]=1:(i[0]=t[2],i[1]=t[2],i[2]=-(t[0]+t[1]),Fe(i,i)),i};Y.makeCylinder=function(t,i,e,n,s,o=20){o<3&&(o=3);let r=It();bt(r,n,e),Fe(r,r);let a=Y.getFirstPerpVector(r),c=It();Ks(c,r,a),Fe(c,c);let l=2*o,h=2*o;h+=2*o,l+=2;let p=Math.floor(t.length/3),f=new Uint16Array(h*3),u=new Float32Array(l*3);function v(d,E){u[d*3+0]=E[0],u[d*3+1]=E[1],u[d*3+2]=E[2]}function g(d,E,A,T){f[d*3+0]=E+p,f[d*3+1]=A+p,f[d*3+2]=T+p}let m=2*o,_=m+1;v(m,e),v(_,n);let b=It(),x=It();for(let d=0;d<o;d++){let E=Math.cos(d/o*2*Math.PI),A=Math.sin(d/o*2*Math.PI);b[0]=s*(E*a[0]+A*c[0]),b[1]=s*(E*a[1]+A*c[1]),b[2]=s*(E*a[2]+A*c[2]),Gi(x,e,b),v(d,x),Gi(x,n,b),v(d+o,x);let T=0;d<o-1&&(T=d+1),g(d*2,d,T,d+o),g(d*2+1,T,T+o,d+o),g(o*2+d,d,m,T),g(o*2+d+o,_,d+o,T+o)}i.push(...f),t.push(...u)};var Ue=function(t){this.shader=t,this.uniforms=t.uniforms,this.mvpUniformName="",this.clipPlaneUniformName="",this.rayDirUniformName=""};Ue.prototype.use=function(t){return this.shader.use(t)};function Rt(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Lt={exports:{}},Fi={exports:{}},Oe={exports:{}};(function(t){var i=i||{};i.Utils=i.Utils||{},i.Utils.crcTable=null,i.Utils.GUNZIP_MAGIC_COOKIE1=31,i.Utils.GUNZIP_MAGIC_COOKIE2=139,i.Utils.getStringAt=function(e,n,s){var o="",r,a;for(r=n;r<s;r+=1)a=e.getUint8(r),a!==0&&(o+=String.fromCharCode(a));return o},i.Utils.getByteAt=function(e,n){return e.getInt8(n)},i.Utils.getShortAt=function(e,n,s){return e.getInt16(n,s)},i.Utils.getIntAt=function(e,n,s){return e.getInt32(n,s)},i.Utils.getFloatAt=function(e,n,s){return e.getFloat32(n,s)},i.Utils.getDoubleAt=function(e,n,s){return e.getFloat64(n,s)},i.Utils.getLongAt=function(e,n,s){var o,r=[],a=0;for(o=0;o<8;o+=1)r[o]=i.Utils.getByteAt(e,n+o,s);for(o=r.length-1;o>=0;o--)a=a*256+r[o];return a},i.Utils.toArrayBuffer=function(e){var n,s,o;for(n=new ArrayBuffer(e.length),s=new Uint8Array(n),o=0;o<e.length;o+=1)s[o]=e[o];return n},i.Utils.isString=function(e){return typeof e=="string"||e instanceof String},i.Utils.formatNumber=function(e,n){var s=0;return i.Utils.isString(e)?s=Number(e):s=e,n?s=s.toPrecision(5):s=s.toPrecision(7),parseFloat(s)},i.Utils.makeCRCTable=function(){for(var e,n=[],s=0;s<256;s++){e=s;for(var o=0;o<8;o++)e=e&1?3988292384^e>>>1:e>>>1;n[s]=e}return n},i.Utils.crc32=function(e){for(var n=i.Utils.crcTable||(i.Utils.crcTable=i.Utils.makeCRCTable()),s=-1,o=0;o<e.byteLength;o++)s=s>>>8^n[(s^e.getUint8(o))&255];return(s^-1)>>>0},t.exports&&(t.exports=i.Utils)})(Oe);(function(t){var i=i||{};i.Utils=i.Utils||(typeof Rt!="undefined"?Oe.exports:null),i.NIFTI1=i.NIFTI1||function(){this.littleEndian=!1,this.dim_info=0,this.dims=[],this.intent_p1=0,this.intent_p2=0,this.intent_p3=0,this.intent_code=0,this.datatypeCode=0,this.numBitsPerVoxel=0,this.slice_start=0,this.slice_end=0,this.slice_code=0,this.pixDims=[],this.vox_offset=0,this.scl_slope=1,this.scl_inter=0,this.xyzt_units=0,this.cal_max=0,this.cal_min=0,this.slice_duration=0,this.toffset=0,this.description="",this.aux_file="",this.intent_name="",this.qform_code=0,this.sform_code=0,this.quatern_b=0,this.quatern_c=0,this.quatern_d=0,this.qoffset_x=0,this.qoffset_y=0,this.qoffset_z=0,this.affine=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],this.magic=0,this.isHDR=!1,this.extensionFlag=[0,0,0,0],this.extensionSize=0,this.extensionCode=0},i.NIFTI1.TYPE_NONE=0,i.NIFTI1.TYPE_BINARY=1,i.NIFTI1.TYPE_UINT8=2,i.NIFTI1.TYPE_INT16=4,i.NIFTI1.TYPE_INT32=8,i.NIFTI1.TYPE_FLOAT32=16,i.NIFTI1.TYPE_COMPLEX64=32,i.NIFTI1.TYPE_FLOAT64=64,i.NIFTI1.TYPE_RGB24=128,i.NIFTI1.TYPE_INT8=256,i.NIFTI1.TYPE_UINT16=512,i.NIFTI1.TYPE_UINT32=768,i.NIFTI1.TYPE_INT64=1024,i.NIFTI1.TYPE_UINT64=1280,i.NIFTI1.TYPE_FLOAT128=1536,i.NIFTI1.TYPE_COMPLEX128=1792,i.NIFTI1.TYPE_COMPLEX256=2048,i.NIFTI1.XFORM_UNKNOWN=0,i.NIFTI1.XFORM_SCANNER_ANAT=1,i.NIFTI1.XFORM_ALIGNED_ANAT=2,i.NIFTI1.XFORM_TALAIRACH=3,i.NIFTI1.XFORM_MNI_152=4,i.NIFTI1.SPATIAL_UNITS_MASK=7,i.NIFTI1.TEMPORAL_UNITS_MASK=56,i.NIFTI1.UNITS_UNKNOWN=0,i.NIFTI1.UNITS_METER=1,i.NIFTI1.UNITS_MM=2,i.NIFTI1.UNITS_MICRON=3,i.NIFTI1.UNITS_SEC=8,i.NIFTI1.UNITS_MSEC=16,i.NIFTI1.UNITS_USEC=24,i.NIFTI1.UNITS_HZ=32,i.NIFTI1.UNITS_PPM=40,i.NIFTI1.UNITS_RADS=48,i.NIFTI1.MAGIC_COOKIE=348,i.NIFTI1.STANDARD_HEADER_SIZE=348,i.NIFTI1.MAGIC_NUMBER_LOCATION=344,i.NIFTI1.MAGIC_NUMBER=[110,43,49],i.NIFTI1.MAGIC_NUMBER2=[110,105,49],i.NIFTI1.EXTENSION_HEADER_SIZE=8,i.NIFTI1.prototype.readHeader=function(e){var n=new DataView(e),s=i.Utils.getIntAt(n,0,this.littleEndian),o,r,a,c;if(s!==i.NIFTI1.MAGIC_COOKIE&&(this.littleEndian=!0,s=i.Utils.getIntAt(n,0,this.littleEndian)),s!==i.NIFTI1.MAGIC_COOKIE)throw new Error("This does not appear to be a NIFTI file!");for(this.dim_info=i.Utils.getByteAt(n,39),o=0;o<8;o+=1)c=40+o*2,this.dims[o]=i.Utils.getShortAt(n,c,this.littleEndian);for(this.intent_p1=i.Utils.getFloatAt(n,56,this.littleEndian),this.intent_p2=i.Utils.getFloatAt(n,60,this.littleEndian),this.intent_p3=i.Utils.getFloatAt(n,64,this.littleEndian),this.intent_code=i.Utils.getShortAt(n,68,this.littleEndian),this.datatypeCode=i.Utils.getShortAt(n,70,this.littleEndian),this.numBitsPerVoxel=i.Utils.getShortAt(n,72,this.littleEndian),this.slice_start=i.Utils.getShortAt(n,74,this.littleEndian),o=0;o<8;o+=1)c=76+o*4,this.pixDims[o]=i.Utils.getFloatAt(n,c,this.littleEndian);for(this.vox_offset=i.Utils.getFloatAt(n,108,this.littleEndian),this.scl_slope=i.Utils.getFloatAt(n,112,this.littleEndian),this.scl_inter=i.Utils.getFloatAt(n,116,this.littleEndian),this.slice_end=i.Utils.getShortAt(n,120,this.littleEndian),this.slice_code=i.Utils.getByteAt(n,122),this.xyzt_units=i.Utils.getByteAt(n,123),this.cal_max=i.Utils.getFloatAt(n,124,this.littleEndian),this.cal_min=i.Utils.getFloatAt(n,128,this.littleEndian),this.slice_duration=i.Utils.getFloatAt(n,132,this.littleEndian),this.toffset=i.Utils.getFloatAt(n,136,this.littleEndian),this.description=i.Utils.getStringAt(n,148,228),this.aux_file=i.Utils.getStringAt(n,228,252),this.qform_code=i.Utils.getShortAt(n,252,this.littleEndian),this.sform_code=i.Utils.getShortAt(n,254,this.littleEndian),this.quatern_b=i.Utils.getFloatAt(n,256,this.littleEndian),this.quatern_c=i.Utils.getFloatAt(n,260,this.littleEndian),this.quatern_d=i.Utils.getFloatAt(n,264,this.littleEndian),this.qoffset_x=i.Utils.getFloatAt(n,268,this.littleEndian),this.qoffset_y=i.Utils.getFloatAt(n,272,this.littleEndian),this.qoffset_z=i.Utils.getFloatAt(n,276,this.littleEndian),r=0;r<3;r+=1)for(a=0;a<4;a+=1)c=280+(r*4+a)*4,this.affine[r][a]=i.Utils.getFloatAt(n,c,this.littleEndian);this.affine[3][0]=0,this.affine[3][1]=0,this.affine[3][2]=0,this.affine[3][3]=1,this.intent_name=i.Utils.getStringAt(n,328,344),this.magic=i.Utils.getStringAt(n,344,348),this.isHDR=this.magic===i.NIFTI1.MAGIC_NUMBER2,n.byteLength>i.NIFTI1.MAGIC_COOKIE&&(this.extensionFlag[0]=i.Utils.getByteAt(n,348),this.extensionFlag[1]=i.Utils.getByteAt(n,348+1),this.extensionFlag[2]=i.Utils.getByteAt(n,348+2),this.extensionFlag[3]=i.Utils.getByteAt(n,348+3),this.extensionFlag[0]&&(this.extensionSize=this.getExtensionSize(n),this.extensionCode=this.getExtensionCode(n)))},i.NIFTI1.prototype.toFormattedString=function(){var e=i.Utils.formatNumber,n="";return n+="Dim Info = "+this.dim_info+`
`,n+="Image Dimensions (1-8): "+this.dims[0]+", "+this.dims[1]+", "+this.dims[2]+", "+this.dims[3]+", "+this.dims[4]+", "+this.dims[5]+", "+this.dims[6]+", "+this.dims[7]+`
`,n+="Intent Parameters (1-3): "+this.intent_p1+", "+this.intent_p2+", "+this.intent_p3+`
`,n+="Intent Code = "+this.intent_code+`
`,n+="Datatype = "+this.datatypeCode+" ("+this.getDatatypeCodeString(this.datatypeCode)+`)
`,n+="Bits Per Voxel = "+this.numBitsPerVoxel+`
`,n+="Slice Start = "+this.slice_start+`
`,n+="Voxel Dimensions (1-8): "+e(this.pixDims[0])+", "+e(this.pixDims[1])+", "+e(this.pixDims[2])+", "+e(this.pixDims[3])+", "+e(this.pixDims[4])+", "+e(this.pixDims[5])+", "+e(this.pixDims[6])+", "+e(this.pixDims[7])+`
`,n+="Image Offset = "+this.vox_offset+`
`,n+="Data Scale:  Slope = "+e(this.scl_slope)+"  Intercept = "+e(this.scl_inter)+`
`,n+="Slice End = "+this.slice_end+`
`,n+="Slice Code = "+this.slice_code+`
`,n+="Units Code = "+this.xyzt_units+" ("+this.getUnitsCodeString(i.NIFTI1.SPATIAL_UNITS_MASK&this.xyzt_units)+", "+this.getUnitsCodeString(i.NIFTI1.TEMPORAL_UNITS_MASK&this.xyzt_units)+`)
`,n+="Display Range:  Max = "+e(this.cal_max)+"  Min = "+e(this.cal_min)+`
`,n+="Slice Duration = "+this.slice_duration+`
`,n+="Time Axis Shift = "+this.toffset+`
`,n+='Description: "'+this.description+`"
`,n+='Auxiliary File: "'+this.aux_file+`"
`,n+="Q-Form Code = "+this.qform_code+" ("+this.getTransformCodeString(this.qform_code)+`)
`,n+="S-Form Code = "+this.sform_code+" ("+this.getTransformCodeString(this.sform_code)+`)
`,n+="Quaternion Parameters:  b = "+e(this.quatern_b)+"  c = "+e(this.quatern_c)+"  d = "+e(this.quatern_d)+`
`,n+="Quaternion Offsets:  x = "+this.qoffset_x+"  y = "+this.qoffset_y+"  z = "+this.qoffset_z+`
`,n+="S-Form Parameters X: "+e(this.affine[0][0])+", "+e(this.affine[0][1])+", "+e(this.affine[0][2])+", "+e(this.affine[0][3])+`
`,n+="S-Form Parameters Y: "+e(this.affine[1][0])+", "+e(this.affine[1][1])+", "+e(this.affine[1][2])+", "+e(this.affine[1][3])+`
`,n+="S-Form Parameters Z: "+e(this.affine[2][0])+", "+e(this.affine[2][1])+", "+e(this.affine[2][2])+", "+e(this.affine[2][3])+`
`,n+='Intent Name: "'+this.intent_name+`"
`,this.extensionFlag[0]&&(n+="Extension: Size = "+this.extensionSize+"  Code = "+this.extensionCode+`
`),n},i.NIFTI1.prototype.getDatatypeCodeString=function(e){return e===i.NIFTI1.TYPE_UINT8?"1-Byte Unsigned Integer":e===i.NIFTI1.TYPE_INT16?"2-Byte Signed Integer":e===i.NIFTI1.TYPE_INT32?"4-Byte Signed Integer":e===i.NIFTI1.TYPE_FLOAT32?"4-Byte Float":e===i.NIFTI1.TYPE_FLOAT64?"8-Byte Float":e===i.NIFTI1.TYPE_RGB24?"RGB":e===i.NIFTI1.TYPE_INT8?"1-Byte Signed Integer":e===i.NIFTI1.TYPE_UINT16?"2-Byte Unsigned Integer":e===i.NIFTI1.TYPE_UINT32?"4-Byte Unsigned Integer":e===i.NIFTI1.TYPE_INT64?"8-Byte Signed Integer":e===i.NIFTI1.TYPE_UINT64?"8-Byte Unsigned Integer":"Unknown"},i.NIFTI1.prototype.getTransformCodeString=function(e){return e===i.NIFTI1.XFORM_SCANNER_ANAT?"Scanner":e===i.NIFTI1.XFORM_ALIGNED_ANAT?"Aligned":e===i.NIFTI1.XFORM_TALAIRACH?"Talairach":e===i.NIFTI1.XFORM_MNI_152?"MNI":"Unknown"},i.NIFTI1.prototype.getUnitsCodeString=function(e){return e===i.NIFTI1.UNITS_METER?"Meters":e===i.NIFTI1.UNITS_MM?"Millimeters":e===i.NIFTI1.UNITS_MICRON?"Microns":e===i.NIFTI1.UNITS_SEC?"Seconds":e===i.NIFTI1.UNITS_MSEC?"Milliseconds":e===i.NIFTI1.UNITS_USEC?"Microseconds":e===i.NIFTI1.UNITS_HZ?"Hz":e===i.NIFTI1.UNITS_PPM?"PPM":e===i.NIFTI1.UNITS_RADS?"Rads":"Unknown"},i.NIFTI1.prototype.getQformMat=function(){return this.convertNiftiQFormToNiftiSForm(this.quatern_b,this.quatern_c,this.quatern_d,this.qoffset_x,this.qoffset_y,this.qoffset_z,this.pixDims[1],this.pixDims[2],this.pixDims[3],this.pixDims[0])},i.NIFTI1.prototype.convertNiftiQFormToNiftiSForm=function(e,n,s,o,r,a,c,l,h,p){var f=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],u,v=e,g=n,m=s,_,b,x;return f[3][0]=f[3][1]=f[3][2]=0,f[3][3]=1,u=1-(v*v+g*g+m*m),u<1e-7?(u=1/Math.sqrt(v*v+g*g+m*m),v*=u,g*=u,m*=u,u=0):u=Math.sqrt(u),_=c>0?c:1,b=l>0?l:1,x=h>0?h:1,p<0&&(x=-x),f[0][0]=(u*u+v*v-g*g-m*m)*_,f[0][1]=2*(v*g-u*m)*b,f[0][2]=2*(v*m+u*g)*x,f[1][0]=2*(v*g+u*m)*_,f[1][1]=(u*u+g*g-v*v-m*m)*b,f[1][2]=2*(g*m-u*v)*x,f[2][0]=2*(v*m-u*g)*_,f[2][1]=2*(g*m+u*v)*b,f[2][2]=(u*u+m*m-g*g-v*v)*x,f[0][3]=o,f[1][3]=r,f[2][3]=a,f},i.NIFTI1.prototype.convertNiftiSFormToNEMA=function(e){var n,s,o,r,a,c,l,h,p,f,u,v,g,m,_,b,x,d,E,A,T,I,R,S,w,k,U,D,V,ut,dt,mt,pt,gt;if(_=0,U=[[0,0,0],[0,0,0],[0,0,0]],D=[[0,0,0],[0,0,0],[0,0,0]],n=e[0][0],s=e[0][1],o=e[0][2],r=e[1][0],a=e[1][1],c=e[1][2],l=e[2][0],h=e[2][1],p=e[2][2],f=Math.sqrt(n*n+r*r+l*l),f===0||(n/=f,r/=f,l/=f,f=Math.sqrt(s*s+a*a+h*h),f===0))return null;if(s/=f,a/=f,h/=f,f=n*s+r*a+l*h,Math.abs(f)>1e-4){if(s-=f*n,a-=f*r,h-=f*l,f=Math.sqrt(s*s+a*a+h*h),f===0)return null;s/=f,a/=f,h/=f}if(f=Math.sqrt(o*o+c*c+p*p),f===0?(o=r*h-l*a,c=l*s-h*n,p=n*a-r*s):(o/=f,c/=f,p/=f),f=n*o+r*c+l*p,Math.abs(f)>1e-4){if(o-=f*n,c-=f*r,p-=f*l,f=Math.sqrt(o*o+c*c+p*p),f===0)return null;o/=f,c/=f,p/=f}if(f=s*o+a*c+h*p,Math.abs(f)>1e-4){if(o-=f*s,c-=f*a,p-=f*h,f=Math.sqrt(o*o+c*c+p*p),f===0)return null;o/=f,c/=f,p/=f}if(U[0][0]=n,U[0][1]=s,U[0][2]=o,U[1][0]=r,U[1][1]=a,U[1][2]=c,U[2][0]=l,U[2][1]=h,U[2][2]=p,u=this.nifti_mat33_determ(U),u===0)return null;for(k=-666,E=I=R=S=1,A=2,T=3,g=1;g<=3;g+=1)for(m=1;m<=3;m+=1)if(g!==m){for(_=1;_<=3;_+=1)if(!(g===_||m===_))for(D[0][0]=D[0][1]=D[0][2]=D[1][0]=D[1][1]=D[1][2]=D[2][0]=D[2][1]=D[2][2]=0,b=-1;b<=1;b+=2)for(x=-1;x<=1;x+=2)for(d=-1;d<=1;d+=2)D[0][g-1]=b,D[1][m-1]=x,D[2][_-1]=d,v=this.nifti_mat33_determ(D),v*u>0&&(w=this.nifti_mat33_mul(D,U),f=w[0][0]+w[1][1]+w[2][2],f>k&&(k=f,E=g,A=m,T=_,I=b,R=x,S=d))}switch(V=ut=dt=mt=pt=gt=0,E*I){case 1:V="X",mt="+";break;case-1:V="X",mt="-";break;case 2:V="Y",mt="+";break;case-2:V="Y",mt="-";break;case 3:V="Z",mt="+";break;case-3:V="Z",mt="-";break}switch(A*R){case 1:ut="X",pt="+";break;case-1:ut="X",pt="-";break;case 2:ut="Y",pt="+";break;case-2:ut="Y",pt="-";break;case 3:ut="Z",pt="+";break;case-3:ut="Z",pt="-";break}switch(T*S){case 1:dt="X",gt="+";break;case-1:dt="X",gt="-";break;case 2:dt="Y",gt="+";break;case-2:dt="Y",gt="-";break;case 3:dt="Z",gt="+";break;case-3:dt="Z",gt="-";break}return V+ut+dt+mt+pt+gt},i.NIFTI1.prototype.nifti_mat33_mul=function(e,n){var s=[[0,0,0],[0,0,0],[0,0,0]],o,r;for(o=0;o<3;o+=1)for(r=0;r<3;r+=1)s[o][r]=e[o][0]*n[0][r]+e[o][1]*n[1][r]+e[o][2]*n[2][r];return s},i.NIFTI1.prototype.nifti_mat33_determ=function(e){var n,s,o,r,a,c,l,h,p;return n=e[0][0],s=e[0][1],o=e[0][2],r=e[1][0],a=e[1][1],c=e[1][2],l=e[2][0],h=e[2][1],p=e[2][2],n*a*p-n*h*c-r*s*p+r*h*o+l*s*c-l*a*o},i.NIFTI1.prototype.getExtensionLocation=function(){return i.NIFTI1.MAGIC_COOKIE+4},i.NIFTI1.prototype.getExtensionSize=function(e){return i.Utils.getIntAt(e,this.getExtensionLocation(),this.littleEndian)},i.NIFTI1.prototype.getExtensionCode=function(e){return i.Utils.getIntAt(e,this.getExtensionLocation()+4,this.littleEndian)},t.exports&&(t.exports=i.NIFTI1)})(Fi);var jn={exports:{}};(function(t){var i=i||{};i.Utils=i.Utils||(typeof Rt!="undefined"?Oe.exports:null),i.NIFTI1=i.NIFTI1||(typeof Rt!="undefined"?Fi.exports:null),i.NIFTI2=i.NIFTI2||function(){this.littleEndian=!1,this.dim_info=0,this.dims=[],this.intent_p1=0,this.intent_p2=0,this.intent_p3=0,this.intent_code=0,this.datatypeCode=0,this.numBitsPerVoxel=0,this.slice_start=0,this.slice_end=0,this.slice_code=0,this.pixDims=[],this.vox_offset=0,this.scl_slope=1,this.scl_inter=0,this.xyzt_units=0,this.cal_max=0,this.cal_min=0,this.slice_duration=0,this.toffset=0,this.description="",this.aux_file="",this.intent_name="",this.qform_code=0,this.sform_code=0,this.quatern_b=0,this.quatern_c=0,this.quatern_d=0,this.qoffset_x=0,this.qoffset_y=0,this.qoffset_z=0,this.affine=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],this.magic=0,this.extensionFlag=[0,0,0,0]},i.NIFTI2.MAGIC_COOKIE=540,i.NIFTI2.MAGIC_NUMBER_LOCATION=4,i.NIFTI2.MAGIC_NUMBER=[110,43,50,0,13,10,26,10],i.NIFTI2.prototype.readHeader=function(e){var n=new DataView(e),s=i.Utils.getIntAt(n,0,this.littleEndian),o,r,a,c;if(s!==i.NIFTI2.MAGIC_COOKIE&&(this.littleEndian=!0,s=i.Utils.getIntAt(n,0,this.littleEndian)),s!==i.NIFTI2.MAGIC_COOKIE)throw new Error("This does not appear to be a NIFTI file!");for(this.datatypeCode=i.Utils.getShortAt(n,12,this.littleEndian),this.numBitsPerVoxel=i.Utils.getShortAt(n,14,this.littleEndian),o=0;o<8;o+=1)c=16+o*8,this.dims[o]=i.Utils.getLongAt(n,c,this.littleEndian);for(this.intent_p1=i.Utils.getDoubleAt(n,80,this.littleEndian),this.intent_p2=i.Utils.getDoubleAt(n,88,this.littleEndian),this.intent_p3=i.Utils.getDoubleAt(n,96,this.littleEndian),o=0;o<8;o+=1)c=104+o*8,this.pixDims[o]=i.Utils.getDoubleAt(n,c,this.littleEndian);for(this.vox_offset=i.Utils.getLongAt(n,168,this.littleEndian),this.scl_slope=i.Utils.getDoubleAt(n,176,this.littleEndian),this.scl_inter=i.Utils.getDoubleAt(n,184,this.littleEndian),this.cal_max=i.Utils.getDoubleAt(n,192,this.littleEndian),this.cal_min=i.Utils.getDoubleAt(n,200,this.littleEndian),this.slice_duration=i.Utils.getDoubleAt(n,208,this.littleEndian),this.toffset=i.Utils.getDoubleAt(n,216,this.littleEndian),this.slice_start=i.Utils.getLongAt(n,224,this.littleEndian),this.slice_end=i.Utils.getLongAt(n,232,this.littleEndian),this.description=i.Utils.getStringAt(n,240,240+80),this.aux_file=i.Utils.getStringAt(n,320,320+24),this.qform_code=i.Utils.getIntAt(n,344,this.littleEndian),this.sform_code=i.Utils.getIntAt(n,348,this.littleEndian),this.quatern_b=i.Utils.getDoubleAt(n,352,this.littleEndian),this.quatern_c=i.Utils.getDoubleAt(n,360,this.littleEndian),this.quatern_d=i.Utils.getDoubleAt(n,368,this.littleEndian),this.qoffset_x=i.Utils.getDoubleAt(n,376,this.littleEndian),this.qoffset_y=i.Utils.getDoubleAt(n,384,this.littleEndian),this.qoffset_z=i.Utils.getDoubleAt(n,392,this.littleEndian),r=0;r<3;r+=1)for(a=0;a<4;a+=1)c=400+(r*4+a)*8,this.affine[r][a]=i.Utils.getDoubleAt(n,c,this.littleEndian);this.affine[3][0]=0,this.affine[3][1]=0,this.affine[3][2]=0,this.affine[3][3]=1,this.slice_code=i.Utils.getIntAt(n,496,this.littleEndian),this.xyzt_units=i.Utils.getIntAt(n,500,this.littleEndian),this.intent_code=i.Utils.getIntAt(n,504,this.littleEndian),this.intent_name=i.Utils.getStringAt(n,508,508+16),this.dim_info=i.Utils.getByteAt(n,524),n.byteLength>i.NIFTI2.MAGIC_COOKIE&&(this.extensionFlag[0]=i.Utils.getByteAt(n,540),this.extensionFlag[1]=i.Utils.getByteAt(n,540+1),this.extensionFlag[2]=i.Utils.getByteAt(n,540+2),this.extensionFlag[3]=i.Utils.getByteAt(n,540+3),this.extensionFlag[0]&&(this.extensionSize=this.getExtensionSize(n),this.extensionCode=this.getExtensionCode(n)))},i.NIFTI2.prototype.toFormattedString=function(){var e=i.Utils.formatNumber,n="";return n+="Datatype = "+ +this.datatypeCode+" ("+this.getDatatypeCodeString(this.datatypeCode)+`)
`,n+="Bits Per Voxel =  = "+this.numBitsPerVoxel+`
`,n+="Image Dimensions (1-8): "+this.dims[0]+", "+this.dims[1]+", "+this.dims[2]+", "+this.dims[3]+", "+this.dims[4]+", "+this.dims[5]+", "+this.dims[6]+", "+this.dims[7]+`
`,n+="Intent Parameters (1-3): "+this.intent_p1+", "+this.intent_p2+", "+this.intent_p3+`
`,n+="Voxel Dimensions (1-8): "+e(this.pixDims[0])+", "+e(this.pixDims[1])+", "+e(this.pixDims[2])+", "+e(this.pixDims[3])+", "+e(this.pixDims[4])+", "+e(this.pixDims[5])+", "+e(this.pixDims[6])+", "+e(this.pixDims[7])+`
`,n+="Image Offset = "+this.vox_offset+`
`,n+="Data Scale:  Slope = "+e(this.scl_slope)+"  Intercept = "+e(this.scl_inter)+`
`,n+="Display Range:  Max = "+e(this.cal_max)+"  Min = "+e(this.cal_min)+`
`,n+="Slice Duration = "+this.slice_duration+`
`,n+="Time Axis Shift = "+this.toffset+`
`,n+="Slice Start = "+this.slice_start+`
`,n+="Slice End = "+this.slice_end+`
`,n+='Description: "'+this.description+`"
`,n+='Auxiliary File: "'+this.aux_file+`"
`,n+="Q-Form Code = "+this.qform_code+" ("+this.getTransformCodeString(this.qform_code)+`)
`,n+="S-Form Code = "+this.sform_code+" ("+this.getTransformCodeString(this.sform_code)+`)
`,n+="Quaternion Parameters:  b = "+e(this.quatern_b)+"  c = "+e(this.quatern_c)+"  d = "+e(this.quatern_d)+`
`,n+="Quaternion Offsets:  x = "+this.qoffset_x+"  y = "+this.qoffset_y+"  z = "+this.qoffset_z+`
`,n+="S-Form Parameters X: "+e(this.affine[0][0])+", "+e(this.affine[0][1])+", "+e(this.affine[0][2])+", "+e(this.affine[0][3])+`
`,n+="S-Form Parameters Y: "+e(this.affine[1][0])+", "+e(this.affine[1][1])+", "+e(this.affine[1][2])+", "+e(this.affine[1][3])+`
`,n+="S-Form Parameters Z: "+e(this.affine[2][0])+", "+e(this.affine[2][1])+", "+e(this.affine[2][2])+", "+e(this.affine[2][3])+`
`,n+="Slice Code = "+this.slice_code+`
`,n+="Units Code = "+this.xyzt_units+" ("+this.getUnitsCodeString(i.NIFTI1.SPATIAL_UNITS_MASK&this.xyzt_units)+", "+this.getUnitsCodeString(i.NIFTI1.TEMPORAL_UNITS_MASK&this.xyzt_units)+`)
`,n+="Intent Code = "+this.intent_code+`
`,n+='Intent Name: "'+this.intent_name+`"
`,n+="Dim Info = "+this.dim_info+`
`,n},i.NIFTI2.prototype.getExtensionLocation=function(){return i.NIFTI2.MAGIC_COOKIE+4},i.NIFTI2.prototype.getExtensionSize=i.NIFTI1.prototype.getExtensionSize,i.NIFTI2.prototype.getExtensionCode=i.NIFTI1.prototype.getExtensionCode,i.NIFTI2.prototype.getDatatypeCodeString=i.NIFTI1.prototype.getDatatypeCodeString,i.NIFTI2.prototype.getTransformCodeString=i.NIFTI1.prototype.getTransformCodeString,i.NIFTI2.prototype.getUnitsCodeString=i.NIFTI1.prototype.getUnitsCodeString,i.NIFTI2.prototype.getQformMat=i.NIFTI1.prototype.getQformMat,i.NIFTI2.prototype.convertNiftiQFormToNiftiSForm=i.NIFTI1.prototype.convertNiftiQFormToNiftiSForm,i.NIFTI2.prototype.convertNiftiSFormToNEMA=i.NIFTI1.prototype.convertNiftiSFormToNEMA,i.NIFTI2.prototype.nifti_mat33_mul=i.NIFTI1.prototype.nifti_mat33_mul,i.NIFTI2.prototype.nifti_mat33_determ=i.NIFTI1.prototype.nifti_mat33_determ,t.exports&&(t.exports=i.NIFTI2)})(jn);var ot={},Xt={},rt={},Yt={};const _f=4,qi=0,Wi=1,vf=2;function jt(t){let i=t.length;for(;--i>=0;)t[i]=0}const xf=0,qn=1,bf=2,yf=3,Tf=258,Ni=29,de=256,re=de+1+Ni,Ot=30,Ci=19,Wn=2*re+1,Dt=15,We=16,Ef=7,Ui=256,Kn=16,Qn=17,Jn=18,gi=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),De=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),Af=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),ts=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Sf=512,lt=new Array((re+2)*2);jt(lt);const ne=new Array(Ot*2);jt(ne);const ae=new Array(Sf);jt(ae);const le=new Array(Tf-yf+1);jt(le);const ki=new Array(Ni);jt(ki);const ke=new Array(Ot);jt(ke);function Ke(t,i,e,n,s){this.static_tree=t,this.extra_bits=i,this.extra_base=e,this.elems=n,this.max_length=s,this.has_stree=t&&t.length}let es,is,ns;function Qe(t,i){this.dyn_tree=t,this.max_code=0,this.stat_desc=i}const ss=t=>t<256?ae[t]:ae[256+(t>>>7)],he=(t,i)=>{t.pending_buf[t.pending++]=i&255,t.pending_buf[t.pending++]=i>>>8&255},G=(t,i,e)=>{t.bi_valid>We-e?(t.bi_buf|=i<<t.bi_valid&65535,he(t,t.bi_buf),t.bi_buf=i>>We-t.bi_valid,t.bi_valid+=e-We):(t.bi_buf|=i<<t.bi_valid&65535,t.bi_valid+=e)},et=(t,i,e)=>{G(t,e[i*2],e[i*2+1])},os=(t,i)=>{let e=0;do e|=t&1,t>>>=1,e<<=1;while(--i>0);return e>>>1},wf=t=>{t.bi_valid===16?(he(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=t.bi_buf&255,t.bi_buf>>=8,t.bi_valid-=8)},If=(t,i)=>{const e=i.dyn_tree,n=i.max_code,s=i.stat_desc.static_tree,o=i.stat_desc.has_stree,r=i.stat_desc.extra_bits,a=i.stat_desc.extra_base,c=i.stat_desc.max_length;let l,h,p,f,u,v,g=0;for(f=0;f<=Dt;f++)t.bl_count[f]=0;for(e[t.heap[t.heap_max]*2+1]=0,l=t.heap_max+1;l<Wn;l++)h=t.heap[l],f=e[e[h*2+1]*2+1]+1,f>c&&(f=c,g++),e[h*2+1]=f,!(h>n)&&(t.bl_count[f]++,u=0,h>=a&&(u=r[h-a]),v=e[h*2],t.opt_len+=v*(f+u),o&&(t.static_len+=v*(s[h*2+1]+u)));if(g!==0){do{for(f=c-1;t.bl_count[f]===0;)f--;t.bl_count[f]--,t.bl_count[f+1]+=2,t.bl_count[c]--,g-=2}while(g>0);for(f=c;f!==0;f--)for(h=t.bl_count[f];h!==0;)p=t.heap[--l],!(p>n)&&(e[p*2+1]!==f&&(t.opt_len+=(f-e[p*2+1])*e[p*2],e[p*2+1]=f),h--)}},rs=(t,i,e)=>{const n=new Array(Dt+1);let s=0,o,r;for(o=1;o<=Dt;o++)s=s+e[o-1]<<1,n[o]=s;for(r=0;r<=i;r++){let a=t[r*2+1];a!==0&&(t[r*2]=os(n[a]++,a))}},Rf=()=>{let t,i,e,n,s;const o=new Array(Dt+1);for(e=0,n=0;n<Ni-1;n++)for(ki[n]=e,t=0;t<1<<gi[n];t++)le[e++]=n;for(le[e-1]=n,s=0,n=0;n<16;n++)for(ke[n]=s,t=0;t<1<<De[n];t++)ae[s++]=n;for(s>>=7;n<Ot;n++)for(ke[n]=s<<7,t=0;t<1<<De[n]-7;t++)ae[256+s++]=n;for(i=0;i<=Dt;i++)o[i]=0;for(t=0;t<=143;)lt[t*2+1]=8,t++,o[8]++;for(;t<=255;)lt[t*2+1]=9,t++,o[9]++;for(;t<=279;)lt[t*2+1]=7,t++,o[7]++;for(;t<=287;)lt[t*2+1]=8,t++,o[8]++;for(rs(lt,re+1,o),t=0;t<Ot;t++)ne[t*2+1]=5,ne[t*2]=os(t,5);es=new Ke(lt,gi,de+1,re,Dt),is=new Ke(ne,De,0,Ot,Dt),ns=new Ke(new Array(0),Af,0,Ci,Ef)},as=t=>{let i;for(i=0;i<re;i++)t.dyn_ltree[i*2]=0;for(i=0;i<Ot;i++)t.dyn_dtree[i*2]=0;for(i=0;i<Ci;i++)t.bl_tree[i*2]=0;t.dyn_ltree[Ui*2]=1,t.opt_len=t.static_len=0,t.sym_next=t.matches=0},ls=t=>{t.bi_valid>8?he(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0},Ki=(t,i,e,n)=>{const s=i*2,o=e*2;return t[s]<t[o]||t[s]===t[o]&&n[i]<=n[e]},Je=(t,i,e)=>{const n=t.heap[e];let s=e<<1;for(;s<=t.heap_len&&(s<t.heap_len&&Ki(i,t.heap[s+1],t.heap[s],t.depth)&&s++,!Ki(i,n,t.heap[s],t.depth));)t.heap[e]=t.heap[s],e=s,s<<=1;t.heap[e]=n},Qi=(t,i,e)=>{let n,s,o=0,r,a;if(t.sym_next!==0)do n=t.pending_buf[t.sym_buf+o++]&255,n+=(t.pending_buf[t.sym_buf+o++]&255)<<8,s=t.pending_buf[t.sym_buf+o++],n===0?et(t,s,i):(r=le[s],et(t,r+de+1,i),a=gi[r],a!==0&&(s-=ki[r],G(t,s,a)),n--,r=ss(n),et(t,r,e),a=De[r],a!==0&&(n-=ke[r],G(t,n,a)));while(o<t.sym_next);et(t,Ui,i)},_i=(t,i)=>{const e=i.dyn_tree,n=i.stat_desc.static_tree,s=i.stat_desc.has_stree,o=i.stat_desc.elems;let r,a,c=-1,l;for(t.heap_len=0,t.heap_max=Wn,r=0;r<o;r++)e[r*2]!==0?(t.heap[++t.heap_len]=c=r,t.depth[r]=0):e[r*2+1]=0;for(;t.heap_len<2;)l=t.heap[++t.heap_len]=c<2?++c:0,e[l*2]=1,t.depth[l]=0,t.opt_len--,s&&(t.static_len-=n[l*2+1]);for(i.max_code=c,r=t.heap_len>>1;r>=1;r--)Je(t,e,r);l=o;do r=t.heap[1],t.heap[1]=t.heap[t.heap_len--],Je(t,e,1),a=t.heap[1],t.heap[--t.heap_max]=r,t.heap[--t.heap_max]=a,e[l*2]=e[r*2]+e[a*2],t.depth[l]=(t.depth[r]>=t.depth[a]?t.depth[r]:t.depth[a])+1,e[r*2+1]=e[a*2+1]=l,t.heap[1]=l++,Je(t,e,1);while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],If(t,i),rs(e,c,t.bl_count)},Ji=(t,i,e)=>{let n,s=-1,o,r=i[0*2+1],a=0,c=7,l=4;for(r===0&&(c=138,l=3),i[(e+1)*2+1]=65535,n=0;n<=e;n++)o=r,r=i[(n+1)*2+1],!(++a<c&&o===r)&&(a<l?t.bl_tree[o*2]+=a:o!==0?(o!==s&&t.bl_tree[o*2]++,t.bl_tree[Kn*2]++):a<=10?t.bl_tree[Qn*2]++:t.bl_tree[Jn*2]++,a=0,s=o,r===0?(c=138,l=3):o===r?(c=6,l=3):(c=7,l=4))},tn=(t,i,e)=>{let n,s=-1,o,r=i[0*2+1],a=0,c=7,l=4;for(r===0&&(c=138,l=3),n=0;n<=e;n++)if(o=r,r=i[(n+1)*2+1],!(++a<c&&o===r)){if(a<l)do et(t,o,t.bl_tree);while(--a!==0);else o!==0?(o!==s&&(et(t,o,t.bl_tree),a--),et(t,Kn,t.bl_tree),G(t,a-3,2)):a<=10?(et(t,Qn,t.bl_tree),G(t,a-3,3)):(et(t,Jn,t.bl_tree),G(t,a-11,7));a=0,s=o,r===0?(c=138,l=3):o===r?(c=6,l=3):(c=7,l=4)}},Df=t=>{let i;for(Ji(t,t.dyn_ltree,t.l_desc.max_code),Ji(t,t.dyn_dtree,t.d_desc.max_code),_i(t,t.bl_desc),i=Ci-1;i>=3&&t.bl_tree[ts[i]*2+1]===0;i--);return t.opt_len+=3*(i+1)+5+5+4,i},Bf=(t,i,e,n)=>{let s;for(G(t,i-257,5),G(t,e-1,5),G(t,n-4,4),s=0;s<n;s++)G(t,t.bl_tree[ts[s]*2+1],3);tn(t,t.dyn_ltree,i-1),tn(t,t.dyn_dtree,e-1)},Ff=t=>{let i=4093624447,e;for(e=0;e<=31;e++,i>>>=1)if(i&1&&t.dyn_ltree[e*2]!==0)return qi;if(t.dyn_ltree[9*2]!==0||t.dyn_ltree[10*2]!==0||t.dyn_ltree[13*2]!==0)return Wi;for(e=32;e<de;e++)if(t.dyn_ltree[e*2]!==0)return Wi;return qi};let en=!1;const Nf=t=>{en||(Rf(),en=!0),t.l_desc=new Qe(t.dyn_ltree,es),t.d_desc=new Qe(t.dyn_dtree,is),t.bl_desc=new Qe(t.bl_tree,ns),t.bi_buf=0,t.bi_valid=0,as(t)},hs=(t,i,e,n)=>{G(t,(xf<<1)+(n?1:0),3),ls(t),he(t,e),he(t,~e),e&&t.pending_buf.set(t.window.subarray(i,i+e),t.pending),t.pending+=e},Cf=t=>{G(t,qn<<1,3),et(t,Ui,lt),wf(t)},Uf=(t,i,e,n)=>{let s,o,r=0;t.level>0?(t.strm.data_type===vf&&(t.strm.data_type=Ff(t)),_i(t,t.l_desc),_i(t,t.d_desc),r=Df(t),s=t.opt_len+3+7>>>3,o=t.static_len+3+7>>>3,o<=s&&(s=o)):s=o=e+5,e+4<=s&&i!==-1?hs(t,i,e,n):t.strategy===_f||o===s?(G(t,(qn<<1)+(n?1:0),3),Qi(t,lt,ne)):(G(t,(bf<<1)+(n?1:0),3),Bf(t,t.l_desc.max_code+1,t.d_desc.max_code+1,r+1),Qi(t,t.dyn_ltree,t.dyn_dtree)),as(t),n&&ls(t)},kf=(t,i,e)=>(t.pending_buf[t.sym_buf+t.sym_next++]=i,t.pending_buf[t.sym_buf+t.sym_next++]=i>>8,t.pending_buf[t.sym_buf+t.sym_next++]=e,i===0?t.dyn_ltree[e*2]++:(t.matches++,i--,t.dyn_ltree[(le[e]+de+1)*2]++,t.dyn_dtree[ss(i)*2]++),t.sym_next===t.sym_end);Yt._tr_init=Nf;Yt._tr_stored_block=hs;Yt._tr_flush_block=Uf;Yt._tr_tally=kf;Yt._tr_align=Cf;const Pf=(t,i,e,n)=>{let s=t&65535|0,o=t>>>16&65535|0,r=0;for(;e!==0;){r=e>2e3?2e3:e,e-=r;do s=s+i[n++]|0,o=o+s|0;while(--r);s%=65521,o%=65521}return s|o<<16|0};var cs=Pf;const Mf=()=>{let t,i=[];for(var e=0;e<256;e++){t=e;for(var n=0;n<8;n++)t=t&1?3988292384^t>>>1:t>>>1;i[e]=t}return i},Lf=new Uint32Array(Mf()),$f=(t,i,e,n)=>{const s=Lf,o=n+e;t^=-1;for(let r=n;r<o;r++)t=t>>>8^s[(t^i[r])&255];return t^-1};var fs=$f,Pi={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Ut={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:Of,_tr_stored_block:vi,_tr_flush_block:zf,_tr_tally:Tt,_tr_align:Gf}=Yt,us=cs,_t=fs,Vf=Pi,{Z_NO_FLUSH:Et,Z_PARTIAL_FLUSH:Hf,Z_FULL_FLUSH:Zf,Z_FINISH:X,Z_BLOCK:nn,Z_OK:L,Z_STREAM_END:sn,Z_STREAM_ERROR:nt,Z_DATA_ERROR:Xf,Z_BUF_ERROR:ti,Z_DEFAULT_COMPRESSION:Yf,Z_FILTERED:jf,Z_HUFFMAN_ONLY:ye,Z_RLE:qf,Z_FIXED:Wf,Z_DEFAULT_STRATEGY:Kf,Z_UNKNOWN:Qf,Z_DEFLATED:ze}=Ut,Jf=9,t2=15,e2=8,i2=29,n2=256,xi=n2+1+i2,s2=30,o2=19,r2=2*xi+1,a2=15,B=3,xt=258,st=xt+B+1,l2=32,Vt=42,Mi=57,bi=69,yi=73,Ti=91,Ei=103,Bt=113,ee=666,O=1,qt=2,Nt=3,Wt=4,h2=3,Ft=(t,i)=>(t.msg=Vf[i],i),on=t=>t*2-(t>4?9:0),vt=t=>{let i=t.length;for(;--i>=0;)t[i]=0},c2=t=>{let i,e,n,s=t.w_size;i=t.hash_size,n=i;do e=t.head[--n],t.head[n]=e>=s?e-s:0;while(--i);i=s,n=i;do e=t.prev[--n],t.prev[n]=e>=s?e-s:0;while(--i)};let f2=(t,i,e)=>(i<<t.hash_shift^e)&t.hash_mask,At=f2;const H=t=>{const i=t.state;let e=i.pending;e>t.avail_out&&(e=t.avail_out),e!==0&&(t.output.set(i.pending_buf.subarray(i.pending_out,i.pending_out+e),t.next_out),t.next_out+=e,i.pending_out+=e,t.total_out+=e,t.avail_out-=e,i.pending-=e,i.pending===0&&(i.pending_out=0))},Z=(t,i)=>{zf(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,i),t.block_start=t.strstart,H(t.strm)},F=(t,i)=>{t.pending_buf[t.pending++]=i},Jt=(t,i)=>{t.pending_buf[t.pending++]=i>>>8&255,t.pending_buf[t.pending++]=i&255},Ai=(t,i,e,n)=>{let s=t.avail_in;return s>n&&(s=n),s===0?0:(t.avail_in-=s,i.set(t.input.subarray(t.next_in,t.next_in+s),e),t.state.wrap===1?t.adler=us(t.adler,i,s,e):t.state.wrap===2&&(t.adler=_t(t.adler,i,s,e)),t.next_in+=s,t.total_in+=s,s)},ds=(t,i)=>{let e=t.max_chain_length,n=t.strstart,s,o,r=t.prev_length,a=t.nice_match;const c=t.strstart>t.w_size-st?t.strstart-(t.w_size-st):0,l=t.window,h=t.w_mask,p=t.prev,f=t.strstart+xt;let u=l[n+r-1],v=l[n+r];t.prev_length>=t.good_match&&(e>>=2),a>t.lookahead&&(a=t.lookahead);do if(s=i,!(l[s+r]!==v||l[s+r-1]!==u||l[s]!==l[n]||l[++s]!==l[n+1])){n+=2,s++;do;while(l[++n]===l[++s]&&l[++n]===l[++s]&&l[++n]===l[++s]&&l[++n]===l[++s]&&l[++n]===l[++s]&&l[++n]===l[++s]&&l[++n]===l[++s]&&l[++n]===l[++s]&&n<f);if(o=xt-(f-n),n=f-xt,o>r){if(t.match_start=i,r=o,o>=a)break;u=l[n+r-1],v=l[n+r]}}while((i=p[i&h])>c&&--e!==0);return r<=t.lookahead?r:t.lookahead},Ht=t=>{const i=t.w_size;let e,n,s;do{if(n=t.window_size-t.lookahead-t.strstart,t.strstart>=i+(i-st)&&(t.window.set(t.window.subarray(i,i+i-n),0),t.match_start-=i,t.strstart-=i,t.block_start-=i,t.insert>t.strstart&&(t.insert=t.strstart),c2(t),n+=i),t.strm.avail_in===0)break;if(e=Ai(t.strm,t.window,t.strstart+t.lookahead,n),t.lookahead+=e,t.lookahead+t.insert>=B)for(s=t.strstart-t.insert,t.ins_h=t.window[s],t.ins_h=At(t,t.ins_h,t.window[s+1]);t.insert&&(t.ins_h=At(t,t.ins_h,t.window[s+B-1]),t.prev[s&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=s,s++,t.insert--,!(t.lookahead+t.insert<B)););}while(t.lookahead<st&&t.strm.avail_in!==0)},ms=(t,i)=>{let e=t.pending_buf_size-5>t.w_size?t.w_size:t.pending_buf_size-5,n,s,o,r=0,a=t.strm.avail_in;do{if(n=65535,o=t.bi_valid+42>>3,t.strm.avail_out<o||(o=t.strm.avail_out-o,s=t.strstart-t.block_start,n>s+t.strm.avail_in&&(n=s+t.strm.avail_in),n>o&&(n=o),n<e&&(n===0&&i!==X||i===Et||n!==s+t.strm.avail_in)))break;r=i===X&&n===s+t.strm.avail_in?1:0,vi(t,0,0,r),t.pending_buf[t.pending-4]=n,t.pending_buf[t.pending-3]=n>>8,t.pending_buf[t.pending-2]=~n,t.pending_buf[t.pending-1]=~n>>8,H(t.strm),s&&(s>n&&(s=n),t.strm.output.set(t.window.subarray(t.block_start,t.block_start+s),t.strm.next_out),t.strm.next_out+=s,t.strm.avail_out-=s,t.strm.total_out+=s,t.block_start+=s,n-=s),n&&(Ai(t.strm,t.strm.output,t.strm.next_out,n),t.strm.next_out+=n,t.strm.avail_out-=n,t.strm.total_out+=n)}while(r===0);return a-=t.strm.avail_in,a&&(a>=t.w_size?(t.matches=2,t.window.set(t.strm.input.subarray(t.strm.next_in-t.w_size,t.strm.next_in),0),t.strstart=t.w_size,t.insert=t.strstart):(t.window_size-t.strstart<=a&&(t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,t.insert>t.strstart&&(t.insert=t.strstart)),t.window.set(t.strm.input.subarray(t.strm.next_in-a,t.strm.next_in),t.strstart),t.strstart+=a,t.insert+=a>t.w_size-t.insert?t.w_size-t.insert:a),t.block_start=t.strstart),t.high_water<t.strstart&&(t.high_water=t.strstart),r?Wt:i!==Et&&i!==X&&t.strm.avail_in===0&&t.strstart===t.block_start?qt:(o=t.window_size-t.strstart,t.strm.avail_in>o&&t.block_start>=t.w_size&&(t.block_start-=t.w_size,t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,o+=t.w_size,t.insert>t.strstart&&(t.insert=t.strstart)),o>t.strm.avail_in&&(o=t.strm.avail_in),o&&(Ai(t.strm,t.window,t.strstart,o),t.strstart+=o,t.insert+=o>t.w_size-t.insert?t.w_size-t.insert:o),t.high_water<t.strstart&&(t.high_water=t.strstart),o=t.bi_valid+42>>3,o=t.pending_buf_size-o>65535?65535:t.pending_buf_size-o,e=o>t.w_size?t.w_size:o,s=t.strstart-t.block_start,(s>=e||(s||i===X)&&i!==Et&&t.strm.avail_in===0&&s<=o)&&(n=s>o?o:s,r=i===X&&t.strm.avail_in===0&&n===s?1:0,vi(t,t.block_start,n,r),t.block_start+=n,H(t.strm)),r?Nt:O)},ei=(t,i)=>{let e,n;for(;;){if(t.lookahead<st){if(Ht(t),t.lookahead<st&&i===Et)return O;if(t.lookahead===0)break}if(e=0,t.lookahead>=B&&(t.ins_h=At(t,t.ins_h,t.window[t.strstart+B-1]),e=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),e!==0&&t.strstart-e<=t.w_size-st&&(t.match_length=ds(t,e)),t.match_length>=B)if(n=Tt(t,t.strstart-t.match_start,t.match_length-B),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=B){t.match_length--;do t.strstart++,t.ins_h=At(t,t.ins_h,t.window[t.strstart+B-1]),e=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart;while(--t.match_length!==0);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=At(t,t.ins_h,t.window[t.strstart+1]);else n=Tt(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(n&&(Z(t,!1),t.strm.avail_out===0))return O}return t.insert=t.strstart<B-1?t.strstart:B-1,i===X?(Z(t,!0),t.strm.avail_out===0?Nt:Wt):t.sym_next&&(Z(t,!1),t.strm.avail_out===0)?O:qt},Pt=(t,i)=>{let e,n,s;for(;;){if(t.lookahead<st){if(Ht(t),t.lookahead<st&&i===Et)return O;if(t.lookahead===0)break}if(e=0,t.lookahead>=B&&(t.ins_h=At(t,t.ins_h,t.window[t.strstart+B-1]),e=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=B-1,e!==0&&t.prev_length<t.max_lazy_match&&t.strstart-e<=t.w_size-st&&(t.match_length=ds(t,e),t.match_length<=5&&(t.strategy===jf||t.match_length===B&&t.strstart-t.match_start>4096)&&(t.match_length=B-1)),t.prev_length>=B&&t.match_length<=t.prev_length){s=t.strstart+t.lookahead-B,n=Tt(t,t.strstart-1-t.prev_match,t.prev_length-B),t.lookahead-=t.prev_length-1,t.prev_length-=2;do++t.strstart<=s&&(t.ins_h=At(t,t.ins_h,t.window[t.strstart+B-1]),e=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart);while(--t.prev_length!==0);if(t.match_available=0,t.match_length=B-1,t.strstart++,n&&(Z(t,!1),t.strm.avail_out===0))return O}else if(t.match_available){if(n=Tt(t,0,t.window[t.strstart-1]),n&&Z(t,!1),t.strstart++,t.lookahead--,t.strm.avail_out===0)return O}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(n=Tt(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<B-1?t.strstart:B-1,i===X?(Z(t,!0),t.strm.avail_out===0?Nt:Wt):t.sym_next&&(Z(t,!1),t.strm.avail_out===0)?O:qt},u2=(t,i)=>{let e,n,s,o;const r=t.window;for(;;){if(t.lookahead<=xt){if(Ht(t),t.lookahead<=xt&&i===Et)return O;if(t.lookahead===0)break}if(t.match_length=0,t.lookahead>=B&&t.strstart>0&&(s=t.strstart-1,n=r[s],n===r[++s]&&n===r[++s]&&n===r[++s])){o=t.strstart+xt;do;while(n===r[++s]&&n===r[++s]&&n===r[++s]&&n===r[++s]&&n===r[++s]&&n===r[++s]&&n===r[++s]&&n===r[++s]&&s<o);t.match_length=xt-(o-s),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=B?(e=Tt(t,1,t.match_length-B),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(e=Tt(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),e&&(Z(t,!1),t.strm.avail_out===0))return O}return t.insert=0,i===X?(Z(t,!0),t.strm.avail_out===0?Nt:Wt):t.sym_next&&(Z(t,!1),t.strm.avail_out===0)?O:qt},d2=(t,i)=>{let e;for(;;){if(t.lookahead===0&&(Ht(t),t.lookahead===0)){if(i===Et)return O;break}if(t.match_length=0,e=Tt(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,e&&(Z(t,!1),t.strm.avail_out===0))return O}return t.insert=0,i===X?(Z(t,!0),t.strm.avail_out===0?Nt:Wt):t.sym_next&&(Z(t,!1),t.strm.avail_out===0)?O:qt};function J(t,i,e,n,s){this.good_length=t,this.max_lazy=i,this.nice_length=e,this.max_chain=n,this.func=s}const ie=[new J(0,0,0,0,ms),new J(4,4,8,4,ei),new J(4,5,16,8,ei),new J(4,6,32,32,ei),new J(4,4,16,16,Pt),new J(8,16,32,32,Pt),new J(8,16,128,128,Pt),new J(8,32,128,256,Pt),new J(32,128,258,1024,Pt),new J(32,258,258,4096,Pt)],m2=t=>{t.window_size=2*t.w_size,vt(t.head),t.max_lazy_match=ie[t.level].max_lazy,t.good_match=ie[t.level].good_length,t.nice_match=ie[t.level].nice_length,t.max_chain_length=ie[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=B-1,t.match_available=0,t.ins_h=0};function p2(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=ze,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(r2*2),this.dyn_dtree=new Uint16Array((2*s2+1)*2),this.bl_tree=new Uint16Array((2*o2+1)*2),vt(this.dyn_ltree),vt(this.dyn_dtree),vt(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(a2+1),this.heap=new Uint16Array(2*xi+1),vt(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*xi+1),vt(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const me=t=>{if(!t)return 1;const i=t.state;return!i||i.strm!==t||i.status!==Vt&&i.status!==Mi&&i.status!==bi&&i.status!==yi&&i.status!==Ti&&i.status!==Ei&&i.status!==Bt&&i.status!==ee?1:0},ps=t=>{if(me(t))return Ft(t,nt);t.total_in=t.total_out=0,t.data_type=Qf;const i=t.state;return i.pending=0,i.pending_out=0,i.wrap<0&&(i.wrap=-i.wrap),i.status=i.wrap===2?Mi:i.wrap?Vt:Bt,t.adler=i.wrap===2?0:1,i.last_flush=-2,Of(i),L},gs=t=>{const i=ps(t);return i===L&&m2(t.state),i},g2=(t,i)=>me(t)||t.state.wrap!==2?nt:(t.state.gzhead=i,L),_s=(t,i,e,n,s,o)=>{if(!t)return nt;let r=1;if(i===Yf&&(i=6),n<0?(r=0,n=-n):n>15&&(r=2,n-=16),s<1||s>Jf||e!==ze||n<8||n>15||i<0||i>9||o<0||o>Wf||n===8&&r!==1)return Ft(t,nt);n===8&&(n=9);const a=new p2;return t.state=a,a.strm=t,a.status=Vt,a.wrap=r,a.gzhead=null,a.w_bits=n,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=s+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+B-1)/B),a.window=new Uint8Array(a.w_size*2),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<s+6,a.pending_buf_size=a.lit_bufsize*4,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=(a.lit_bufsize-1)*3,a.level=i,a.strategy=o,a.method=e,gs(t)},_2=(t,i)=>_s(t,i,ze,t2,e2,Kf),v2=(t,i)=>{if(me(t)||i>nn||i<0)return t?Ft(t,nt):nt;const e=t.state;if(!t.output||t.avail_in!==0&&!t.input||e.status===ee&&i!==X)return Ft(t,t.avail_out===0?ti:nt);const n=e.last_flush;if(e.last_flush=i,e.pending!==0){if(H(t),t.avail_out===0)return e.last_flush=-1,L}else if(t.avail_in===0&&on(i)<=on(n)&&i!==X)return Ft(t,ti);if(e.status===ee&&t.avail_in!==0)return Ft(t,ti);if(e.status===Vt&&e.wrap===0&&(e.status=Bt),e.status===Vt){let s=ze+(e.w_bits-8<<4)<<8,o=-1;if(e.strategy>=ye||e.level<2?o=0:e.level<6?o=1:e.level===6?o=2:o=3,s|=o<<6,e.strstart!==0&&(s|=l2),s+=31-s%31,Jt(e,s),e.strstart!==0&&(Jt(e,t.adler>>>16),Jt(e,t.adler&65535)),t.adler=1,e.status=Bt,H(t),e.pending!==0)return e.last_flush=-1,L}if(e.status===Mi){if(t.adler=0,F(e,31),F(e,139),F(e,8),e.gzhead)F(e,(e.gzhead.text?1:0)+(e.gzhead.hcrc?2:0)+(e.gzhead.extra?4:0)+(e.gzhead.name?8:0)+(e.gzhead.comment?16:0)),F(e,e.gzhead.time&255),F(e,e.gzhead.time>>8&255),F(e,e.gzhead.time>>16&255),F(e,e.gzhead.time>>24&255),F(e,e.level===9?2:e.strategy>=ye||e.level<2?4:0),F(e,e.gzhead.os&255),e.gzhead.extra&&e.gzhead.extra.length&&(F(e,e.gzhead.extra.length&255),F(e,e.gzhead.extra.length>>8&255)),e.gzhead.hcrc&&(t.adler=_t(t.adler,e.pending_buf,e.pending,0)),e.gzindex=0,e.status=bi;else if(F(e,0),F(e,0),F(e,0),F(e,0),F(e,0),F(e,e.level===9?2:e.strategy>=ye||e.level<2?4:0),F(e,h2),e.status=Bt,H(t),e.pending!==0)return e.last_flush=-1,L}if(e.status===bi){if(e.gzhead.extra){let s=e.pending,o=(e.gzhead.extra.length&65535)-e.gzindex;for(;e.pending+o>e.pending_buf_size;){let a=e.pending_buf_size-e.pending;if(e.pending_buf.set(e.gzhead.extra.subarray(e.gzindex,e.gzindex+a),e.pending),e.pending=e.pending_buf_size,e.gzhead.hcrc&&e.pending>s&&(t.adler=_t(t.adler,e.pending_buf,e.pending-s,s)),e.gzindex+=a,H(t),e.pending!==0)return e.last_flush=-1,L;s=0,o-=a}let r=new Uint8Array(e.gzhead.extra);e.pending_buf.set(r.subarray(e.gzindex,e.gzindex+o),e.pending),e.pending+=o,e.gzhead.hcrc&&e.pending>s&&(t.adler=_t(t.adler,e.pending_buf,e.pending-s,s)),e.gzindex=0}e.status=yi}if(e.status===yi){if(e.gzhead.name){let s=e.pending,o;do{if(e.pending===e.pending_buf_size){if(e.gzhead.hcrc&&e.pending>s&&(t.adler=_t(t.adler,e.pending_buf,e.pending-s,s)),H(t),e.pending!==0)return e.last_flush=-1,L;s=0}e.gzindex<e.gzhead.name.length?o=e.gzhead.name.charCodeAt(e.gzindex++)&255:o=0,F(e,o)}while(o!==0);e.gzhead.hcrc&&e.pending>s&&(t.adler=_t(t.adler,e.pending_buf,e.pending-s,s)),e.gzindex=0}e.status=Ti}if(e.status===Ti){if(e.gzhead.comment){let s=e.pending,o;do{if(e.pending===e.pending_buf_size){if(e.gzhead.hcrc&&e.pending>s&&(t.adler=_t(t.adler,e.pending_buf,e.pending-s,s)),H(t),e.pending!==0)return e.last_flush=-1,L;s=0}e.gzindex<e.gzhead.comment.length?o=e.gzhead.comment.charCodeAt(e.gzindex++)&255:o=0,F(e,o)}while(o!==0);e.gzhead.hcrc&&e.pending>s&&(t.adler=_t(t.adler,e.pending_buf,e.pending-s,s))}e.status=Ei}if(e.status===Ei){if(e.gzhead.hcrc){if(e.pending+2>e.pending_buf_size&&(H(t),e.pending!==0))return e.last_flush=-1,L;F(e,t.adler&255),F(e,t.adler>>8&255),t.adler=0}if(e.status=Bt,H(t),e.pending!==0)return e.last_flush=-1,L}if(t.avail_in!==0||e.lookahead!==0||i!==Et&&e.status!==ee){let s=e.level===0?ms(e,i):e.strategy===ye?d2(e,i):e.strategy===qf?u2(e,i):ie[e.level].func(e,i);if((s===Nt||s===Wt)&&(e.status=ee),s===O||s===Nt)return t.avail_out===0&&(e.last_flush=-1),L;if(s===qt&&(i===Hf?Gf(e):i!==nn&&(vi(e,0,0,!1),i===Zf&&(vt(e.head),e.lookahead===0&&(e.strstart=0,e.block_start=0,e.insert=0))),H(t),t.avail_out===0))return e.last_flush=-1,L}return i!==X?L:e.wrap<=0?sn:(e.wrap===2?(F(e,t.adler&255),F(e,t.adler>>8&255),F(e,t.adler>>16&255),F(e,t.adler>>24&255),F(e,t.total_in&255),F(e,t.total_in>>8&255),F(e,t.total_in>>16&255),F(e,t.total_in>>24&255)):(Jt(e,t.adler>>>16),Jt(e,t.adler&65535)),H(t),e.wrap>0&&(e.wrap=-e.wrap),e.pending!==0?L:sn)},x2=t=>{if(me(t))return nt;const i=t.state.status;return t.state=null,i===Bt?Ft(t,Xf):L},b2=(t,i)=>{let e=i.length;if(me(t))return nt;const n=t.state,s=n.wrap;if(s===2||s===1&&n.status!==Vt||n.lookahead)return nt;if(s===1&&(t.adler=us(t.adler,i,e,0)),n.wrap=0,e>=n.w_size){s===0&&(vt(n.head),n.strstart=0,n.block_start=0,n.insert=0);let c=new Uint8Array(n.w_size);c.set(i.subarray(e-n.w_size,e),0),i=c,e=n.w_size}const o=t.avail_in,r=t.next_in,a=t.input;for(t.avail_in=e,t.next_in=0,t.input=i,Ht(n);n.lookahead>=B;){let c=n.strstart,l=n.lookahead-(B-1);do n.ins_h=At(n,n.ins_h,n.window[c+B-1]),n.prev[c&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=c,c++;while(--l);n.strstart=c,n.lookahead=B-1,Ht(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=B-1,n.match_available=0,t.next_in=r,t.input=a,t.avail_in=o,n.wrap=s,L};rt.deflateInit=_2;rt.deflateInit2=_s;rt.deflateReset=gs;rt.deflateResetKeep=ps;rt.deflateSetHeader=g2;rt.deflate=v2;rt.deflateEnd=x2;rt.deflateSetDictionary=b2;rt.deflateInfo="pako deflate (from Nodeca project)";var Ge={};const y2=(t,i)=>Object.prototype.hasOwnProperty.call(t,i);Ge.assign=function(t){const i=Array.prototype.slice.call(arguments,1);for(;i.length;){const e=i.shift();if(!!e){if(typeof e!="object")throw new TypeError(e+"must be non-object");for(const n in e)y2(e,n)&&(t[n]=e[n])}}return t};Ge.flattenChunks=t=>{let i=0;for(let n=0,s=t.length;n<s;n++)i+=t[n].length;const e=new Uint8Array(i);for(let n=0,s=0,o=t.length;n<o;n++){let r=t[n];e.set(r,s),s+=r.length}return e};var pe={};let vs=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{vs=!1}const ce=new Uint8Array(256);for(let t=0;t<256;t++)ce[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;ce[254]=ce[254]=1;pe.string2buf=t=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(t);let i,e,n,s,o,r=t.length,a=0;for(s=0;s<r;s++)e=t.charCodeAt(s),(e&64512)===55296&&s+1<r&&(n=t.charCodeAt(s+1),(n&64512)===56320&&(e=65536+(e-55296<<10)+(n-56320),s++)),a+=e<128?1:e<2048?2:e<65536?3:4;for(i=new Uint8Array(a),o=0,s=0;o<a;s++)e=t.charCodeAt(s),(e&64512)===55296&&s+1<r&&(n=t.charCodeAt(s+1),(n&64512)===56320&&(e=65536+(e-55296<<10)+(n-56320),s++)),e<128?i[o++]=e:e<2048?(i[o++]=192|e>>>6,i[o++]=128|e&63):e<65536?(i[o++]=224|e>>>12,i[o++]=128|e>>>6&63,i[o++]=128|e&63):(i[o++]=240|e>>>18,i[o++]=128|e>>>12&63,i[o++]=128|e>>>6&63,i[o++]=128|e&63);return i};const T2=(t,i)=>{if(i<65534&&t.subarray&&vs)return String.fromCharCode.apply(null,t.length===i?t:t.subarray(0,i));let e="";for(let n=0;n<i;n++)e+=String.fromCharCode(t[n]);return e};pe.buf2string=(t,i)=>{const e=i||t.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(t.subarray(0,i));let n,s;const o=new Array(e*2);for(s=0,n=0;n<e;){let r=t[n++];if(r<128){o[s++]=r;continue}let a=ce[r];if(a>4){o[s++]=65533,n+=a-1;continue}for(r&=a===2?31:a===3?15:7;a>1&&n<e;)r=r<<6|t[n++]&63,a--;if(a>1){o[s++]=65533;continue}r<65536?o[s++]=r:(r-=65536,o[s++]=55296|r>>10&1023,o[s++]=56320|r&1023)}return T2(o,s)};pe.utf8border=(t,i)=>{i=i||t.length,i>t.length&&(i=t.length);let e=i-1;for(;e>=0&&(t[e]&192)===128;)e--;return e<0||e===0?i:e+ce[t[e]]>i?e:i};function E2(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var xs=E2;const se=rt,bs=Ge,ys=pe,Si=Pi,A2=xs,Ts=Object.prototype.toString,{Z_NO_FLUSH:S2,Z_SYNC_FLUSH:w2,Z_FULL_FLUSH:I2,Z_FINISH:R2,Z_OK:Pe,Z_STREAM_END:D2,Z_DEFAULT_COMPRESSION:B2,Z_DEFAULT_STRATEGY:F2,Z_DEFLATED:N2}=Ut;function ge(t){this.options=bs.assign({level:B2,method:N2,chunkSize:16384,windowBits:15,memLevel:8,strategy:F2},t||{});let i=this.options;i.raw&&i.windowBits>0?i.windowBits=-i.windowBits:i.gzip&&i.windowBits>0&&i.windowBits<16&&(i.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new A2,this.strm.avail_out=0;let e=se.deflateInit2(this.strm,i.level,i.method,i.windowBits,i.memLevel,i.strategy);if(e!==Pe)throw new Error(Si[e]);if(i.header&&se.deflateSetHeader(this.strm,i.header),i.dictionary){let n;if(typeof i.dictionary=="string"?n=ys.string2buf(i.dictionary):Ts.call(i.dictionary)==="[object ArrayBuffer]"?n=new Uint8Array(i.dictionary):n=i.dictionary,e=se.deflateSetDictionary(this.strm,n),e!==Pe)throw new Error(Si[e]);this._dict_set=!0}}ge.prototype.push=function(t,i){const e=this.strm,n=this.options.chunkSize;let s,o;if(this.ended)return!1;for(i===~~i?o=i:o=i===!0?R2:S2,typeof t=="string"?e.input=ys.string2buf(t):Ts.call(t)==="[object ArrayBuffer]"?e.input=new Uint8Array(t):e.input=t,e.next_in=0,e.avail_in=e.input.length;;){if(e.avail_out===0&&(e.output=new Uint8Array(n),e.next_out=0,e.avail_out=n),(o===w2||o===I2)&&e.avail_out<=6){this.onData(e.output.subarray(0,e.next_out)),e.avail_out=0;continue}if(s=se.deflate(e,o),s===D2)return e.next_out>0&&this.onData(e.output.subarray(0,e.next_out)),s=se.deflateEnd(this.strm),this.onEnd(s),this.ended=!0,s===Pe;if(e.avail_out===0){this.onData(e.output);continue}if(o>0&&e.next_out>0){this.onData(e.output.subarray(0,e.next_out)),e.avail_out=0;continue}if(e.avail_in===0)break}return!0};ge.prototype.onData=function(t){this.chunks.push(t)};ge.prototype.onEnd=function(t){t===Pe&&(this.result=bs.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};function Li(t,i){const e=new ge(i);if(e.push(t,!0),e.err)throw e.msg||Si[e.err];return e.result}function C2(t,i){return i=i||{},i.raw=!0,Li(t,i)}function U2(t,i){return i=i||{},i.gzip=!0,Li(t,i)}Xt.Deflate=ge;Xt.deflate=Li;Xt.deflateRaw=C2;Xt.gzip=U2;Xt.constants=Ut;var Kt={},Q={};const Te=16209,k2=16191;var P2=function(i,e){let n,s,o,r,a,c,l,h,p,f,u,v,g,m,_,b,x,d,E,A,T,I,R,S;const w=i.state;n=i.next_in,R=i.input,s=n+(i.avail_in-5),o=i.next_out,S=i.output,r=o-(e-i.avail_out),a=o+(i.avail_out-257),c=w.dmax,l=w.wsize,h=w.whave,p=w.wnext,f=w.window,u=w.hold,v=w.bits,g=w.lencode,m=w.distcode,_=(1<<w.lenbits)-1,b=(1<<w.distbits)-1;t:do{v<15&&(u+=R[n++]<<v,v+=8,u+=R[n++]<<v,v+=8),x=g[u&_];e:for(;;){if(d=x>>>24,u>>>=d,v-=d,d=x>>>16&255,d===0)S[o++]=x&65535;else if(d&16){E=x&65535,d&=15,d&&(v<d&&(u+=R[n++]<<v,v+=8),E+=u&(1<<d)-1,u>>>=d,v-=d),v<15&&(u+=R[n++]<<v,v+=8,u+=R[n++]<<v,v+=8),x=m[u&b];i:for(;;){if(d=x>>>24,u>>>=d,v-=d,d=x>>>16&255,d&16){if(A=x&65535,d&=15,v<d&&(u+=R[n++]<<v,v+=8,v<d&&(u+=R[n++]<<v,v+=8)),A+=u&(1<<d)-1,A>c){i.msg="invalid distance too far back",w.mode=Te;break t}if(u>>>=d,v-=d,d=o-r,A>d){if(d=A-d,d>h&&w.sane){i.msg="invalid distance too far back",w.mode=Te;break t}if(T=0,I=f,p===0){if(T+=l-d,d<E){E-=d;do S[o++]=f[T++];while(--d);T=o-A,I=S}}else if(p<d){if(T+=l+p-d,d-=p,d<E){E-=d;do S[o++]=f[T++];while(--d);if(T=0,p<E){d=p,E-=d;do S[o++]=f[T++];while(--d);T=o-A,I=S}}}else if(T+=p-d,d<E){E-=d;do S[o++]=f[T++];while(--d);T=o-A,I=S}for(;E>2;)S[o++]=I[T++],S[o++]=I[T++],S[o++]=I[T++],E-=3;E&&(S[o++]=I[T++],E>1&&(S[o++]=I[T++]))}else{T=o-A;do S[o++]=S[T++],S[o++]=S[T++],S[o++]=S[T++],E-=3;while(E>2);E&&(S[o++]=S[T++],E>1&&(S[o++]=S[T++]))}}else if((d&64)===0){x=m[(x&65535)+(u&(1<<d)-1)];continue i}else{i.msg="invalid distance code",w.mode=Te;break t}break}}else if((d&64)===0){x=g[(x&65535)+(u&(1<<d)-1)];continue e}else if(d&32){w.mode=k2;break t}else{i.msg="invalid literal/length code",w.mode=Te;break t}break}}while(n<s&&o<a);E=v>>3,n-=E,v-=E<<3,u&=(1<<v)-1,i.next_in=n,i.next_out=o,i.avail_in=n<s?5+(s-n):5-(n-s),i.avail_out=o<a?257+(a-o):257-(o-a),w.hold=u,w.bits=v};const Mt=15,rn=852,an=592,ln=0,ii=1,hn=2,M2=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),L2=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),$2=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),O2=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),z2=(t,i,e,n,s,o,r,a)=>{const c=a.bits;let l=0,h=0,p=0,f=0,u=0,v=0,g=0,m=0,_=0,b=0,x,d,E,A,T,I=null,R;const S=new Uint16Array(Mt+1),w=new Uint16Array(Mt+1);let k=null,U,D,V;for(l=0;l<=Mt;l++)S[l]=0;for(h=0;h<n;h++)S[i[e+h]]++;for(u=c,f=Mt;f>=1&&S[f]===0;f--);if(u>f&&(u=f),f===0)return s[o++]=1<<24|64<<16|0,s[o++]=1<<24|64<<16|0,a.bits=1,0;for(p=1;p<f&&S[p]===0;p++);for(u<p&&(u=p),m=1,l=1;l<=Mt;l++)if(m<<=1,m-=S[l],m<0)return-1;if(m>0&&(t===ln||f!==1))return-1;for(w[1]=0,l=1;l<Mt;l++)w[l+1]=w[l]+S[l];for(h=0;h<n;h++)i[e+h]!==0&&(r[w[i[e+h]]++]=h);if(t===ln?(I=k=r,R=20):t===ii?(I=M2,k=L2,R=257):(I=$2,k=O2,R=0),b=0,h=0,l=p,T=o,v=u,g=0,E=-1,_=1<<u,A=_-1,t===ii&&_>rn||t===hn&&_>an)return 1;for(;;){U=l-g,r[h]+1<R?(D=0,V=r[h]):r[h]>=R?(D=k[r[h]-R],V=I[r[h]-R]):(D=32+64,V=0),x=1<<l-g,d=1<<v,p=d;do d-=x,s[T+(b>>g)+d]=U<<24|D<<16|V|0;while(d!==0);for(x=1<<l-1;b&x;)x>>=1;if(x!==0?(b&=x-1,b+=x):b=0,h++,--S[l]===0){if(l===f)break;l=i[e+r[h]]}if(l>u&&(b&A)!==E){for(g===0&&(g=u),T+=p,v=l-g,m=1<<v;v+g<f&&(m-=S[v+g],!(m<=0));)v++,m<<=1;if(_+=1<<v,t===ii&&_>rn||t===hn&&_>an)return 1;E=b&A,s[E]=u<<24|v<<16|T-o|0}}return b!==0&&(s[T+b]=l-g<<24|64<<16|0),a.bits=u,0};var G2=z2;const wi=cs,tt=fs,V2=P2,oe=G2,H2=0,Es=1,As=2,{Z_FINISH:cn,Z_BLOCK:Z2,Z_TREES:Ee,Z_OK:Ct,Z_STREAM_END:X2,Z_NEED_DICT:Y2,Z_STREAM_ERROR:q,Z_DATA_ERROR:Ss,Z_MEM_ERROR:ws,Z_BUF_ERROR:j2,Z_DEFLATED:fn}=Ut,Ve=16180,un=16181,dn=16182,mn=16183,pn=16184,gn=16185,_n=16186,vn=16187,xn=16188,bn=16189,Me=16190,at=16191,ni=16192,yn=16193,si=16194,Tn=16195,En=16196,An=16197,Sn=16198,Ae=16199,Se=16200,wn=16201,In=16202,Rn=16203,Dn=16204,Bn=16205,oi=16206,Fn=16207,Nn=16208,C=16209,Is=16210,Rs=16211,q2=852,W2=592,K2=15,Q2=K2,Cn=t=>(t>>>24&255)+(t>>>8&65280)+((t&65280)<<8)+((t&255)<<24);function J2(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const kt=t=>{if(!t)return 1;const i=t.state;return!i||i.strm!==t||i.mode<Ve||i.mode>Rs?1:0},Ds=t=>{if(kt(t))return q;const i=t.state;return t.total_in=t.total_out=i.total=0,t.msg="",i.wrap&&(t.adler=i.wrap&1),i.mode=Ve,i.last=0,i.havedict=0,i.flags=-1,i.dmax=32768,i.head=null,i.hold=0,i.bits=0,i.lencode=i.lendyn=new Int32Array(q2),i.distcode=i.distdyn=new Int32Array(W2),i.sane=1,i.back=-1,Ct},Bs=t=>{if(kt(t))return q;const i=t.state;return i.wsize=0,i.whave=0,i.wnext=0,Ds(t)},Fs=(t,i)=>{let e;if(kt(t))return q;const n=t.state;return i<0?(e=0,i=-i):(e=(i>>4)+5,i<48&&(i&=15)),i&&(i<8||i>15)?q:(n.window!==null&&n.wbits!==i&&(n.window=null),n.wrap=e,n.wbits=i,Bs(t))},Ns=(t,i)=>{if(!t)return q;const e=new J2;t.state=e,e.strm=t,e.window=null,e.mode=Ve;const n=Fs(t,i);return n!==Ct&&(t.state=null),n},tu=t=>Ns(t,Q2);let Un=!0,ri,ai;const eu=t=>{if(Un){ri=new Int32Array(512),ai=new Int32Array(32);let i=0;for(;i<144;)t.lens[i++]=8;for(;i<256;)t.lens[i++]=9;for(;i<280;)t.lens[i++]=7;for(;i<288;)t.lens[i++]=8;for(oe(Es,t.lens,0,288,ri,0,t.work,{bits:9}),i=0;i<32;)t.lens[i++]=5;oe(As,t.lens,0,32,ai,0,t.work,{bits:5}),Un=!1}t.lencode=ri,t.lenbits=9,t.distcode=ai,t.distbits=5},Cs=(t,i,e,n)=>{let s;const o=t.state;return o.window===null&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),n>=o.wsize?(o.window.set(i.subarray(e-o.wsize,e),0),o.wnext=0,o.whave=o.wsize):(s=o.wsize-o.wnext,s>n&&(s=n),o.window.set(i.subarray(e-n,e-n+s),o.wnext),n-=s,n?(o.window.set(i.subarray(e-n,e),0),o.wnext=n,o.whave=o.wsize):(o.wnext+=s,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=s))),0},iu=(t,i)=>{let e,n,s,o,r,a,c,l,h,p,f,u,v,g,m=0,_,b,x,d,E,A,T,I;const R=new Uint8Array(4);let S,w;const k=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(kt(t)||!t.output||!t.input&&t.avail_in!==0)return q;e=t.state,e.mode===at&&(e.mode=ni),r=t.next_out,s=t.output,c=t.avail_out,o=t.next_in,n=t.input,a=t.avail_in,l=e.hold,h=e.bits,p=a,f=c,I=Ct;t:for(;;)switch(e.mode){case Ve:if(e.wrap===0){e.mode=ni;break}for(;h<16;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}if(e.wrap&2&&l===35615){e.wbits===0&&(e.wbits=15),e.check=0,R[0]=l&255,R[1]=l>>>8&255,e.check=tt(e.check,R,2,0),l=0,h=0,e.mode=un;break}if(e.head&&(e.head.done=!1),!(e.wrap&1)||(((l&255)<<8)+(l>>8))%31){t.msg="incorrect header check",e.mode=C;break}if((l&15)!==fn){t.msg="unknown compression method",e.mode=C;break}if(l>>>=4,h-=4,T=(l&15)+8,e.wbits===0&&(e.wbits=T),T>15||T>e.wbits){t.msg="invalid window size",e.mode=C;break}e.dmax=1<<e.wbits,e.flags=0,t.adler=e.check=1,e.mode=l&512?bn:at,l=0,h=0;break;case un:for(;h<16;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}if(e.flags=l,(e.flags&255)!==fn){t.msg="unknown compression method",e.mode=C;break}if(e.flags&57344){t.msg="unknown header flags set",e.mode=C;break}e.head&&(e.head.text=l>>8&1),e.flags&512&&e.wrap&4&&(R[0]=l&255,R[1]=l>>>8&255,e.check=tt(e.check,R,2,0)),l=0,h=0,e.mode=dn;case dn:for(;h<32;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}e.head&&(e.head.time=l),e.flags&512&&e.wrap&4&&(R[0]=l&255,R[1]=l>>>8&255,R[2]=l>>>16&255,R[3]=l>>>24&255,e.check=tt(e.check,R,4,0)),l=0,h=0,e.mode=mn;case mn:for(;h<16;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}e.head&&(e.head.xflags=l&255,e.head.os=l>>8),e.flags&512&&e.wrap&4&&(R[0]=l&255,R[1]=l>>>8&255,e.check=tt(e.check,R,2,0)),l=0,h=0,e.mode=pn;case pn:if(e.flags&1024){for(;h<16;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}e.length=l,e.head&&(e.head.extra_len=l),e.flags&512&&e.wrap&4&&(R[0]=l&255,R[1]=l>>>8&255,e.check=tt(e.check,R,2,0)),l=0,h=0}else e.head&&(e.head.extra=null);e.mode=gn;case gn:if(e.flags&1024&&(u=e.length,u>a&&(u=a),u&&(e.head&&(T=e.head.extra_len-e.length,e.head.extra||(e.head.extra=new Uint8Array(e.head.extra_len)),e.head.extra.set(n.subarray(o,o+u),T)),e.flags&512&&e.wrap&4&&(e.check=tt(e.check,n,u,o)),a-=u,o+=u,e.length-=u),e.length))break t;e.length=0,e.mode=_n;case _n:if(e.flags&2048){if(a===0)break t;u=0;do T=n[o+u++],e.head&&T&&e.length<65536&&(e.head.name+=String.fromCharCode(T));while(T&&u<a);if(e.flags&512&&e.wrap&4&&(e.check=tt(e.check,n,u,o)),a-=u,o+=u,T)break t}else e.head&&(e.head.name=null);e.length=0,e.mode=vn;case vn:if(e.flags&4096){if(a===0)break t;u=0;do T=n[o+u++],e.head&&T&&e.length<65536&&(e.head.comment+=String.fromCharCode(T));while(T&&u<a);if(e.flags&512&&e.wrap&4&&(e.check=tt(e.check,n,u,o)),a-=u,o+=u,T)break t}else e.head&&(e.head.comment=null);e.mode=xn;case xn:if(e.flags&512){for(;h<16;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}if(e.wrap&4&&l!==(e.check&65535)){t.msg="header crc mismatch",e.mode=C;break}l=0,h=0}e.head&&(e.head.hcrc=e.flags>>9&1,e.head.done=!0),t.adler=e.check=0,e.mode=at;break;case bn:for(;h<32;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}t.adler=e.check=Cn(l),l=0,h=0,e.mode=Me;case Me:if(e.havedict===0)return t.next_out=r,t.avail_out=c,t.next_in=o,t.avail_in=a,e.hold=l,e.bits=h,Y2;t.adler=e.check=1,e.mode=at;case at:if(i===Z2||i===Ee)break t;case ni:if(e.last){l>>>=h&7,h-=h&7,e.mode=oi;break}for(;h<3;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}switch(e.last=l&1,l>>>=1,h-=1,l&3){case 0:e.mode=yn;break;case 1:if(eu(e),e.mode=Ae,i===Ee){l>>>=2,h-=2;break t}break;case 2:e.mode=En;break;case 3:t.msg="invalid block type",e.mode=C}l>>>=2,h-=2;break;case yn:for(l>>>=h&7,h-=h&7;h<32;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}if((l&65535)!==(l>>>16^65535)){t.msg="invalid stored block lengths",e.mode=C;break}if(e.length=l&65535,l=0,h=0,e.mode=si,i===Ee)break t;case si:e.mode=Tn;case Tn:if(u=e.length,u){if(u>a&&(u=a),u>c&&(u=c),u===0)break t;s.set(n.subarray(o,o+u),r),a-=u,o+=u,c-=u,r+=u,e.length-=u;break}e.mode=at;break;case En:for(;h<14;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}if(e.nlen=(l&31)+257,l>>>=5,h-=5,e.ndist=(l&31)+1,l>>>=5,h-=5,e.ncode=(l&15)+4,l>>>=4,h-=4,e.nlen>286||e.ndist>30){t.msg="too many length or distance symbols",e.mode=C;break}e.have=0,e.mode=An;case An:for(;e.have<e.ncode;){for(;h<3;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}e.lens[k[e.have++]]=l&7,l>>>=3,h-=3}for(;e.have<19;)e.lens[k[e.have++]]=0;if(e.lencode=e.lendyn,e.lenbits=7,S={bits:e.lenbits},I=oe(H2,e.lens,0,19,e.lencode,0,e.work,S),e.lenbits=S.bits,I){t.msg="invalid code lengths set",e.mode=C;break}e.have=0,e.mode=Sn;case Sn:for(;e.have<e.nlen+e.ndist;){for(;m=e.lencode[l&(1<<e.lenbits)-1],_=m>>>24,b=m>>>16&255,x=m&65535,!(_<=h);){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}if(x<16)l>>>=_,h-=_,e.lens[e.have++]=x;else{if(x===16){for(w=_+2;h<w;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}if(l>>>=_,h-=_,e.have===0){t.msg="invalid bit length repeat",e.mode=C;break}T=e.lens[e.have-1],u=3+(l&3),l>>>=2,h-=2}else if(x===17){for(w=_+3;h<w;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}l>>>=_,h-=_,T=0,u=3+(l&7),l>>>=3,h-=3}else{for(w=_+7;h<w;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}l>>>=_,h-=_,T=0,u=11+(l&127),l>>>=7,h-=7}if(e.have+u>e.nlen+e.ndist){t.msg="invalid bit length repeat",e.mode=C;break}for(;u--;)e.lens[e.have++]=T}}if(e.mode===C)break;if(e.lens[256]===0){t.msg="invalid code -- missing end-of-block",e.mode=C;break}if(e.lenbits=9,S={bits:e.lenbits},I=oe(Es,e.lens,0,e.nlen,e.lencode,0,e.work,S),e.lenbits=S.bits,I){t.msg="invalid literal/lengths set",e.mode=C;break}if(e.distbits=6,e.distcode=e.distdyn,S={bits:e.distbits},I=oe(As,e.lens,e.nlen,e.ndist,e.distcode,0,e.work,S),e.distbits=S.bits,I){t.msg="invalid distances set",e.mode=C;break}if(e.mode=Ae,i===Ee)break t;case Ae:e.mode=Se;case Se:if(a>=6&&c>=258){t.next_out=r,t.avail_out=c,t.next_in=o,t.avail_in=a,e.hold=l,e.bits=h,V2(t,f),r=t.next_out,s=t.output,c=t.avail_out,o=t.next_in,n=t.input,a=t.avail_in,l=e.hold,h=e.bits,e.mode===at&&(e.back=-1);break}for(e.back=0;m=e.lencode[l&(1<<e.lenbits)-1],_=m>>>24,b=m>>>16&255,x=m&65535,!(_<=h);){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}if(b&&(b&240)===0){for(d=_,E=b,A=x;m=e.lencode[A+((l&(1<<d+E)-1)>>d)],_=m>>>24,b=m>>>16&255,x=m&65535,!(d+_<=h);){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}l>>>=d,h-=d,e.back+=d}if(l>>>=_,h-=_,e.back+=_,e.length=x,b===0){e.mode=Bn;break}if(b&32){e.back=-1,e.mode=at;break}if(b&64){t.msg="invalid literal/length code",e.mode=C;break}e.extra=b&15,e.mode=wn;case wn:if(e.extra){for(w=e.extra;h<w;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}e.length+=l&(1<<e.extra)-1,l>>>=e.extra,h-=e.extra,e.back+=e.extra}e.was=e.length,e.mode=In;case In:for(;m=e.distcode[l&(1<<e.distbits)-1],_=m>>>24,b=m>>>16&255,x=m&65535,!(_<=h);){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}if((b&240)===0){for(d=_,E=b,A=x;m=e.distcode[A+((l&(1<<d+E)-1)>>d)],_=m>>>24,b=m>>>16&255,x=m&65535,!(d+_<=h);){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}l>>>=d,h-=d,e.back+=d}if(l>>>=_,h-=_,e.back+=_,b&64){t.msg="invalid distance code",e.mode=C;break}e.offset=x,e.extra=b&15,e.mode=Rn;case Rn:if(e.extra){for(w=e.extra;h<w;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}e.offset+=l&(1<<e.extra)-1,l>>>=e.extra,h-=e.extra,e.back+=e.extra}if(e.offset>e.dmax){t.msg="invalid distance too far back",e.mode=C;break}e.mode=Dn;case Dn:if(c===0)break t;if(u=f-c,e.offset>u){if(u=e.offset-u,u>e.whave&&e.sane){t.msg="invalid distance too far back",e.mode=C;break}u>e.wnext?(u-=e.wnext,v=e.wsize-u):v=e.wnext-u,u>e.length&&(u=e.length),g=e.window}else g=s,v=r-e.offset,u=e.length;u>c&&(u=c),c-=u,e.length-=u;do s[r++]=g[v++];while(--u);e.length===0&&(e.mode=Se);break;case Bn:if(c===0)break t;s[r++]=e.length,c--,e.mode=Se;break;case oi:if(e.wrap){for(;h<32;){if(a===0)break t;a--,l|=n[o++]<<h,h+=8}if(f-=c,t.total_out+=f,e.total+=f,e.wrap&4&&f&&(t.adler=e.check=e.flags?tt(e.check,s,f,r-f):wi(e.check,s,f,r-f)),f=c,e.wrap&4&&(e.flags?l:Cn(l))!==e.check){t.msg="incorrect data check",e.mode=C;break}l=0,h=0}e.mode=Fn;case Fn:if(e.wrap&&e.flags){for(;h<32;){if(a===0)break t;a--,l+=n[o++]<<h,h+=8}if(e.wrap&4&&l!==(e.total&4294967295)){t.msg="incorrect length check",e.mode=C;break}l=0,h=0}e.mode=Nn;case Nn:I=X2;break t;case C:I=Ss;break t;case Is:return ws;case Rs:default:return q}return t.next_out=r,t.avail_out=c,t.next_in=o,t.avail_in=a,e.hold=l,e.bits=h,(e.wsize||f!==t.avail_out&&e.mode<C&&(e.mode<oi||i!==cn))&&Cs(t,t.output,t.next_out,f-t.avail_out),p-=t.avail_in,f-=t.avail_out,t.total_in+=p,t.total_out+=f,e.total+=f,e.wrap&4&&f&&(t.adler=e.check=e.flags?tt(e.check,s,f,t.next_out-f):wi(e.check,s,f,t.next_out-f)),t.data_type=e.bits+(e.last?64:0)+(e.mode===at?128:0)+(e.mode===Ae||e.mode===si?256:0),(p===0&&f===0||i===cn)&&I===Ct&&(I=j2),I},nu=t=>{if(kt(t))return q;let i=t.state;return i.window&&(i.window=null),t.state=null,Ct},su=(t,i)=>{if(kt(t))return q;const e=t.state;return(e.wrap&2)===0?q:(e.head=i,i.done=!1,Ct)},ou=(t,i)=>{const e=i.length;let n,s,o;return kt(t)||(n=t.state,n.wrap!==0&&n.mode!==Me)?q:n.mode===Me&&(s=1,s=wi(s,i,e,0),s!==n.check)?Ss:(o=Cs(t,i,e,e),o?(n.mode=Is,ws):(n.havedict=1,Ct))};Q.inflateReset=Bs;Q.inflateReset2=Fs;Q.inflateResetKeep=Ds;Q.inflateInit=tu;Q.inflateInit2=Ns;Q.inflate=iu;Q.inflateEnd=nu;Q.inflateGetHeader=su;Q.inflateSetDictionary=ou;Q.inflateInfo="pako inflate (from Nodeca project)";function ru(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var au=ru;const ht=Q,Us=Ge,Ii=pe,Ri=Pi,lu=xs,hu=au,ks=Object.prototype.toString,{Z_NO_FLUSH:cu,Z_FINISH:fu,Z_OK:fe,Z_STREAM_END:li,Z_NEED_DICT:hi,Z_STREAM_ERROR:uu,Z_DATA_ERROR:kn,Z_MEM_ERROR:du}=Ut;function _e(t){this.options=Us.assign({chunkSize:1024*64,windowBits:15,to:""},t||{});const i=this.options;i.raw&&i.windowBits>=0&&i.windowBits<16&&(i.windowBits=-i.windowBits,i.windowBits===0&&(i.windowBits=-15)),i.windowBits>=0&&i.windowBits<16&&!(t&&t.windowBits)&&(i.windowBits+=32),i.windowBits>15&&i.windowBits<48&&(i.windowBits&15)===0&&(i.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new lu,this.strm.avail_out=0;let e=ht.inflateInit2(this.strm,i.windowBits);if(e!==fe)throw new Error(Ri[e]);if(this.header=new hu,ht.inflateGetHeader(this.strm,this.header),i.dictionary&&(typeof i.dictionary=="string"?i.dictionary=Ii.string2buf(i.dictionary):ks.call(i.dictionary)==="[object ArrayBuffer]"&&(i.dictionary=new Uint8Array(i.dictionary)),i.raw&&(e=ht.inflateSetDictionary(this.strm,i.dictionary),e!==fe)))throw new Error(Ri[e])}_e.prototype.push=function(t,i){const e=this.strm,n=this.options.chunkSize,s=this.options.dictionary;let o,r,a;if(this.ended)return!1;for(i===~~i?r=i:r=i===!0?fu:cu,ks.call(t)==="[object ArrayBuffer]"?e.input=new Uint8Array(t):e.input=t,e.next_in=0,e.avail_in=e.input.length;;){for(e.avail_out===0&&(e.output=new Uint8Array(n),e.next_out=0,e.avail_out=n),o=ht.inflate(e,r),o===hi&&s&&(o=ht.inflateSetDictionary(e,s),o===fe?o=ht.inflate(e,r):o===kn&&(o=hi));e.avail_in>0&&o===li&&e.state.wrap>0&&t[e.next_in]!==0;)ht.inflateReset(e),o=ht.inflate(e,r);switch(o){case uu:case kn:case hi:case du:return this.onEnd(o),this.ended=!0,!1}if(a=e.avail_out,e.next_out&&(e.avail_out===0||o===li))if(this.options.to==="string"){let c=Ii.utf8border(e.output,e.next_out),l=e.next_out-c,h=Ii.buf2string(e.output,c);e.next_out=l,e.avail_out=n-l,l&&e.output.set(e.output.subarray(c,c+l),0),this.onData(h)}else this.onData(e.output.length===e.next_out?e.output:e.output.subarray(0,e.next_out));if(!(o===fe&&a===0)){if(o===li)return o=ht.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(e.avail_in===0)break}}return!0};_e.prototype.onData=function(t){this.chunks.push(t)};_e.prototype.onEnd=function(t){t===fe&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Us.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};function $i(t,i){const e=new _e(i);if(e.push(t),e.err)throw e.msg||Ri[e.err];return e.result}function mu(t,i){return i=i||{},i.raw=!0,$i(t,i)}Kt.Inflate=_e;Kt.inflate=$i;Kt.inflateRaw=mu;Kt.ungzip=$i;Kt.constants=Ut;const{Deflate:pu,deflate:gu,deflateRaw:_u,gzip:vu}=Xt,{Inflate:xu,inflate:bu,inflateRaw:yu,ungzip:Tu}=Kt,Eu=Ut;ot.Deflate=pu;ot.deflate=gu;ot.deflateRaw=_u;ot.gzip=vu;ot.Inflate=xu;ot.inflate=bu;ot.inflateRaw=yu;ot.ungzip=Tu;ot.constants=Eu;(function(t){var i=i||{};i.NIFTI1=i.NIFTI1||(typeof Rt!="undefined"?Fi.exports:null),i.NIFTI2=i.NIFTI2||(typeof Rt!="undefined"?jn.exports:null),i.Utils=i.Utils||(typeof Rt!="undefined"?Oe.exports:null);var e=e||(typeof Rt!="undefined"?ot:null);i.isNIFTI1=function(n){var s,o,r,a;return n.byteLength<i.NIFTI1.STANDARD_HEADER_SIZE?!1:(s=new DataView(n),s&&(o=s.getUint8(i.NIFTI1.MAGIC_NUMBER_LOCATION)),r=s.getUint8(i.NIFTI1.MAGIC_NUMBER_LOCATION+1),a=s.getUint8(i.NIFTI1.MAGIC_NUMBER_LOCATION+2),o===i.NIFTI1.MAGIC_NUMBER[0]&&r===i.NIFTI1.MAGIC_NUMBER[1]&&a===i.NIFTI1.MAGIC_NUMBER[2])},i.isNIFTI2=function(n){var s,o,r,a;return n.byteLength<i.NIFTI1.STANDARD_HEADER_SIZE?!1:(s=new DataView(n),o=s.getUint8(i.NIFTI2.MAGIC_NUMBER_LOCATION),r=s.getUint8(i.NIFTI2.MAGIC_NUMBER_LOCATION+1),a=s.getUint8(i.NIFTI2.MAGIC_NUMBER_LOCATION+2),o===i.NIFTI2.MAGIC_NUMBER[0]&&r===i.NIFTI2.MAGIC_NUMBER[1]&&a===i.NIFTI2.MAGIC_NUMBER[2])},i.isNIFTI=function(n){return i.isNIFTI1(n)||i.isNIFTI2(n)},i.isCompressed=function(n){var s,o,r;return!!(n&&(s=new DataView(n),o=s.getUint8(0),r=s.getUint8(1),o===i.Utils.GUNZIP_MAGIC_COOKIE1||r===i.Utils.GUNZIP_MAGIC_COOKIE2))},i.decompress=function(n){return e.inflate(n).buffer},i.readHeader=function(n){var s=null;return i.isCompressed(n)&&(n=i.decompress(n)),i.isNIFTI1(n)?s=new i.NIFTI1:i.isNIFTI2(n)&&(s=new i.NIFTI2),s?s.readHeader(n):console.error("That file does not appear to be NIFTI!"),s},i.hasExtension=function(n){return n.extensionFlag[0]!=0},i.readImage=function(n,s){var o=n.vox_offset,r=1,a=1;n.dims[4]&&(r=n.dims[4]),n.dims[5]&&(a=n.dims[5]);var c=n.dims[1]*n.dims[2]*n.dims[3]*r*a*(n.numBitsPerVoxel/8);return s.slice(o,o+c)},i.readExtension=function(n,s){var o=n.getExtensionLocation(),r=n.extensionSize;return s.slice(o,o+r)},i.readExtensionData=function(n,s){var o=n.getExtensionLocation(),r=n.extensionSize;return s.slice(o+8,o+r-8)},t.exports&&(t.exports=i)})(Lt);var we,Au=new Uint8Array(16);function Su(){if(!we&&(we=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto!="undefined"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!we))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return we(Au)}var wu=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Iu(t){return typeof t=="string"&&wu.test(t)}var P=[];for(var ci=0;ci<256;++ci)P.push((ci+256).toString(16).substr(1));function Ru(t){var i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,e=(P[t[i+0]]+P[t[i+1]]+P[t[i+2]]+P[t[i+3]]+"-"+P[t[i+4]]+P[t[i+5]]+"-"+P[t[i+6]]+P[t[i+7]]+"-"+P[t[i+8]]+P[t[i+9]]+"-"+P[t[i+10]]+P[t[i+11]]+P[t[i+12]]+P[t[i+13]]+P[t[i+14]]+P[t[i+15]]).toLowerCase();if(!Iu(e))throw TypeError("Stringified UUID is invalid");return e}function Du(t,i,e){t=t||{};var n=t.random||(t.rng||Su)();if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,i){e=e||0;for(var s=0;s<16;++s)i[e+s]=n[s];return i}return Ru(n)}const wt=function(t){this.LOGGING_ON=!0,this.LOGGING_OFF=!1,this.LOG_PREFIX="NiiVue:",this.logLevel=t};wt.prototype.getTimeStamp=function(){return`${this.LOG_PREFIX} `};wt.prototype.debug=function(){this.logLevel===this.LOGGING_ON&&console.log(this.getTimeStamp(),"DEBUG",...arguments)};wt.prototype.info=function(){this.logLevel===this.LOGGING_ON&&console.log(this.getTimeStamp(),"INFO",...arguments)};wt.prototype.warn=function(){this.logLevel===this.LOGGING_ON&&console.warn(this.getTimeStamp(),"WARN",...arguments)};wt.prototype.error=function(){this.logLevel===this.LOGGING_ON&&console.error(this.getTimeStamp(),"ERROR",...arguments)};wt.prototype.setLogLevel=function(t){this.logLevel=t};const St=new wt;var N=function(t,i="",e="gray",n=1,s=!0,o=.02,r=!1,a=!0,c=!1){if(this.DT_NONE=0,this.DT_UNKNOWN=0,this.DT_BINARY=1,this.DT_UNSIGNED_CHAR=2,this.DT_SIGNED_SHORT=4,this.DT_SIGNED_INT=8,this.DT_FLOAT=16,this.DT_COMPLEX=32,this.DT_DOUBLE=64,this.DT_RGB=128,this.DT_ALL=255,this.DT_INT8=256,this.DT_UINT16=512,this.DT_UINT32=768,this.DT_INT64=1024,this.DT_UINT64=1280,this.DT_FLOAT128=1536,this.DT_COMPLEX128=1792,this.DT_COMPLEX256=2048,this.DT_RGBA32=2304,this.name=i,this.id=Du(),this.colorMap=e,this.opacity=n>1?1:n,this.percentileFrac=o,this.ignoreZeroVoxels=r,this.trustCalMinMax=s,this.visible=a,!t)return;this.hdr=Lt.exports.readHeader(t);function l(m){let _=[!1,!1,!1,!1],b=[!1,!1,!1,!1];for(let x=0;x<4;x++)for(let d=0;d<4;d++)if(isNaN(m[x][d]))return!1;for(let x=0;x<3;x++)for(let d=0;d<3;d++)m[x][d]!==0&&(_[x]=!0,b[d]=!0);for(let x=0;x<3;x++)if(!_[x]||!b[x])return!1;return!0}(isNaN(this.hdr.scl_slope)||this.hdr.scl_slope===0)&&(this.hdr.scl_slope=1),isNaN(this.hdr.scl_inter)&&(this.hdr.scl_inter=0);let h=l(this.hdr.affine);if(c||!h||this.hdr.qform_code>this.hdr.sform_code){St.debug("spatial transform based on QForm");const m=this.hdr.quatern_b,_=this.hdr.quatern_c,b=this.hdr.quatern_d,x=Math.sqrt(1-(Math.pow(m,2)+Math.pow(_,2)+Math.pow(b,2))),d=this.hdr.pixDims[0]===0?1:this.hdr.pixDims[0],E=[[x*x+m*m-_*_-b*b,2*m*_-2*x*b,2*m*b+2*x*_],[2*m*_+2*x*b,x*x+_*_-m*m-b*b,2*_*b-2*x*m],[2*m*b-2*x*_,2*_*b+2*x*m,x*x+b*b-_*_-m*m]],A=this.hdr.affine;for(let T=0;T<3;T+=1)for(let I=0;I<3;I+=1)A[T][I]=E[T][I]*this.hdr.pixDims[I+1],I===2&&(A[T][I]*=d);A[0][3]=this.hdr.qoffset_x,A[1][3]=this.hdr.qoffset_y,A[2][3]=this.hdr.qoffset_z,this.hdr.affine=A}if(h=l(this.hdr.affine),!h){St.debug("Defective NIfTI: spatial transform does not make sense");let m=this.hdr.pixDims[1],_=this.hdr.pixDims[2],b=this.hdr.pixDims[3];(isNaN(m)||m===0)&&(m=1),(isNaN(_)||_===0)&&(_=1),(isNaN(b)||b===0)&&(b=1),this.hdr.pixDims[1]=m,this.hdr.pixDims[2]=_,this.hdr.pixDims[3]=b;const x=[[m,0,0,0],[0,_,0,0],[0,0,b,0],[0,0,0,1]];this.hdr.affine=x}let p=null;switch(Lt.exports.isCompressed(t)?p=Lt.exports.readImage(this.hdr,Lt.exports.decompress(t)):p=Lt.exports.readImage(this.hdr,t),this.hdr.datatypeCode){case this.DT_UNSIGNED_CHAR:this.img=new Uint8Array(p);break;case this.DT_SIGNED_SHORT:this.img=new Int16Array(p);break;case this.DT_FLOAT:this.img=new Float32Array(p);break;case this.DT_DOUBLE:this.img=new Float64Array(p);break;case this.DT_RGB:this.img=new Uint8Array(p);break;case this.DT_UINT16:this.img=new Uint16Array(p);break;case this.DT_RGBA32:this.img=new Uint8Array(p);break;case this.DT_INT8:let m=new Int8Array(p);var f=m.length;this.img=new Int16Array(f);for(var u=0;u<f-1;u++)this.img[u]=m[u];this.hdr.datatypeCode=this.DT_SIGNED_SHORT;break;case this.DT_UINT32:let _=new Uint32Array(p);var v=_.length;this.img=new Float64Array(v);for(var u=0;u<v-1;u++)this.img[u]=_[u];this.hdr.datatypeCode=this.DT_DOUBLE;break;case this.DT_SIGNED_INT:let b=new Int32Array(p);var g=b.length;this.img=new Float64Array(g);for(var u=0;u<g-1;u++)this.img[u]=b[u];this.hdr.datatypeCode=this.DT_DOUBLE;break;case this.DT_INT64:let x=new BigInt64Array(p),d=x.length;this.img=new Float64Array(d);for(var u=0;u<d-1;u++)this.img[u]=Number(x[u]);this.hdr.datatypeCode=this.DT_DOUBLE;break;default:throw"datatype "+this.hdr.datatypeCode+" not supported"}this.calculateRAS(),this.calMinMax()};N.prototype.calculateOblique=function(){let t=this.vox2mm([0,0,0],this.matRAS),i=this.vox2mm([1/this.pixDimsRAS[1],0,0],this.matRAS),e=this.vox2mm([0,1/this.pixDimsRAS[2],0],this.matRAS),n=this.vox2mm([0,0,1/this.pixDimsRAS[3]],this.matRAS);bt(i,i,t),bt(e,e,t),bt(n,n,t);let s=zt(i[0],i[1],i[2],0,e[0],e[1],e[2],0,n[0],n[1],n[2],0,0,0,0,1);this.obliqueRAS=K(s);let o=Math.abs(90-Ze(i,e)*(180/Math.PI)),r=Math.abs(90-Ze(i,n)*(180/Math.PI)),a=Math.abs(90-Ze(e,n)*(180/Math.PI)),c=Math.max(Math.max(o,r),a);c>.1&&St.debug("Warning: shear detected (gantry tilt) of %f degrees",c)};N.prototype.calculateRAS=function(){let t=this.hdr.affine,i=this.hdr,e=zs(Math.abs(t[0][0]),Math.abs(t[0][1]),Math.abs(t[0][2]),Math.abs(t[1][0]),Math.abs(t[1][1]),Math.abs(t[1][2]),Math.abs(t[2][0]),Math.abs(t[2][1]),Math.abs(t[2][2])),n=[1,1,1];e[3]>e[0]&&(n[0]=2),e[6]>e[0]&&e[6]>e[3]&&(n[0]=3),n[1]=1,n[0]===1?e[4]>e[7]?n[1]=2:n[1]=3:n[0]===2?e[1]>e[7]?n[1]=1:n[1]=3:e[1]>e[4]?n[1]=1:n[1]=2,n[2]=6-n[1]-n[0];let s=[1,2,3];s[n[0]-1]=1,s[n[1]-1]=2,s[n[2]-1]=3;let o=zt(t[0][0],t[0][1],t[0][2],t[0][3],t[1][0],t[1][1],t[1][2],t[1][3],t[2][0],t[2][1],t[2][2],t[2][3],0,0,0,1);this.mm000=this.vox2mm([-.5,-.5,-.5],o),this.mm100=this.vox2mm([i.dims[1]-.5,-.5,-.5],o),this.mm010=this.vox2mm([-.5,i.dims[2]-.5,-.5],o),this.mm001=this.vox2mm([-.5,-.5,i.dims[3]-.5],o);let r=it();Gs(r,o);for(let l=0;l<3;l++)for(let h=0;h<3;h++)r[l*4+h]=o[l*4+s[h]-1];let a=[0,0,0];if(r[0]<0&&(a[0]=1),r[5]<0&&(a[1]=1),r[10]<0&&(a[2]=1),this.dimsRAS=[i.dims[0],i.dims[s[0]],i.dims[s[1]],i.dims[s[2]]],this.pixDimsRAS=[i.pixDims[0],i.pixDims[s[0]],i.pixDims[s[1]],i.pixDims[s[2]]],this.arrayEquals(s,[1,2,3])&&this.arrayEquals(a,[0,0,0])){this.toRAS=it(),this.matRAS=K(o),this.calculateOblique();return}Vs(o),o[0+0*4]=1-a[0]*2,o[1+1*4]=1-a[1]*2,o[2+2*4]=1-a[2]*2,o[3+0*4]=(i.dims[s[0]]-1)*a[0],o[3+1*4]=(i.dims[s[1]]-1)*a[1],o[3+2*4]=(i.dims[s[2]]-1)*a[2];let c=it();Gt(c,o),Be(c,c,r),this.matRAS=K(c),o=zt(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1),o[s[0]-1+0*4]=-a[0]*2+1,o[s[1]-1+1*4]=-a[1]*2+1,o[s[2]-1+2*4]=-a[2]*2+1,o[3+0*4]=a[0],o[3+1*4]=a[1],o[3+2*4]=a[2],this.toRAS=K(o),St.debug(this.hdr.dims),St.debug(this.dimsRAS),this.calculateOblique()};N.prototype.vox2mm=function(t,i){let e=K(i);ue(e,e);let n=yt(t[0],t[1],t[2],1);return Zt(n,n,e),z(n[0],n[1],n[2])};N.prototype.mm2vox=function(t){let i=zt(...this.hdr.affine.flat()),e=K(i);ue(e,i),Gt(e,e);let n=yt(t[0],t[1],t[2],1);Zt(n,n,e);let s=z(n[0],n[1],n[2]);return[Math.round(s[0]),Math.round(s[1]),Math.round(s[2])]};N.prototype.arrayEquals=function(t,i){return Array.isArray(t)&&Array.isArray(i)&&t.length===i.length&&t.every((e,n)=>e===i[n])};N.prototype.colorMaps=function(t=!0){let i=[];for(const[e]of Object.entries($))i.push(e);return t===!0?i.sort():i};N.prototype.calMinMax=function(){if(this.trustCalMinMax&&isFinite(this.hdr.cal_min)&&isFinite(this.hdr.cal_max)&&this.hdr.cal_max>this.hdr.cal_min)return this.cal_min=this.hdr.cal_min,this.cal_max=this.hdr.cal_max,this.robust_min=this.cal_min,this.robust_max=this.cal_max,this.global_min=this.hdr.cal_min,this.global_max=this.hdr.cal_max,[this.hdr.cal_min,this.hdr.cal_max,this.hdr.cal_min,this.hdr.cal_max];let t=this.colorMap,i=this.colorMaps(),e=0,n=0;if(i.indexOf(t.toLowerCase())!=-1&&(e=$[t.toLowerCase()].min,n=$[t.toLowerCase()].max),e!=n)return this.cal_min=e,this.cal_max=n,this.robust_min=this.cal_min,this.robust_max=this.cal_max,[e,n,e,n];let s=this.img[0],o=this.img[0],r=0,a=0,c=this.img.length;for(let d=0;d<c;d++){if(isNaN(this.img[d])){a++;continue}this.img[d]===0&&(r++,this.ignoreZeroVoxels)||(s=Math.min(this.img[d],s),o=Math.max(this.img[d],o))}var l=this.intensityRaw2Scaled(this.hdr,s),h=this.intensityRaw2Scaled(this.hdr,o);this.ignoreZeroVoxels||(r=0),r+=a;let p=Math.round((c-r)*this.percentileFrac);if(p<1||s===o)return St.debug("no variability in image intensity?"),this.cal_min=l,this.cal_max=h,this.robust_min=this.cal_min,this.robust_max=this.cal_max,this.global_min=l,this.global_max=h,[l,h,l,h];let f=1001,u=(f-1)/(o-s),v=new Array(f);for(let d=0;d<f;d++)v[d]=0;if(this.ignoreZeroVoxels)for(let d=0;d<=c;d++)this.img[d]!==0&&(isNaN(this.img[d])||v[Math.round((this.img[d]-s)*u)]++);else for(let d=0;d<=c;d++)isNaN(this.img[d])||v[Math.round((this.img[d]-s)*u)]++;let g=0,m=0;for(;g<p;)g+=v[m],m++;m--,g=0;let _=f;for(;g<p;)_--,g+=v[_];if(m==_){let d=-1;for(;d!==0;)m>0&&(m--,v[m]>0&&(d=0)),d!=0&&_<f-1&&(_++,v[_]>0&&(d=0)),m==0&&_==f-1&&(d=0)}var b=this.intensityRaw2Scaled(this.hdr,m/u+s),x=this.intensityRaw2Scaled(this.hdr,_/u+s);return this.hdr.cal_min<this.hdr.cal_max&&this.hdr.cal_min>=l&&this.hdr.cal_max<=h&&(b=this.hdr.cal_min,x=this.hdr.cal_max),this.cal_min=b,this.cal_max=x,this.robust_min=this.cal_min,this.robust_max=this.cal_max,this.global_min=l,this.global_max=h,[b,x,l,h]};N.prototype.intensityRaw2Scaled=function(t,i){return t.scl_slope===0&&(t.scl_slope=1),i*t.scl_slope+t.scl_inter};N.loadFromUrl=async function(t,i="",e="gray",n=1,s=!0,o=.02,r=!1,a=!0){let c=await fetch(t),l=null;if(!c.ok)throw Error(c.statusText);i=t.split("/").slice(-1)[0];let p=await c.arrayBuffer();return p?l=new N(p,i,e,n,s,o,r,a):alert("Unable to load buffer properly from volume"),l};N.readFileAsync=function(t){return new Promise((i,e)=>{let n=new FileReader;n.onload=()=>{i(n.result)},n.onerror=e,n.readAsArrayBuffer(t)})};N.loadFromFile=async function(t,i="",e="gray",n=1,s=!0,o=.02,r=!1,a=!0){let c=null;try{let l=await this.readFileAsync(t);c=new N(l,i,e,n,s,o,r,a)}catch(l){St.debug(l)}return c};N.prototype.clone=function(){let t=new N;return t.id=this.id,t.hdr=Object.assign({},this.hdr),t.img=this.img.slice(),t.calculateRAS(),t.calMinMax(),t};N.prototype.zeroImage=function(){this.img.fill(0)};N.prototype.getImageMetadata=function(){const t=this.id,i=this.hdr.datatypeCode,e=this.hdr.dims,n=e[1],s=e[2],o=e[3],r=Math.max(1,e[4]),a=this.hdr.pixDims,c=a[1],l=a[2],h=a[3],p=a[4],f=Math.floor(this.hdr.numBitsPerVoxel/8);return{id:t,datatypeCode:i,nx:n,ny:s,nz:o,nt:r,dx:c,dy:l,dz:h,dt:p,bpv:f}};N.zerosLike=function(t){let i=t.clone();return i.zeroImage(),i};String.prototype.getBytes=function(){let t=[];for(var i=0;i<this.length;i++)t.push(this.charCodeAt(i));return t};N.prototype.getValue=function(t,i,e){const{nx:n,ny:s}=this.getImageMetadata();if(this.hdr.datatypeCode===this.DT_RGBA32){let r=4*(t+i*n+e*n*s);return Math.round(this.img[r]*.21+this.img[r+1]*.72+this.img[r+2]*.07)}if(this.hdr.datatypeCode===this.DT_RGB){let r=3*(t+i*n+e*n*s);return Math.round(this.img[r]*.21+this.img[r+1]*.72+this.img[r+2]*.07)}let o=this.img[t+i*n+e*n*s];return this.hdr.scl_slope*o+this.hdr.scl_inter};function Bu(t,i=!0){let e=(t.length/3).toFixed(),n=z(0,0,0),s=It(),o=It(),r=0,a=1;i&&(a=2);for(let p=0;p<a;p++){r=0;for(let u=0;u<e;u++){let v=z(t[u*3],t[u*3+1],t[u*3+2]);u===0&&(zi(s,v),zi(o,v)),Ys(s,s,v),js(o,o,v),bt(v,v,n);let g=Js(v);r=Math.max(r,g)}if(p+1>=a)break;let f=!0;for(let u=0;u<3;++u)s[u]>n[u]&&(f=!1),o[u]<n[u]&&(f=!1);if(f)break;Qs(n,s,o,.5),St.debug("origin moved inside volume: ",n)}let c=[s[0],s[1],s[2]],l=[o[0],o[1],o[2]];return{min:c,max:l,furthestVertexFromOrigin:r,origin:n}}N.prototype.toNiivueObject3D=function(t,i){let e=this.vox2mm([0,0,0],this.matRAS),n=this.vox2mm([0,this.dimsRAS[2]-1,0],this.matRAS),s=this.vox2mm([0,0,this.dimsRAS[3]-1],this.matRAS),o=this.vox2mm([0,this.dimsRAS[2]-1,this.dimsRAS[3]-1],this.matRAS),r=this.vox2mm([this.dimsRAS[1]-1,0,0],this.matRAS),a=this.vox2mm([this.dimsRAS[1]-1,this.dimsRAS[2]-1,0],this.matRAS),c=this.vox2mm([this.dimsRAS[1]-1,0,this.dimsRAS[3]-1],this.matRAS),l=this.vox2mm([this.dimsRAS[1]-1,this.dimsRAS[2]-1,this.dimsRAS[3]-1],this.matRAS);const h=[...s,...c,...l,...o,...e,...n,...a,...r],p=[0,0,1,1,0,1,1,1,1,0,1,1,0,0,0,0,1,0,1,1,0,1,0,0,0,1,0,0,1,1,1,1,1,1,1,0,0,0,0,1,0,0,1,0,1,0,0,1,1,0,0,1,1,0,1,1,1,1,0,1,0,0,0,0,0,1,0,1,1,0,1,0],f=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,f),i.bufferData(i.ARRAY_BUFFER,new Float32Array(h),i.STATIC_DRAW);const u=i.createBuffer();i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,u);const v=[0,3,2,2,1,0,4,7,6,6,5,4,5,6,2,2,3,5,4,0,1,1,7,4,7,1,2,2,6,7,4,5,3,3,0,4];i.bufferData(i.ELEMENT_ARRAY_BUFFER,new Uint16Array(v),i.STATIC_DRAW);const g=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,g),i.bufferData(i.ARRAY_BUFFER,new Float32Array(p),i.STATIC_DRAW);const m=new Y(t,f,i.TRIANGLES,v.length,u,g),_=Bu(h);return m.extentsMin=_.min,m.extentsMax=_.max,m.furthestVertexFromOrigin=_.furthestVertexFromOrigin,m.originNegate=Zs(_.origin),qs(m.originNegate,m.originNegate),m};var Ps="/niivue-bet/assets/Roboto-Regular.4f470182.png";const Fu={type:"msdf",distanceRange:2,size:59.65625,width:512,height:256,yOrigin:"bottom"},Nu={emSize:1,lineHeight:1.171875,ascender:.927734375,descender:-.244140625,underlineY:-.09765625,underlineThickness:.048828125},Cu=[{unicode:32,advance:.24755859375},{unicode:33,advance:.25732421875,planeBounds:{left:.056159633438645884,bottom:-.02437761405677056,right:.20702396031135412,top:.7299440203067705},atlasBounds:{left:488.5,bottom:145.5,right:497.5,top:190.5}},{unicode:34,advance:.31982421875,planeBounds:{left:.049409125974004715,bottom:.48691155587022,right:.2840869677759953,top:.77187750662978},atlasBounds:{left:486.5,bottom:213.5,right:500.5,top:230.5}},{unicode:35,advance:.61572265625,planeBounds:{left:.037219103997511785,bottom:-.02169206718177056,right:.6239137085024882,top:.7326295671817705},atlasBounds:{left:66.5,bottom:51.5,right:101.5,top:96.5}},{unicode:36,advance:.5615234375,planeBounds:{left:.02956531458715296,bottom:-.12381369908983761,right:.5324464041628472,top:.8484230740898377},atlasBounds:{left:109.5,bottom:197.5,right:139.5,top:255.5}},{unicode:37,advance:.732421875,planeBounds:{left:.026481776289942378,bottom:-.030073418674698794,right:.7137525987100576,top:.7410109186746989},atlasBounds:{left:88.5,bottom:144.5,right:129.5,top:190.5}},{unicode:38,advance:.62158203125,planeBounds:{left:.03225572125458355,bottom:-.030073418674698794,right:.6357130287454166,top:.7410109186746989},atlasBounds:{left:130.5,bottom:144.5,right:166.5,top:190.5}},{unicode:39,advance:.17431640625,planeBounds:{left:.028244602049502358,bottom:.49895501673814824,right:.14558352295049765,top:.7671582645118518},atlasBounds:{left:498.5,bottom:62.5,right:505.5,top:78.5}},{unicode:40,advance:.341796875,planeBounds:{left:.042983329377291775,bottom:-.250029542422407,right:.34471198312270823,top:.8227834486724072},atlasBounds:{left:.5,bottom:191.5,right:18.5,top:255.5}},{unicode:41,advance:.34765625,planeBounds:{left:-.003159248747708225,bottom:-.250029542422407,right:.29856940499770823,top:.8227834486724072},atlasBounds:{left:19.5,bottom:191.5,right:37.5,top:255.5}},{unicode:42,advance:.4306640625,planeBounds:{left:-.011208599684062338,bottom:.27785390031593765,right:.44138438093406235,top:.7304468809340623},atlasBounds:{left:449.5,bottom:23.5,right:476.5,top:50.5}},{unicode:43,advance:.56689453125,planeBounds:{left:.01353503347629649,bottom:.053493525733368255,right:.5499415290237036,top:.6066627242666317},atlasBounds:{left:361.5,bottom:17.5,right:393.5,top:50.5}},{unicode:44,advance:.1962890625,planeBounds:{left:-.009919475797210583,bottom:-.15981695975478,right:.1744702570472106,top:.12514899100478},atlasBounds:{left:498.5,bottom:79.5,right:509.5,top:96.5}},{unicode:45,advance:.27587890625,planeBounds:{left:-.00527594412977999,bottom:.24333249267450235,right:.27969000662978,top:.36067141357549765},atlasBounds:{left:52.5,bottom:7.5,right:69.5,top:14.5}},{unicode:46,advance:.26318359375,planeBounds:{left:.051032680313645884,bottom:-.027092319686354116,right:.20189700718635412,top:.12377200718635412},atlasBounds:{left:501.5,bottom:221.5,right:510.5,top:230.5}},{unicode:47,advance:.412109375,planeBounds:{left:-.013733006073205867,bottom:-.08573505127848349,right:.4053345685732059,top:.7356373950284835},atlasBounds:{left:252.5,bottom:206.5,right:277.5,top:255.5}},{unicode:48,advance:.5615234375,planeBounds:{left:.037458384830081196,bottom:-.030073418674698794,right:.5235767714199189,top:.7410109186746989},atlasBounds:{left:167.5,bottom:144.5,right:196.5,top:190.5}},{unicode:49,advance:.5615234375,planeBounds:{left:.06023674350936354,bottom:-.01998308280677056,right:.37872810024063647,top:.7343385515567705},atlasBounds:{left:488.5,bottom:97.5,right:507.5,top:142.5}},{unicode:50,advance:.5615234375,planeBounds:{left:.025334353719224725,bottom:-.01680925468177056,right:.5449781462807752,top:.7375123796817705},atlasBounds:{left:278.5,bottom:51.5,right:309.5,top:96.5}},{unicode:51,advance:.5615234375,planeBounds:{left:.028181041080081196,bottom:-.030073418674698794,right:.5142994276699189,top:.7410109186746989},atlasBounds:{left:197.5,bottom:144.5,right:226.5,top:190.5}},{unicode:52,advance:.5615234375,planeBounds:{left:.005886103858368255,bottom:-.02169206718177056,right:.5590553023916317,top:.7326295671817705},atlasBounds:{left:310.5,bottom:51.5,right:343.5,top:96.5}},{unicode:53,advance:.5615234375,planeBounds:{left:.055524791080081196,bottom:-.02657487968177056,right:.5416431776699189,top:.7277467546817705},atlasBounds:{left:344.5,bottom:51.5,right:373.5,top:96.5}},{unicode:54,advance:.5615234375,planeBounds:{left:.046003306705081196,bottom:-.034712090549698794,right:.5321216932949189,top:.7363722467996989},atlasBounds:{left:227.5,bottom:144.5,right:256.5,top:190.5}},{unicode:55,advance:.5615234375,planeBounds:{left:.018010134969224725,bottom:-.02169206718177056,right:.5376539275307752,top:.7326295671817705},atlasBounds:{left:374.5,bottom:51.5,right:405.5,top:96.5}},{unicode:56,advance:.5615234375,planeBounds:{left:.037702525455081196,bottom:-.030073418674698794,right:.5238209120449189,top:.7410109186746989},atlasBounds:{left:257.5,bottom:144.5,right:286.5,top:190.5}},{unicode:57,advance:.5615234375,planeBounds:{left:.029401744205081196,bottom:-.025434746799698794,right:.5155201307949189,top:.7456495905496989},atlasBounds:{left:287.5,bottom:144.5,right:316.5,top:190.5}},{unicode:58,advance:.2421875,planeBounds:{left:.046394008438645884,bottom:-.029431286627488215,right:.19725833531135412,top:.5572633178774882},atlasBounds:{left:439.5,bottom:61.5,right:448.5,top:96.5}},{unicode:59,advance:.21142578125,planeBounds:{left:.001066852327789419,bottom:-.16459733294591408,right:.1854565851722106,top:.556198895445914},atlasBounds:{left:406.5,bottom:53.5,right:417.5,top:96.5}},{unicode:60,advance:.50830078125,planeBounds:{left:.016948142433865897,bottom:.0726146348300812,right:.4527784200661341,top:.5587330214199189},atlasBounds:{left:394.5,bottom:21.5,right:420.5,top:50.5}},{unicode:61,advance:.548828125,planeBounds:{left:.051535540940937666,bottom:.17620354038436353,right:.5041285215590624,top:.49469489711563647},atlasBounds:{left:477.5,bottom:31.5,right:504.5,top:50.5}},{unicode:62,advance:.5224609375,planeBounds:{left:.047629290940937666,bottom:.0731029160800812,right:.5002222715590624,top:.5592213026699189},atlasBounds:{left:421.5,bottom:21.5,right:448.5,top:50.5}},{unicode:63,advance:.47216796875,planeBounds:{left:.016704001808865897,bottom:-.027876153049698794,right:.4525342794411341,top:.7432081842996989},atlasBounds:{left:317.5,bottom:144.5,right:343.5,top:190.5}},{unicode:64,advance:.89794921875,planeBounds:{left:.034064457306783605,bottom:-.23896750384690937,right:.8721996065996072,top:.7165065663469093},atlasBounds:{left:155.5,bottom:198.5,right:205.5,top:255.5}},{unicode:65,advance:.65234375,planeBounds:{left:-.008838044092129387,bottom:-.02169206718177056,right:.6616700753421295,top:.7326295671817705},atlasBounds:{left:237.5,bottom:51.5,right:277.5,top:96.5}},{unicode:66,advance:.62255859375,planeBounds:{left:.06464099434422473,bottom:-.02169206718177056,right:.5842847869057752,top:.7326295671817705},atlasBounds:{left:205.5,bottom:51.5,right:236.5,top:96.5}},{unicode:67,advance:.65087890625,planeBounds:{left:.038439807122511785,bottom:-.030073418674698794,right:.6251344116274882,top:.7410109186746989},atlasBounds:{left:344.5,bottom:144.5,right:379.5,top:190.5}},{unicode:68,advance:.65576171875,planeBounds:{left:.06301501010836826,bottom:-.02169206718177056,right:.6161842086416317,top:.7326295671817705},atlasBounds:{left:162.5,bottom:51.5,right:195.5,top:96.5}},{unicode:69,advance:.568359375,planeBounds:{left:.0652904160800812,bottom:-.02169206718177056,right:.5514088026699189,top:.7326295671817705},atlasBounds:{left:132.5,bottom:51.5,right:161.5,top:96.5}},{unicode:70,advance:.552734375,planeBounds:{left:.059675181705081196,bottom:-.02169206718177056,right:.5457935682949189,top:.7326295671817705},atlasBounds:{left:102.5,bottom:51.5,right:131.5,top:96.5}},{unicode:71,advance:.68115234375,planeBounds:{left:.040148791497511785,bottom:-.030073418674698794,right:.6268433960024882,top:.7410109186746989},atlasBounds:{left:380.5,bottom:144.5,right:415.5,top:190.5}},{unicode:72,advance:.712890625,planeBounds:{left:.062365588372511785,bottom:-.02169206718177056,right:.6490601928774882,top:.7326295671817705},atlasBounds:{left:30.5,bottom:51.5,right:65.5,top:96.5}},{unicode:73,advance:.27197265625,planeBounds:{left:.06917965680657412,bottom:-.02169206718177056,right:.20328128069342588,top:.7326295671817705},atlasBounds:{left:196.5,bottom:51.5,right:204.5,top:96.5}},{unicode:74,advance:.5517578125,planeBounds:{left:.007184947330081194,bottom:-.02657487968177056,right:.4933033339199188,top:.7277467546817705},atlasBounds:{left:.5,bottom:51.5,right:29.5,top:96.5}},{unicode:75,advance:.626953125,planeBounds:{left:.061633166497511785,bottom:-.02169206718177056,right:.6483277710024882,top:.7326295671817705},atlasBounds:{left:452.5,bottom:97.5,right:487.5,top:142.5}},{unicode:76,advance:.5380859375,planeBounds:{left:.06341786132300943,bottom:-.02169206718177056,right:.5327735449269906,top:.7326295671817705},atlasBounds:{left:423.5,bottom:97.5,right:451.5,top:142.5}},{unicode:77,advance:.873046875,planeBounds:{left:.05911847969322944,bottom:-.02169206718177056,right:.8134401140567705,top:.7326295671817705},atlasBounds:{left:377.5,bottom:97.5,right:422.5,top:142.5}},{unicode:78,advance:.712890625,planeBounds:{left:.062365588372511785,bottom:-.02169206718177056,right:.6490601928774882,top:.7326295671817705},atlasBounds:{left:341.5,bottom:97.5,right:376.5,top:142.5}},{unicode:79,advance:.6875,planeBounds:{left:.033395854136655315,bottom:-.030073418674698794,right:.6536158646133446,top:.7410109186746989},atlasBounds:{left:416.5,bottom:144.5,right:453.5,top:190.5}},{unicode:80,advance:.630859375,planeBounds:{left:.061550166358368255,bottom:-.02169206718177056,right:.6147193648916317,top:.7326295671817705},atlasBounds:{left:273.5,bottom:97.5,right:306.5,top:142.5}},{unicode:81,advance:.6875,planeBounds:{left:.030466166636655315,bottom:-.14391866037519643,right:.6506861771133446,top:.7445045978751964},atlasBounds:{left:214.5,bottom:202.5,right:251.5,top:255.5}},{unicode:82,advance:.61572265625,planeBounds:{left:.06350329135836826,bottom:-.02169206718177056,right:.6166724898916317,top:.7326295671817705},atlasBounds:{left:186.5,bottom:97.5,right:219.5,top:142.5}},{unicode:83,advance:.59326171875,planeBounds:{left:.020778681983368255,bottom:-.030073418674698794,right:.5739478805166317,top:.7410109186746989},atlasBounds:{left:454.5,bottom:144.5,right:487.5,top:190.5}},{unicode:84,advance:.5966796875,planeBounds:{left:.005480822747511787,bottom:-.02169206718177056,right:.5921754272524882,top:.7326295671817705},atlasBounds:{left:112.5,bottom:97.5,right:147.5,top:142.5}},{unicode:85,advance:.6484375,planeBounds:{left:.049098994483368255,bottom:-.02657487968177056,right:.6022681930166317,top:.7277467546817705},atlasBounds:{left:78.5,bottom:97.5,right:111.5,top:142.5}},{unicode:86,advance:.63623046875,planeBounds:{left:-.008269192599201152,bottom:-.02169206718177056,right:.6454762238492011,top:.7326295671817705},atlasBounds:{left:38.5,bottom:97.5,right:77.5,top:142.5}},{unicode:87,advance:.88720703125,planeBounds:{left:.011923628617731797,bottom:-.02169206718177056,right:.8835841838822683,top:.7326295671817705},atlasBounds:{left:220.5,bottom:97.5,right:272.5,top:142.5}},{unicode:88,advance:.626953125,planeBounds:{left:.004098979136655316,bottom:-.02169206718177056,right:.6243189896133446,top:.7326295671817705},atlasBounds:{left:.5,bottom:97.5,right:37.5,top:142.5}},{unicode:89,advance:.6005859375,planeBounds:{left:-.010793598988344685,bottom:-.02169206718177056,right:.6094264114883446,top:.7326295671817705},atlasBounds:{left:148.5,bottom:97.5,right:185.5,top:142.5}},{unicode:90,advance:.5986328125,planeBounds:{left:.024196650733368255,bottom:-.02169206718177056,right:.5773658492666317,top:.7326295671817705},atlasBounds:{left:307.5,bottom:97.5,right:340.5,top:142.5}},{unicode:91,advance:.26513671875,planeBounds:{left:.05437250871693295,bottom:-.17280296457569408,right:.27228764753306706,top:.8329592145756942},atlasBounds:{left:59.5,bottom:195.5,right:72.5,top:255.5}},{unicode:92,advance:.41015625,planeBounds:{left:.0014037126767941326,bottom:-.08573505127848349,right:.4204712873232059,top:.7356373950284835},atlasBounds:{left:278.5,bottom:206.5,right:303.5,top:255.5}},{unicode:93,advance:.26513671875,planeBounds:{left:-.020659233400995285,bottom:-.17280296457569408,right:.2140186084009953,top:.8329592145756942},atlasBounds:{left:94.5,bottom:195.5,right:108.5,top:255.5}},{unicode:94,advance:.41796875,planeBounds:{left:.006855376669722368,bottom:.33229482979472236,right:.40916024833027764,top:.7345997014552776},atlasBounds:{left:486.5,bottom:231.5,right:510.5,top:255.5}},{unicode:95,advance:.451171875,planeBounds:{left:-.017473255794918804,bottom:-.09553469482549765,right:.4686451307949188,top:.021804226075497646},atlasBounds:{left:70.5,bottom:7.5,right:99.5,top:14.5}},{unicode:96,advance:.30908203125,planeBounds:{left:.00391839948107648,bottom:.5860277898277895,right:.2553589442689235,top:.7704175226722105},atlasBounds:{left:36.5,bottom:3.5,right:51.5,top:14.5}},{unicode:97,advance:.5439453125,planeBounds:{left:.028181041080081196,bottom:-.029187146002488215,right:.5142994276699189,top:.5575074585024882},atlasBounds:{left:30.5,bottom:15.5,right:59.5,top:50.5}},{unicode:98,advance:.56103515625,planeBounds:{left:.048932994205081196,bottom:-.032187684160555265,right:.5350513807949189,top:.7724220591605554},atlasBounds:{left:304.5,bottom:207.5,right:333.5,top:255.5}},{unicode:99,advance:.5234375,planeBounds:{left:.024518931705081196,bottom:-.029187146002488215,right:.5106373182949189,top:.5575074585024882},atlasBounds:{left:.5,bottom:15.5,right:29.5,top:50.5}},{unicode:100,advance:.56396484375,planeBounds:{left:.026227916080081196,bottom:-.032187684160555265,right:.5123463026699189,top:.7724220591605554},atlasBounds:{left:334.5,bottom:207.5,right:363.5,top:255.5}},{unicode:101,advance:.52978515625,planeBounds:{left:.026472056705081196,bottom:-.029187146002488215,right:.5125904432949189,top:.5575074585024882},atlasBounds:{left:468.5,bottom:61.5,right:497.5,top:96.5}},{unicode:102,advance:.34716796875,planeBounds:{left:.004575110905578838,bottom:-.022177918535555265,right:.3733545765944212,top:.7824318247855554},atlasBounds:{left:364.5,bottom:207.5,right:386.5,top:255.5}},{unicode:103,advance:.56103515625,planeBounds:{left:.026960337955081196,bottom:-.22888445766762702,right:.5130787245449189,top:.558962582667627},atlasBounds:{left:28.5,bottom:143.5,right:57.5,top:190.5}},{unicode:104,advance:.55078125,planeBounds:{left:.049826556565937666,bottom:-.01892352016762703,right:.5024195371840624,top:.768923520167627},atlasBounds:{left:.5,bottom:143.5,right:27.5,top:190.5}},{unicode:105,advance:.24267578125,planeBounds:{left:.046882289688645884,bottom:-.01680925468177056,right:.19774661656135412,top:.7375123796817705},atlasBounds:{left:498.5,bottom:145.5,right:507.5,top:190.5}},{unicode:106,advance:.23876953125,planeBounds:{left:-.048979545900995285,bottom:-.2324562772148376,right:.1856982959009953,top:.7397804959648377},atlasBounds:{left:140.5,bottom:197.5,right:154.5,top:255.5}},{unicode:107,advance:.5068359375,planeBounds:{left:.044294322330081196,bottom:-.01892352016762703,right:.5304127089199189,top:.768923520167627},atlasBounds:{left:58.5,bottom:143.5,right:87.5,top:190.5}},{unicode:108,advance:.24267578125,planeBounds:{left:.05428707868157412,bottom:-.01892352016762703,right:.18838870256842588,top:.768923520167627},atlasBounds:{left:477.5,bottom:208.5,right:485.5,top:255.5}},{unicode:109,advance:.87646484375,planeBounds:{left:.04430890170737297,bottom:-.024304333502488215,right:.832155942042627,top:.5623902710024882},atlasBounds:{left:116.5,bottom:15.5,right:163.5,top:50.5}},{unicode:110,advance:.5517578125,planeBounds:{left:.049826556565937666,bottom:-.024304333502488215,right:.5024195371840624,top:.5623902710024882},atlasBounds:{left:60.5,bottom:15.5,right:87.5,top:50.5}},{unicode:111,advance:.5703125,planeBounds:{left:.025090213094224725,bottom:-.029187146002488215,right:.5447340056557752,top:.5575074585024882},atlasBounds:{left:193.5,bottom:15.5,right:224.5,top:50.5}},{unicode:112,advance:.56103515625,planeBounds:{left:.048444712955081196,bottom:-.22644305141762702,right:.5345630995449189,top:.561403988917627},atlasBounds:{left:447.5,bottom:208.5,right:476.5,top:255.5}},{unicode:113,advance:.568359375,planeBounds:{left:.025983775455081196,bottom:-.22644305141762702,right:.5121021620449189,top:.561403988917627},atlasBounds:{left:417.5,bottom:208.5,right:446.5,top:255.5}},{unicode:114,advance:.33837890625,planeBounds:{left:.045180595002291775,bottom:-.024304333502488215,right:.34690924874770823,top:.5623902710024882},atlasBounds:{left:449.5,bottom:61.5,right:467.5,top:96.5}},{unicode:115,advance:.515625,planeBounds:{left:.021669814448009427,bottom:-.029187146002488215,right:.4910254980519906,top:.5575074585024882},atlasBounds:{left:164.5,bottom:15.5,right:192.5,top:50.5}},{unicode:116,advance:.32666015625,planeBounds:{left:-.019433670483564695,bottom:-.02877457520298586,right:.3158203892335647,top:.675258950202986},atlasBounds:{left:418.5,bottom:54.5,right:438.5,top:96.5}},{unicode:117,advance:.55126953125,planeBounds:{left:.048117572190937666,bottom:-.034069958502488215,right:.5007105528090624,top:.5526246460024882},atlasBounds:{left:88.5,bottom:15.5,right:115.5,top:50.5}},{unicode:118,advance:.484375,planeBounds:{left:-.002092396419918806,bottom:-.02080579450955998,right:.4840259901699188,top:.5491261070095601},atlasBounds:{left:331.5,bottom:16.5,right:360.5,top:50.5}},{unicode:119,advance:.75146484375,planeBounds:{left:-.002649098431770561,bottom:-.02080579450955998,right:.7516725359317705,top:.5491261070095601},atlasBounds:{left:225.5,bottom:16.5,right:270.5,top:50.5}},{unicode:120,advance:.49560546875,planeBounds:{left:-.0046143729128470395,bottom:-.02080579450955998,right:.4982667166628471,top:.5491261070095601},atlasBounds:{left:300.5,bottom:16.5,right:330.5,top:50.5}},{unicode:121,advance:.47314453125,planeBounds:{left:-.007219349544918806,bottom:-.23645281704262702,right:.4788990370449188,top:.551394223292627},atlasBounds:{left:387.5,bottom:208.5,right:416.5,top:255.5}},{unicode:122,advance:.49560546875,planeBounds:{left:.018007705073009427,bottom:-.02080579450955998,right:.4873633886769906,top:.5491261070095601},atlasBounds:{left:271.5,bottom:16.5,right:299.5,top:50.5}},{unicode:123,advance:.33837890625,planeBounds:{left:.011572188891435306,bottom:-.20234398020069408,right:.3468262486085647,top:.8034181989506942},atlasBounds:{left:73.5,bottom:195.5,right:93.5,top:255.5}},{unicode:124,advance:.24365234375,planeBounds:{left:.06315671142450235,bottom:-.15466084787519643,right:.18049563232549765,top:.7337624103751964},atlasBounds:{left:206.5,bottom:202.5,right:213.5,top:255.5}},{unicode:125,advance:.33837890625,planeBounds:{left:-.010156326733564695,bottom:-.20234398020069408,right:.3250977329835647,top:.8034181989506942},atlasBounds:{left:38.5,bottom:195.5,right:58.5,top:255.5}},{unicode:126,advance:.68017578125,planeBounds:{left:.046984728997511785,bottom:.1766063915990047,right:.6336793335024882,top:.4112842334009953},atlasBounds:{left:.5,bottom:.5,right:35.5,top:14.5}}],Uu=[];var Ms={atlas:Fu,metrics:Nu,glyphs:Cu,kerning:Uu};const W=new wt,y=function(t={}){this.opts={},this.defaults={textHeight:.06,colorbarHeight:.05,crosshairWidth:1,show3Dcrosshair:!1,backColor:[0,0,0,1],crosshairColor:[1,0,0,1],selectionBoxColor:[1,1,1,.5],clipPlaneColor:[.7,0,.7,.5],colorBarMargin:.05,trustCalMinMax:!0,clipPlaneHotKey:"KeyC",viewModeHotKey:"KeyV",keyDebounceTime:50,isNearestInterpolation:!1,isAtlasOutline:!1,isRadiologicalConvention:!1,logging:!1,loadingText:"waiting for images...",dragAndDropEnabled:!0},this.canvas=null,this.gl=null,this.colormapTexture=null,this.volumeTexture=null,this.overlayTexture=null,this.sliceShader=null,this.lineShader=null,this.renderShader=null,this.pickingShader=null,this.colorbarShader=null,this.fontShader=null,this.passThroughShader=null,this.orientShaderAtlasU=null,this.orientShaderU=null,this.orientShaderI=null,this.orientShaderF=null,this.orientShaderRGBU=null,this.surfaceShader=null,this.crosshairs3D=null,this.pickingSurfaceShader=null,this.DEFAULT_FONT_GLYPH_SHEET=Ps,this.DEFAULT_FONT_METRICS=Ms,this.fontMets=null,this.sliceTypeAxial=0,this.sliceTypeCoronal=1,this.sliceTypeSagittal=2,this.sliceTypeMultiplanar=3,this.sliceTypeRender=4,this.sliceType=this.sliceTypeMultiplanar,this.scene={},this.syncOpts={},this.scene.renderAzimuth=110,this.scene.renderElevation=10,this.scene.crosshairPos=[.5,.5,.5],this.scene.clipPlane=[0,0,0,0],this.scene.clipPlaneDepthAziElev=[2,0,0],this.scene.mousedown=!1,this.scene.touchdown=!1,this.scene.mouseButtonLeft=0,this.scene.mouseButtonRight=2,this.scene.mouseButtonLeftDown=!1,this.scene.mouseButtonRightDown=!1,this.scene.mouseDepthPicker=!1,this.scene.prevX=0,this.scene.prevY=0,this.scene.currX=0,this.scene.currY=0,this.back={},this.overlays=[],this.volumes=[],this.backTexture=[],this.objectsToRender3D=[],this.volScaleMultiplier=1,this.volScale=[],this.vox=[],this.mousePos=[0,0],this.numScreenSlices=0,this.screenSlices=[{leftTopWidthHeight:[1,0,0,1],axCorSag:this.sliceTypeAxial},{leftTopWidthHeight:[1,0,0,1],axCorSag:this.sliceTypeAxial},{leftTopWidthHeight:[1,0,0,1],axCorSag:this.sliceTypeAxial},{leftTopWidthHeight:[1,0,0,1],axCorSag:this.sliceTypeAxial}],this.isDragging=!1,this.dragStart=[0,0],this.dragEnd=[0,0],this.dragClipPlaneStartDepthAziElev=[0,0,0],this.lastTwoTouchDistance=0,this.otherNV=null,this.volumeObject3D=null,this.intensityRange$=new Re,this.scene.location$=new Re,this.scene.loading$=new Re,this.currentClipPlaneIndex=0,this.lastCalled=new Date().getTime(),this.multiTouchGesture=!1,this.gestureInterval=null,this.selectedObjectId=-1,this.CLIP_PLANE_ID=1,this.VOLUME_ID=254,this.DISTANCE_FROM_CAMERA=-.54,this.initialized=!1;for(let i in this.defaults)this.opts[i]=t[i]===void 0?this.defaults[i]:t[i];this.loadingText=this.opts.loadingText,W.setLogLevel(this.opts.logging),this.eventsToSubjects={location:this.scene.location$,loading:this.scene.loading$},this.subscriptions=[]};y.prototype.attachTo=async function(t){return await this.attachToCanvas(document.getElementById(t)),W.debug("attached to element with id: ",t),this};y.prototype.on=function(t,i){if(Object.keys(this.eventsToSubjects).indexOf(t)==-1)return;let s=this.eventsToSubjects[t].subscribe({next:o=>i(o)});this.subscriptions.push({[t]:s})};y.prototype.off=function(t){if(Object.keys(this.eventsToSubjects).indexOf(t)==-1)return;let e=this.subscriptions.length;for(let n=0;n<e;n++)if(Object.keys(this.subscriptions[n])[0]===t){this.subscriptions[n][t].unsubscribe(),this.subscriptions.splice(n,1);return}};y.prototype.attachToCanvas=async function(t){return this.canvas=t,this.gl=this.canvas.getContext("webgl2"),this.gl||(alert("unable to get webgl2 context. Perhaps this browser does not support webgl2"),W.warn("unable to get webgl2 context. Perhaps this browser does not support webgl2")),this.canvas.parentElement.style.backgroundColor="black",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,window.addEventListener("resize",this.resizeListener.bind(this)),this.registerInteractions(),await this.init(),this.drawScene(),this};y.prototype.syncWith=function(t,i={"2d":!0,"3d":!0}){this.otherNV=t,this.syncOpts=i};y.prototype.sync=function(){if(!this.otherNV||typeof this.otherNV=="undefined")return;let t=this.frac2mm(this.scene.crosshairPos);this.syncOpts["2d"]&&(this.otherNV.scene.crosshairPos=this.otherNV.mm2frac(t)),this.syncOpts["3d"]&&(this.otherNV.scene.renderAzimuth=this.scene.renderAzimuth,this.otherNV.scene.renderElevation=this.scene.renderElevation),this.otherNV.drawScene()};y.prototype.arrayEquals=function(t,i){return Array.isArray(t)&&Array.isArray(i)&&t.length===i.length&&t.every((e,n)=>e===i[n])};y.prototype.resizeListener=function(){this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight,this.drawScene()};y.prototype.getRelativeMousePosition=function(t,i){i=i||t.target;var e=i.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}};y.prototype.getNoPaddingNoBorderCanvasRelativeMousePosition=function(t,i){i=i||t.target;var e=this.getRelativeMousePosition(t,i);return e.x=e.x*i.width/i.clientWidth,e.y=e.y*i.height/i.clientHeight,e};y.prototype.mouseContextMenuListener=function(t){t.preventDefault()};y.prototype.mouseDownListener=function(t){t.preventDefault(),this.scene.mousedown=!0,t.button===this.scene.mouseButtonLeft?(this.scene.mouseButtonLeftDown=!0,this.mouseLeftButtonHandler(t)):t.button===this.scene.mouseButtonRight&&(this.scene.mouseButtonRightDown=!0,this.mouseRightButtonHandler(t))};y.prototype.mouseLeftButtonHandler=function(t){let i=this.getNoPaddingNoBorderCanvasRelativeMousePosition(t,this.gl.canvas);this.mouseClick(i.x,i.y),this.mouseDown(i.x,i.y)};y.prototype.mouseRightButtonHandler=function(t){this.isDragging=!0;let i=this.getNoPaddingNoBorderCanvasRelativeMousePosition(t,this.gl.canvas);this.dragStart[0]=i.x,this.dragStart[1]=i.y,this.dragClipPlaneStartDepthAziElev=this.scene.clipPlaneDepthAziElev};y.prototype.calculateMinMaxVoxIdx=function(t){if(t.length>2)throw new Error("array must not contain more than two values");return[Math.floor(Math.min(t[0],t[1])),Math.floor(Math.max(t[0],t[1]))]};function Pn(t,i){return t.scl_slope===0&&(t.scl_slope=1),i*t.scl_slope+t.scl_inter}y.prototype.calculateNewRange=function(t=0){if(this.sliceType===this.sliceTypeRender||this.dragStart[0]===this.dragEnd[0]&&this.dragStart[1]===this.dragEnd[1])return;let i=this.canvasPos2frac([this.dragStart[0],this.dragStart[1]]),e=this.frac2vox(i,t);i=this.canvasPos2frac([this.dragEnd[0],this.dragEnd[1]]);let n=this.frac2vox(i,t),s=-Number.MAX_VALUE,o=Number.MAX_VALUE,r,a,c;r=this.calculateMinMaxVoxIdx([e[0],n[0]]),a=this.calculateMinMaxVoxIdx([e[1],n[1]]),c=this.calculateMinMaxVoxIdx([e[2],n[2]]),e[0]-n[0]===0?r[1]=e[0]+1:e[1]-n[1]===0?a[1]=e[1]+1:e[2]-n[2]===0&&(c[1]=e[2]+1);const l=this.volumes[t].hdr,h=this.volumes[t].img,p=l.dims[1],f=l.dims[2];for(let g=c[0];g<c[1];g++){let m=g*p*f;for(let _=a[0];_<a[1];_++){let b=_*p;for(let x=r[0];x<r[1];x++){let d=m+b+x;o>h[d]&&(o=h[d]),s<h[d]&&(s=h[d])}}}if(!(o>=s)){var u=Pn(l,o),v=Pn(l,s);this.volumes[t].cal_min=u,this.volumes[t].cal_max=v,this.intensityRange$.next([u,v])}};y.prototype.mouseUpListener=function(){this.scene.mousedown=!1,this.scene.mouseButtonRightDown=!1,this.scene.mouseButtonLeftDown=!1,this.isDragging&&(this.isDragging=!1,this.calculateNewRange(),this.refreshLayers(this.volumes[0],0,this.volumes.length)),this.drawScene()};y.prototype.checkMultitouch=function(t){if(this.scene.touchdown&&!this.multiTouchGesture){var i=this.canvas.getBoundingClientRect();this.mouseClick(t.touches[0].clientX-i.left,t.touches[0].clientY-i.top),this.mouseDown(t.touches[0].clientX-i.left,t.touches[0].clientY-i.top)}};y.prototype.touchStartListener=function(t){t.preventDefault(),this.scene.touchdown=!0,this.scene.touchdown&&t.touches.length<2?this.multiTouchGesture=!1:this.multiTouchGesture=!0,setTimeout(this.checkMultitouch.bind(this),1,t)};y.prototype.touchEndListener=function(){this.scene.touchdown=!1,this.lastTwoTouchDistance=0,this.multiTouchGesture=!1};y.prototype.mouseMoveListener=function(t){if(this.scene.mousedown){let i=this.getNoPaddingNoBorderCanvasRelativeMousePosition(t,this.gl.canvas);this.scene.mouseButtonLeftDown?(this.mouseClick(i.x,i.y),this.mouseMove(i.x,i.y)):this.scene.mouseButtonRightDown&&(this.dragEnd[0]=i.x,this.dragEnd[1]=i.y),this.drawScene(),this.scene.prevX=this.scene.currX,this.scene.prevY=this.scene.currY}};y.prototype.resetBriCon=function(){if(this.sliceType===this.sliceTypeRender){this.scene.mouseDepthPicker=!0,this.drawScene();return}this.volumes[0].cal_min=this.volumes[0].robust_min,this.volumes[0].cal_max=this.volumes[0].robust_max,this.refreshLayers(this.volumes[0],0,this.volumes.length),this.drawScene()};y.prototype.touchMoveListener=function(t){if(this.scene.touchdown&&t.touches.length<2){var i=this.canvas.getBoundingClientRect();this.mouseClick(t.touches[0].clientX-i.left,t.touches[0].clientY-i.top),this.mouseMove(t.touches[0].clientX-i.left,t.touches[0].clientY-i.top)}else this.handlePinchZoom(t)};y.prototype.handlePinchZoom=function(t){if(t.targetTouches.length==2&&t.changedTouches.length==2){var i=Math.hypot(t.touches[0].pageX-t.touches[1].pageX,t.touches[0].pageY-t.touches[1].pageY),e=this.canvas.getBoundingClientRect();this.mousePos=[t.touches[0].clientX-e.left,t.touches[0].clientY-e.top],i<this.lastTwoTouchDistance?this.sliceScroll2D(-.01,t.touches[0].clientX-e.left,t.touches[0].clientY-e.top):this.sliceScroll2D(.01,t.touches[0].clientX-e.left,t.touches[0].clientY-e.top),this.lastTwoTouchDistance=i}};y.prototype.keyUpListener=function(t){if(t.code===this.opts.clipPlaneHotKey){if(this.sliceType!=this.sliceTypeRender)return;let i=new Date().getTime();if(i-this.lastCalled>this.opts.keyDebounceTime){switch(this.currentClipPlaneIndex=(this.currentClipPlaneIndex+1)%7,this.currentClipPlaneIndex){case 0:this.scene.clipPlaneDepthAziElev=[2,0,0];break;case 1:this.scene.clipPlaneDepthAziElev=[0,270,0];break;case 2:this.scene.clipPlaneDepthAziElev=[0,90,0];break;case 3:this.scene.clipPlaneDepthAziElev=[0,0,0];break;case 4:this.scene.clipPlaneDepthAziElev=[0,180,0];break;case 5:this.scene.clipPlaneDepthAziElev=[0,0,-90];break;case 6:this.scene.clipPlaneDepthAziElev=[0,0,90];break}this.clipPlaneUpdate(this.scene.clipPlaneDepthAziElev)}this.lastCalled=i}else if(t.code===this.opts.viewModeHotKey){let i=new Date().getTime();i-this.lastCalled>this.opts.keyDebounceTime&&(this.setSliceType((this.sliceType+1)%5),this.lastCalled=i)}};y.prototype.wheelListener=function(t){t.preventDefault(),t.stopPropagation();var i=this.canvas.getBoundingClientRect();t.deltaY<0?this.sliceScroll2D(-.01,t.clientX-i.left,t.clientY-i.top):this.sliceScroll2D(.01,t.clientX-i.left,t.clientY-i.top)};y.prototype.registerInteractions=function(){this.canvas.addEventListener("mousedown",this.mouseDownListener.bind(this)),this.canvas.addEventListener("mouseup",this.mouseUpListener.bind(this)),this.canvas.addEventListener("mousemove",this.mouseMoveListener.bind(this)),this.canvas.addEventListener("touchstart",this.touchStartListener.bind(this)),this.canvas.addEventListener("touchend",this.touchEndListener.bind(this)),this.canvas.addEventListener("touchmove",this.touchMoveListener.bind(this)),this.canvas.addEventListener("wheel",this.wheelListener.bind(this)),this.canvas.addEventListener("contextmenu",this.mouseContextMenuListener.bind(this)),this.canvas.addEventListener("dblclick",this.resetBriCon.bind(this)),this.canvas.addEventListener("dragenter",this.dragEnterListener.bind(this),!1),this.canvas.addEventListener("dragover",this.dragOverListener.bind(this),!1),this.canvas.addEventListener("drop",this.dropListener.bind(this),!1),this.canvas.setAttribute("tabindex",0),this.canvas.addEventListener("keyup",this.keyUpListener.bind(this),!1),this.canvas.focus()};y.prototype.dragEnterListener=function(t){t.stopPropagation(),t.preventDefault()};y.prototype.dragOverListener=function(t){t.stopPropagation(),t.preventDefault()};y.prototype.dropListener=async function(t){if(t.stopPropagation(),t.preventDefault(),!this.opts.dragAndDropEnabled)return;const i=t.dataTransfer,e=i.getData("text/uri-list");if(e){let n=await N.loadFromUrl(e);this.setVolume(n)}else{const n=i.files;if(n.length>0){this.volumes=[],this.overlays=[];let s=await N.loadFromFile(n[0]);this.setVolume(s)}}};y.prototype.setRadiologicalConvention=function(t){this.opts.isRadiologicalConvention=t};y.prototype.getRadiologicalConvention=function(){return this.opts.isRadiologicalConvention};y.prototype.addVolume=function(t){this.volumes.push(t);let i=this.volumes.length===1?1:this.volumes.length-1;this.setVolume(t,i)};y.prototype.getVolumeIndexByID=function(t){let i=this.volumes.length;for(let e=0;e<i;e++)if(this.volumes[e].id===t)return e;return-1};y.prototype.getOverlayIndexByID=function(t){let i=this.overlays.length;for(let e=0;e<i;e++)if(this.overlays[e].id===t)return e;return-1};y.prototype.setVolume=function(t,i=0){this.volumes.map(s=>{W.debug(s.name)});let e=this.volumes.length;if(i>e)return;let n=this.getVolumeIndexByID(t.id);i===0?(this.volumes.splice(n,1),this.volumes.unshift(t),this.back=this.volumes[0],this.overlays=this.volumes.slice(1)):i<0?(this.volumes.splice(this.getVolumeIndexByID(t.id),1),this.back=this.volumes[0],this.volumes.length>1?this.overlays=this.volumes.slice(1):this.overlays=[]):(this.volumes.splice(n,1),this.volumes.splice(i,0,t),this.overlays=this.volumes.slice(1),this.back=this.volumes[0]),this.updateGLVolume(),this.volumes.map(s=>{W.debug(s.name)})};y.prototype.removeVolume=function(t){this.setVolume(t,-1)};y.prototype.moveVolumeToBottom=function(t){this.setVolume(t,0)};y.prototype.moveVolumeUp=function(t){let i=this.getVolumeIndexByID(t.id);this.setVolume(t,i+1)};y.prototype.moveVolumeDown=function(t){let i=this.getVolumeIndexByID(t.id);this.setVolume(t,i-1)};y.prototype.moveVolumeToTop=function(t){this.setVolume(t,this.volumes.length-1)};y.prototype.mouseDown=function(i,e){this.sliceType==this.sliceTypeRender&&(this.mousePos=[i,e])};y.prototype.mouseMove=function(i,e){this.sliceType==this.sliceTypeRender&&(this.scene.renderAzimuth+=i-this.mousePos[0],this.scene.renderElevation+=e-this.mousePos[1],this.mousePos=[i,e],this.drawScene())};y.prototype.sph2cartDeg=function(i,e){let n=-e*(Math.PI/180),s=(i-90)%360*(Math.PI/180),o=[Math.cos(n)*Math.cos(s),Math.cos(n)*Math.sin(s),Math.sin(n)],r=Math.sqrt(o[0]*o[0]+o[1]*o[1]+o[2]*o[2]);return r<=0||(o[0]/=r,o[1]/=r,o[2]/=r),o};y.prototype.clipPlaneUpdate=function(t){if(this.sliceType!=this.sliceTypeRender)return;let i=this.sph2cartDeg(t[1]+180,t[2]);this.scene.clipPlane=[i[0],i[1],i[2],t[0]],this.drawScene()};y.prototype.setCrosshairColor=function(t){this.opts.crosshairColor=t,this.drawScene()};y.prototype.setSelectionBoxColor=function(t){this.opts.selectionBoxColor=t};y.prototype.sliceScroll2D=function(t,i,e,n=!0){this.mouseClick(i,e,t,n)};y.prototype.setSliceType=function(t){return this.sliceType=t,this.drawScene(),this};y.prototype.setOpacity=function(t,i){if(this.volumes[t].opacity=i,t===0){this.drawScene();return}this.updateGLVolume()};y.prototype.setScale=function(t){this.volScaleMultiplier=t,this.drawScene()};y.prototype.setClipPlaneColor=function(t){this.opts.clipPlaneColor=t,this.drawScene()};y.prototype.overlayRGBA=function(t){let i=t.hdr,e=i.dims[1]*i.dims[2]*i.dims[3],n=new Uint8ClampedArray(e*4),s=.2*Math.min(Math.min(i.dims[1],i.dims[2]),i.dims[3]),o=.5*i.dims[1],r=.5*i.dims[2],a=.5*i.dims[3],c=0;for(let l=0;l<i.dims[3];l++)for(let h=0;h<i.dims[2];h++)for(let p=0;p<i.dims[1];p++){let f=Math.abs(p-o),u=Math.abs(h-r),v=Math.abs(l-a),g=Math.sqrt(f*f+u*u+v*v),m=0;g<s&&(m=255),n[c++]=0,n[c++]=m,n[c++]=0,n[c++]=m*.5}return n};y.prototype.vox2mm=function(t,i){let e=K(i);ue(e,e);let n=yt(t[0],t[1],t[2],1);return Zt(n,n,e),z(n[0],n[1],n[2])};y.prototype.cloneVolume=function(t){return this.volumes[t].clone()};y.prototype.loadVolumes=async function(t){this.on("loading",i=>{i?(this.loadingText="loading...",this.drawScene()):this.loadingText=this.opts.loadingText}),this.initialized,this.volumes=[],this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.scene.loading$.next(!1);for(let i=0;i<t.length;i++){this.scene.loading$.next(!0);let e=await N.loadFromUrl(t[i].url,t[i].name,t[i].colorMap,t[i].opacity,this.opts.trustCalMinMax);this.scene.loading$.next(!1),this.volumes.push(e),i===0&&(this.back=e),this.overlays=this.volumes.slice(1),this.updateGLVolume()}return this};y.prototype.rgbaTex=function(t,i,e,n=!1){if(t&&this.gl.deleteTexture(t),t=this.gl.createTexture(),this.gl.activeTexture(i),this.gl.bindTexture(this.gl.TEXTURE_3D,t),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_R,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1),this.gl.texStorage3D(this.gl.TEXTURE_3D,1,this.gl.RGBA8,e[1],e[2],e[3]),n){let s=new Uint8Array(e[1]*e[2]*e[3]*4);this.gl.texSubImage3D(this.gl.TEXTURE_3D,0,0,0,0,e[1],e[2],e[3],this.gl.RGBA,this.gl.UNSIGNED_BYTE,s)}return t};y.prototype.requestCORSIfNotSameOrigin=function(t,i){new URL(i,window.location.href).origin!==window.location.origin&&(t.crossOrigin="")};y.prototype.loadFontTexture=function(t){return new Promise((i,e)=>{let n=new Image;n.onload=()=>{let s=this.gl.createTexture();this.gl.activeTexture(this.gl.TEXTURE3),this.gl.bindTexture(this.gl.TEXTURE_2D,s),this.gl.uniform1i(this.fontShader.uniforms.fontTexture,3),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,n),i(s)},n.onerror=e,this.requestCORSIfNotSameOrigin(n,t),n.src=t})};y.prototype.initFontMets=function(){this.fontMets=[];for(let e=0;e<256;e++)this.fontMets[e]={},this.fontMets[e].xadv=0,this.fontMets[e].uv_lbwh=[0,0,0,0],this.fontMets[e].lbwh=[0,0,0,0];this.fontMets.distanceRange=this.fontMetrics.atlas.distanceRange,this.fontMets.size=this.fontMetrics.atlas.size;let t=this.fontMetrics.atlas.width,i=this.fontMetrics.atlas.height;for(let e=0;e<this.fontMetrics.glyphs.length;e++){let n=this.fontMetrics.glyphs[e],s=n.unicode;if(this.fontMets[s].xadv=n.advance,n.planeBounds===void 0)continue;let o=n.atlasBounds.left/t,r=(i-n.atlasBounds.top)/i,a=(n.atlasBounds.right-n.atlasBounds.left)/t,c=(n.atlasBounds.top-n.atlasBounds.bottom)/i;this.fontMets[s].uv_lbwh=[o,r,a,c],o=n.planeBounds.left,r=n.planeBounds.bottom,a=n.planeBounds.right-n.planeBounds.left,c=n.planeBounds.top-n.planeBounds.bottom,this.fontMets[s].lbwh=[o,r,a,c]}};y.prototype.loadFont=async function(t=Ps,i=Ms){await this.loadFontTexture(t);let e=await fetch(i);if(!e.ok)throw Error(e.statusText);let n=await e.text();this.fontMetrics=JSON.parse(n),this.initFontMets(),this.fontShader.use(this.gl),this.gl.uniform1i(this.fontShader.uniforms.fontTexture,3),this.drawScene()};y.prototype.loadDefaultFont=async function(){await this.loadFontTexture(this.DEFAULT_FONT_GLYPH_SHEET),this.fontMetrics=this.DEFAULT_FONT_METRICS,this.initFontMets()};y.prototype.initText=async function(){this.fontShader=new M(this.gl,Gn,Vn),this.fontShader.use(this.gl),await this.loadDefaultFont(),this.drawLoadingText(this.loadingText)};y.prototype.initText=async function(){this.fontShader=new M(this.gl,Gn,Vn),this.fontShader.use(this.gl),await this.loadDefaultFont(),this.drawLoadingText(this.loadingText)};y.prototype.init=async function(){let t=this.gl.getExtension("WEBGL_debug_renderer_info"),i=this.gl.getParameter(t.UNMASKED_VENDOR_WEBGL),e=this.gl.getParameter(t.UNMASKED_RENDERER_WEBGL);W.info("renderer vendor: ",i),W.info("renderer: ",e),this.gl.enable(this.gl.CULL_FACE),this.gl.cullFace(this.gl.FRONT),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.rgbaTex(this.volumeTexture,this.gl.TEXTURE0,[2,2,2,2],!0),this.rgbaTex(this.overlayTexture,this.gl.TEXTURE2,[2,2,2,2],!0);let n=this.gl.createVertexArray();this.gl.bindVertexArray(n);let s=new Float32Array([0,1,.5,1,1,.5,1,0,.5,0,1,.5,1,0,.5,0,0,.5]),o=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,o),this.gl.bufferData(this.gl.ARRAY_BUFFER,s,this.gl.STATIC_DRAW),this.gl.enableVertexAttribArray(0),this.gl.vertexAttribPointer(0,3,this.gl.FLOAT,!1,0,0);let r=[0,1,0,1,1,0,0,1,1,1,1,1,1,0,1,1,1,0,1,0,0,0,1,0,0,0,0,0,1,1,0,0,1,1,0,1,0,0,0,1,0,0];this.cuboidVertexBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cuboidVertexBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(r),this.gl.STATIC_DRAW);let a=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,a),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(r),this.gl.STATIC_DRAW),this.gl.enableVertexAttribArray(0),this.gl.vertexAttribPointer(0,3,this.gl.FLOAT,!1,0,0),this.volumeObject3D=new Y(this.VOLUME_ID,a,this.gl.TRIANGLE_STRIP,14),this.volumeObject3D.glFlags=this.volumeObject3D.BLEND|this.volumeObject3D.CULL_FACE|this.volumeObject3D.CULL_FRONT,this.volumeObject3D.position=[0,0,this.DISTANCE_FROM_CAMERA];let c=new M(this.gl,ve,Vi);c.use(this.gl),this.gl.uniform1i(c.uniforms.volume,0),this.gl.uniform1i(c.uniforms.colormap,1),this.gl.uniform1i(c.uniforms.overlay,2),c.mvpUniformName="mvpMtx",c.rayDirUniformName="rayDir",c.clipPlaneUniformName="clipPlane",this.volumeObject3D.pickingShader=c,this.objectsToRender3D.push(this.volumeObject3D),this.sliceShader=new M(this.gl,oo,ro),this.sliceShader.use(this.gl),this.gl.uniform1i(this.sliceShader.uniforms.volume,0),this.gl.uniform1i(this.sliceShader.uniforms.colormap,1),this.gl.uniform1i(this.sliceShader.uniforms.overlay,2),this.lineShader=new M(this.gl,co,ao),this.renderShader=new M(this.gl,ve,so),this.renderShader.use(this.gl),this.gl.uniform1i(this.renderShader.uniforms.volume,0),this.gl.uniform1i(this.renderShader.uniforms.colormap,1),this.gl.uniform1i(this.renderShader.uniforms.overlay,2),this.pickingShader=new M(this.gl,ve,Vi);let l=new Ue(this.renderShader);l.mvpUniformName="mvpMtx",l.matRASUniformName="matRAS",l.rayDirUniformName="rayDir",l.clipPlaneUniformName="clipPlane",this.volumeObject3D.renderShaders.push(l),this.colorbarShader=new M(this.gl,lo,ho),this.colorbarShader.use(this.gl),this.gl.uniform1i(this.colorbarShader.uniforms.colormap,1),this.passThroughShader=new M(this.gl,go,_o),this.orientShaderAtlasU=new M(this.gl,Qt,Xe.concat(mo)),this.orientShaderU=new M(this.gl,Qt,Xe.concat(Ye)),this.orientShaderI=new M(this.gl,Qt,fo.concat(Ye)),this.orientShaderF=new M(this.gl,Qt,uo.concat(Ye)),this.orientShaderRGBU=new M(this.gl,Qt,Xe.concat(po)),this.pickingSurfaceShader=new M(this.gl,ve,bo),this.surfaceShader=new M(this.gl,vo,xo),this.surfaceShader.use(this.gl),this.gl.uniform4fv(this.surfaceShader.uniforms.surfaceColor,this.opts.clipPlaneColor);let h=new Ue(this.surfaceShader);return h.mvpUniformName="mvpMtx",await this.initText(),this.updateGLVolume(),this.initialized=!0,this.drawScene(),this};y.prototype.updateGLVolume=function(){let t=0,i=this.volumes.length;this.refreshColormaps();for(let e=0;e<i;e++)!this.volumes[e].toRAS||(this.refreshLayers(this.volumes[e],t,i),t++);this.drawScene()};y.prototype.refreshLayers=function(t,i,e){let n=t.hdr,s=t.img,o=t.opacity,r=null;this.crosshairs3D!==null&&(this.crosshairs3D.mm[0]=NaN);let a=K(t.toRAS);if(i===0){this.volumeObject3D=t.toNiivueObject3D(this.VOLUME_ID,this.gl),this.volumeObject3D.glFlags=this.volumeObject3D.CULL_FACE,this.objectsToRender3D.splice(0,1,this.volumeObject3D),Gt(a,a),W.debug(`mtx layer ${i}`,a),this.back.matRAS=t.matRAS,this.back.dims=t.dimsRAS,this.back.pixDims=t.pixDimsRAS,r=this.rgbaTex(this.volumeTexture,this.gl.TEXTURE0,t.dimsRAS);let{volScale:g,vox:m}=this.sliceScale();this.volScale=g,this.vox=m,this.volumeObject3D.scale=g,this.renderShader.use(this.gl),this.gl.uniform3fv(this.renderShader.uniforms.texVox,m),this.gl.uniform3fv(this.renderShader.uniforms.volScale,g);let _=this.renderShader,b=this.pickingShader;_.mvpUniformName="mvpMtx",_.matRASUniformName="matRAS",_.rayDirUniformName="rayDir",_.clipPlaneUniformName="clipPlane",b.use(this.gl),this.gl.uniform1i(b.uniforms.volume,0),this.gl.uniform1i(b.uniforms.colormap,1),this.gl.uniform1i(b.uniforms.overlay,2),b.mvpUniformName="mvpMtx",b.rayDirUniformName="rayDir",b.clipPlaneUniformName="clipPlane",this.gl.uniform3fv(b.uniforms.volScale,g),this.volumeObject3D.pickingShader===null&&(this.volumeObject3D.pickingShader=b),this.volumeObject3D.renderShaders.push(_),W.debug(this.volumeObject3D)}else{this.back.dims===void 0&&W.error("Fatal error: Unable to render overlay: background dimensions not defined!");let g=this.mm2frac(t.mm000),m=this.mm2frac(t.mm100),_=this.mm2frac(t.mm010),b=this.mm2frac(t.mm001);m=bt(m,m,g),_=bt(_,_,g),b=bt(b,b,g),a=zt(m[0],m[1],m[2],g[0],_[0],_[1],_[2],g[1],b[0],b[1],b[2],g[2],0,0,0,1),Gt(a,a),i===1?(r=this.rgbaTex(this.overlayTexture,this.gl.TEXTURE2,this.back.dims),this.backTexture=r):r=this.backTexture}let c=this.gl.createFramebuffer();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,c),this.gl.disable(this.gl.CULL_FACE),this.gl.viewport(0,0,this.back.dims[1],this.back.dims[2]),this.gl.disable(this.gl.BLEND);let l=this.gl.createTexture();this.gl.activeTexture(this.gl.TEXTURE6),this.gl.bindTexture(this.gl.TEXTURE_3D,l),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_R,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1);let h=this.orientShaderU;if(n.datatypeCode===2)n.intent_code===1002&&(h=this.orientShaderAtlasU),this.gl.texStorage3D(this.gl.TEXTURE_3D,1,this.gl.R8UI,n.dims[1],n.dims[2],n.dims[3]),this.gl.texSubImage3D(this.gl.TEXTURE_3D,0,0,0,0,n.dims[1],n.dims[2],n.dims[3],this.gl.RED_INTEGER,this.gl.UNSIGNED_BYTE,s);else if(n.datatypeCode===4)this.gl.texStorage3D(this.gl.TEXTURE_3D,1,this.gl.R16I,n.dims[1],n.dims[2],n.dims[3]),this.gl.texSubImage3D(this.gl.TEXTURE_3D,0,0,0,0,n.dims[1],n.dims[2],n.dims[3],this.gl.RED_INTEGER,this.gl.SHORT,s),h=this.orientShaderI;else if(n.datatypeCode===16)this.gl.texStorage3D(this.gl.TEXTURE_3D,1,this.gl.R32F,n.dims[1],n.dims[2],n.dims[3]),this.gl.texSubImage3D(this.gl.TEXTURE_3D,0,0,0,0,n.dims[1],n.dims[2],n.dims[3],this.gl.RED,this.gl.FLOAT,s),h=this.orientShaderF;else if(n.datatypeCode===64){let g=new Float32Array;g=Float32Array.from(s),this.gl.texStorage3D(this.gl.TEXTURE_3D,1,this.gl.R32F,n.dims[1],n.dims[2],n.dims[3]),this.gl.texSubImage3D(this.gl.TEXTURE_3D,0,0,0,0,n.dims[1],n.dims[2],n.dims[3],this.gl.RED,this.gl.FLOAT,g),h=this.orientShaderF}else n.datatypeCode===128?(h=this.orientShaderRGBU,h.use(this.gl),this.gl.uniform1i(h.uniforms.hasAlpha,!1),this.gl.texStorage3D(this.gl.TEXTURE_3D,1,this.gl.RGB8UI,n.dims[1],n.dims[2],n.dims[3]),this.gl.texSubImage3D(this.gl.TEXTURE_3D,0,0,0,0,n.dims[1],n.dims[2],n.dims[3],this.gl.RGB_INTEGER,this.gl.UNSIGNED_BYTE,s)):n.datatypeCode===512?(this.gl.texStorage3D(this.gl.TEXTURE_3D,1,this.gl.R16UI,n.dims[1],n.dims[2],n.dims[3]),this.gl.texSubImage3D(this.gl.TEXTURE_3D,0,0,0,0,n.dims[1],n.dims[2],n.dims[3],this.gl.RED_INTEGER,this.gl.UNSIGNED_SHORT,s)):n.datatypeCode===2304&&(h=this.orientShaderRGBU,h.use(this.gl),this.gl.uniform1i(h.uniforms.hasAlpha,!0),this.gl.texStorage3D(this.gl.TEXTURE_3D,1,this.gl.RGBA8UI,n.dims[1],n.dims[2],n.dims[3]),this.gl.texSubImage3D(this.gl.TEXTURE_3D,0,0,0,0,n.dims[1],n.dims[2],n.dims[3],this.gl.RGBA_INTEGER,this.gl.UNSIGNED_BYTE,s));t.global_min===void 0&&t.calMinMax();let p=null;if(i>1){p=this.rgbaTex(p,this.gl.TEXTURE5,this.back.dims),this.gl.bindTexture(this.gl.TEXTURE_3D,p);let g=this.passThroughShader;g.use(this.gl),this.gl.uniform1i(g.uniforms.in3D,2);for(let m=0;m<this.back.dims[3];m++){let _=1/this.back.dims[3]*(m+.5);this.gl.uniform1f(g.uniforms.coordZ,_),this.gl.framebufferTextureLayer(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,p,0,m),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,5,4)}}else p=this.rgbaTex(p,this.gl.TEXTURE5,[2,2,2,2]);if(h.use(this.gl),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.colormapTexture),this.gl.uniform1f(h.uniforms.cal_min,t.cal_min),this.gl.uniform1f(h.uniforms.cal_max,t.cal_max),this.gl.bindTexture(this.gl.TEXTURE_3D,l),this.gl.uniform1i(h.uniforms.intensityVol,6),this.gl.uniform1i(h.uniforms.blend3D,5),this.gl.uniform1i(h.uniforms.colormap,1),this.gl.uniform1f(h.uniforms.layer,i),this.gl.uniform1f(h.uniforms.numLayers,e),this.gl.uniform1f(h.uniforms.scl_inter,n.scl_inter),this.gl.uniform1f(h.uniforms.scl_slope,n.scl_slope),this.gl.uniform1f(h.uniforms.opacity,o),this.gl.uniformMatrix4fv(h.uniforms.mtx,!1,a),n.intent_code===1002){let g=1/this.back.dims[1];this.opts.isAtlasOutline||(g=-g),this.gl.uniform3fv(h.uniforms.xyzFrac,[g,1/this.back.dims[2],1/this.back.dims[3]])}W.debug("back dims: ",this.back.dims);for(let g=0;g<this.back.dims[3];g++){let m=1/this.back.dims[3]*(g+.5);this.gl.uniform1f(h.uniforms.coordZ,m),this.gl.framebufferTextureLayer(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,r,0,g),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,5,4)}this.gl.deleteTexture(l),this.gl.deleteTexture(p),this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.gl.deleteFramebuffer(c),this.sliceShader.use(this.gl),this.gl.uniform1f(this.sliceShader.uniforms.overlays,this.overlays),this.renderShader.use(this.gl);let f=this.sliceScale(),u=f.vox,v=f.volScale;this.gl.uniform1f(this.renderShader.uniforms.overlays,this.overlays),this.gl.uniform4fv(this.renderShader.uniforms.clipPlaneColor,this.opts.clipPlaneColor),this.gl.uniform1f(this.renderShader.uniforms.backOpacity,this.volumes[0].opacity),this.gl.uniform4fv(this.renderShader.uniforms.clipPlane,this.scene.clipPlane),this.gl.uniform3fv(this.renderShader.uniforms.texVox,u),this.gl.uniform3fv(this.renderShader.uniforms.volScale,v),this.volumeObject3D.pickingShader.use(this.gl),this.gl.uniform1f(this.pickingShader.uniforms.overlays,this.overlays),this.gl.uniform3fv(this.volumeObject3D.pickingShader.uniforms.texVox,u),this.updateInterpolation(i)};y.prototype.colorMaps=function(t=!0){let i=[];for(const[e]of Object.entries($))i.push(e);return t===!0?i.sort():i};y.prototype.setColorMap=function(t,i){let e=this.getVolumeIndexByID(t);this.volumes[e].colorMap=i,this.updateGLVolume()};y.prototype.colormapFromKey=function(t){let i=this.colorMaps();for(let e=0;e<i.length;e++){let n=i[e];if(t.toLowerCase()===n.toLowerCase())return $[n]}};y.prototype.colormap=function(t=""){let i="gray",e=this.colorMaps();for(let n=0;n<e.length;n++){let s=e[n];if(t.toLowerCase()===s.toLowerCase())return this.makeLut($[s].R,$[s].G,$[s].B,$[s].A,$[s].I)}return this.makeLut($[i].R,$[i].G,$[i].B,$[i].A,$[i].I)};y.prototype.refreshColormaps=function(){let t=this.volumes.length;if(t<1)return;this.colormapTexture!==null&&this.gl.deleteTexture(this.colormapTexture),this.colormapTexture=this.gl.createTexture(),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.colormapTexture),this.gl.texStorage2D(this.gl.TEXTURE_2D,1,this.gl.RGBA8,256,t),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_R,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1);let i=this.colormap(this.volumes[0].colorMap);if(t>1)for(let e=1;e<t;e++){let n=this.colormap(this.volumes[e].colorMap),s=new Uint8ClampedArray(i.length+n.length);s.set(i),s.set(n,i.length),i=s}return this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,0,0,256,t,this.gl.RGBA,this.gl.UNSIGNED_BYTE,i),this};y.prototype.makeLut=function(t,i,e,n,s){for(var o=new Uint8ClampedArray(1024),r=0;r<s.length-1;r++)for(var a=s[r],c=s[r+1],l=c-a,h=a*4,p=a;p<=c;p++){var f=(p-a)/l;o[h++]=t[r]+f*(t[r+1]-t[r]),o[h++]=i[r]+f*(i[r+1]-i[r]),o[h++]=e[r]+f*(e[r+1]-e[r]),o[h++]=n[r]+f*(n[r+1]-n[r])}return o};y.prototype.sliceScale=function(){var t=[1,this.back.dims[1]*this.back.pixDims[1],this.back.dims[2]*this.back.pixDims[2],this.back.dims[3]*this.back.pixDims[3]],i=Math.max(t[1],Math.max(t[2],t[3])),e=[t[1]/i,t[2]/i,t[3]/i],n=[this.back.dims[1],this.back.dims[2],this.back.dims[3]];return{volScale:e,vox:n}};y.prototype.mouseClick=function(t,i,e=0,n=!0){var s,o;if(this.canvas.focus(),this.sliceType===this.sliceTypeRender){if(e===0)return;if(this.scene.clipPlaneDepthAziElev[0]<1.8){let h=this.scene.clipPlaneDepthAziElev.slice();return e>0&&(h[0]=Math.min(1.5,h[0]+.025)),e<0&&(h[0]=Math.max(-1.5,h[0]-.025)),h[0]!==this.scene.clipPlaneDepthAziElev[0]?(this.scene.clipPlaneDepthAziElev=h,this.clipPlaneUpdate(this.scene.clipPlaneDepthAziElev)):void 0}e>0&&(this.volScaleMultiplier=Math.min(2,this.volScaleMultiplier*1.1)),e<0&&(this.volScaleMultiplier=Math.max(.5,this.volScaleMultiplier*.9)),this.drawScene();return}if(!(this.numScreenSlices<1||this.gl.canvas.height<1||this.gl.canvas.width<1))for(let h=0;h<this.numScreenSlices;h++){var r=this.screenSlices[h].axCorSag;if(r>this.sliceTypeSagittal)continue;var a=this.screenSlices[h].leftTopWidthHeight;let p=!1;a[2]<0&&(p=!0,a[0]+=a[2],a[2]=-a[2]);var c=(t-a[0])/a[2];p&&(c=1-c);var l=1-(i-a[1])/a[3];if(c>=0&&c<1&&l>=0&&l<1){if(!n){this.scene.crosshairPos[2-r]=e,this.drawScene();return}if(e!==0){s=this.scene.crosshairPos[2-r],o=s+e,o>1&&(o=1),o<0&&(o=0),this.scene.crosshairPos[2-r]=o,this.drawScene(),this.scene.location$.next({mm:this.frac2mm(this.scene.crosshairPos),vox:this.frac2vox(this.scene.crosshairPos),frac:this.scene.crosshairPos,values:this.volumes.map((f,u)=>{let v=this.frac2mm(this.scene.crosshairPos),g=f.mm2vox(v);return f.getValue(...g)})});return}r===this.sliceTypeAxial&&(this.scene.crosshairPos[0]=c,this.scene.crosshairPos[1]=l),r===this.sliceTypeCoronal&&(this.scene.crosshairPos[0]=c,this.scene.crosshairPos[2]=l),r===this.sliceTypeSagittal&&(this.scene.crosshairPos[1]=c,this.scene.crosshairPos[2]=l),this.drawScene(),this.scene.location$.next({mm:this.frac2mm(this.scene.crosshairPos),vox:this.frac2vox(this.scene.crosshairPos),frac:this.scene.crosshairPos,values:this.volumes.map((f,u)=>{let v=this.frac2mm(this.scene.crosshairPos),g=f.mm2vox(v);return f.getValue(...g)})});return}else if(t===null&&i===null){this.scene.crosshairPos[2-r]=e,this.drawScene();return}}};y.prototype.drawSelectionBox=function(t){this.lineShader.use(this.gl),this.gl.uniform4fv(this.lineShader.uniforms.lineColor,this.opts.selectionBoxColor),this.gl.uniform2fv(this.lineShader.uniforms.canvasWidthHeight,[this.gl.canvas.width,this.gl.canvas.height]),this.gl.uniform4f(this.lineShader.uniforms.leftTopWidthHeight,t[0],t[1],t[2],t[3]),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,5,4)};y.prototype.drawColorbar=function(t){t[2]<=0||t[3]<=0||(this.colorbarShader.use(this.gl),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.colormapTexture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.uniform2fv(this.colorbarShader.uniforms.canvasWidthHeight,[this.gl.canvas.width,this.gl.canvas.height]),this.gl.uniform4f(this.colorbarShader.uniforms.leftTopWidthHeight,t[0],t[1],t[2],t[3]),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,5,4),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR))};y.prototype.textWidth=function(t,i){let e=0;var n=new TextEncoder().encode(i);for(let s=0;s<i.length;s++)e+=t*this.fontMets[n[s]].xadv;return e};y.prototype.drawChar=function(t,i,e){let n=this.fontMets[e],s=t[0]+i*n.lbwh[0],o=-(i*n.lbwh[1]),r=i*n.lbwh[2],a=i*n.lbwh[3],c=t[1]+(o-a)+i;return this.gl.uniform4f(this.fontShader.uniforms.leftTopWidthHeight,s,c,r,a),this.gl.uniform4fv(this.fontShader.uniforms.uvLeftTopWidthHeight,n.uv_lbwh),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,5,4),i*n.xadv};y.prototype.drawLoadingText=function(t){this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.gl.enableVertexAttribArray(0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cuboidVertexBuffer),this.gl.vertexAttribPointer(0,3,this.gl.FLOAT,!1,0,0),this.gl.enable(this.gl.CULL_FACE),this.drawTextBelow([this.canvas.width/2,this.canvas.height/2],t,3),this.canvas.focus()};y.prototype.drawText=function(t,i,e=1){if(this.opts.textHeight<=0)return;this.fontShader.use(this.gl);let n=this.opts.textHeight*Math.min(this.gl.canvas.height,this.gl.canvas.width)*e;this.gl.enable(this.gl.BLEND),this.gl.uniform2f(this.fontShader.uniforms.canvasWidthHeight,this.gl.canvas.width,this.gl.canvas.height),this.gl.uniform4fv(this.fontShader.uniforms.fontColor,this.opts.crosshairColor);let s=n/this.fontMets.size*this.fontMets.distanceRange;s=Math.max(s,1),this.gl.uniform1f(this.fontShader.uniforms.screenPxRange,s);var o=new TextEncoder().encode(i);for(let r=0;r<i.length;r++)t[0]+=this.drawChar(t,n,o[r])};y.prototype.drawTextRight=function(t,i,e=1){this.opts.textHeight<=0||(t[1]-=.5*this.opts.textHeight*this.gl.canvas.height,this.drawText(t,i,e))};y.prototype.drawTextBelow=function(t,i,e=1){if(this.opts.textHeight<=0)return;let n=this.opts.textHeight*this.gl.canvas.height*e;t[0]-=.5*this.textWidth(n,i),this.drawText(t,i,e)};y.prototype.updateInterpolation=function(t){let i=this.gl.LINEAR;this.opts.isNearestInterpolation&&(i=this.gl.NEAREST),t===0?this.gl.activeTexture(this.gl.TEXTURE0):this.gl.activeTexture(this.gl.TEXTURE2),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_MIN_FILTER,i),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_MAG_FILTER,i),this.volumes.length};y.prototype.setAtlasOutline=function(t){this.opts.isAtlasOutline=t,this.updateGLVolume(),this.drawScene()};y.prototype.setInterpolation=function(t){this.opts.isNearestInterpolation=t;let i=this.volumes.length;i<1||(this.updateInterpolation(0),i>1&&this.updateInterpolation(1),this.drawScene())};y.prototype.draw2D=function(t,i){this.gl.cullFace(this.gl.FRONT),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cuboidVertexBuffer),this.gl.vertexAttribPointer(0,3,this.gl.FLOAT,!1,0,0);var e=[this.scene.crosshairPos[0],this.scene.crosshairPos[1],this.scene.crosshairPos[2]];i===this.sliceTypeCoronal&&(e=[this.scene.crosshairPos[0],this.scene.crosshairPos[2],this.scene.crosshairPos[1]]),i===this.sliceTypeSagittal&&(e=[this.scene.crosshairPos[1],this.scene.crosshairPos[2],this.scene.crosshairPos[0]]);let n=this.opts.isRadiologicalConvention&&i<this.sliceTypeSagittal;if(this.sliceShader.use(this.gl),this.gl.uniform1f(this.sliceShader.uniforms.opacity,this.volumes[0].opacity),this.gl.uniform1i(this.sliceShader.uniforms.axCorSag,i),this.gl.uniform1f(this.sliceShader.uniforms.slice,e[2]),this.gl.uniform2fv(this.sliceShader.uniforms.canvasWidthHeight,[this.gl.canvas.width,this.gl.canvas.height]),n&&(this.gl.disable(this.gl.CULL_FACE),t[2]=-t[2],t[0]=t[0]-t[2]),this.gl.uniform4f(this.sliceShader.uniforms.leftTopWidthHeight,t[0],t[1],t[2],t[3]),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,5,4),this.screenSlices[this.numScreenSlices].leftTopWidthHeight=t,this.screenSlices[this.numScreenSlices].axCorSag=i,this.numScreenSlices+=1,!(this.opts.crosshairWidth<=0)){this.lineShader.use(this.gl),this.gl.uniform4fv(this.lineShader.uniforms.lineColor,this.opts.crosshairColor),this.gl.uniform2fv(this.lineShader.uniforms.canvasWidthHeight,[this.gl.canvas.width,this.gl.canvas.height]);var s=t[0]+t[2]*e[0];this.gl.uniform4f(this.lineShader.uniforms.leftTopWidthHeight,s-.5*this.opts.crosshairWidth,t[1],this.opts.crosshairWidth,t[3]),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,5,4);var o=t[1]+t[3]*(1-e[1]);this.gl.uniform4f(this.lineShader.uniforms.leftTopWidthHeight,t[0],o-.5*this.opts.crosshairWidth,t[2],this.opts.crosshairWidth),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,5,4),this.gl.enable(this.gl.CULL_FACE),n?this.drawTextRight([t[0]+t[2]+1,t[1]+.5*t[3]],"R"):i<this.sliceTypeSagittal&&this.drawTextRight([t[0]+1,t[1]+.5*t[3]],"L"),i===this.sliceTypeAxial&&this.drawTextBelow([t[0]+.5*t[2],t[1]+1],"A"),i>this.sliceTypeAxial&&this.drawTextBelow([t[0]+.5*t[2],t[1]+1],"S"),this.sync()}};y.prototype.calculateMvpMatrix=function(t){function i(c){return c*(Math.PI/180)}let e=this.gl.canvas.clientWidth/this.gl.canvas.clientHeight,n=it(),s=.7*this.volumeObject3D.furthestVertexFromOrigin*1/this.volScaleMultiplier;e<1?Oi(n,-s,s,-s/e,s/e,.01,s*8):Oi(n,-s*e,s*e,-s,s,.01,s*8);const o=it();o[0]=-1;let r=z(0,0,-s*1.8);He(o,o,r),He(o,o,this.volumeObject3D.position),$n(o,o,i(270-this.scene.renderElevation)),On(o,o,i(this.scene.renderAzimuth-180)),He(o,o,this.volumeObject3D.originNegate);let a=it();return Be(a,n,o),a};y.prototype.calculateRayDirection=function(){function t(l){return l*(Math.PI/180)}const i=it();i[0]=-1,$n(i,i,t(270-this.scene.renderElevation)),On(i,i,t(this.scene.renderAzimuth-180));let e=K(this.back.obliqueRAS);Be(i,i,e);let n=zt(1,0,0,0,0,-1,0,0,0,0,-1,0,0,0,0,1),s=it();Be(s,n,i);var o=it();Gt(o,s);var r=yt(0,0,-1,1);Zt(r,r,o);let a=z(r[0],r[1],r[2]);Fe(a,a);const c=5e-5;return Math.abs(a[0])<c&&(a[0]=c),Math.abs(a[1])<c&&(a[1]=c),Math.abs(a[2])<c&&(a[2]=c),a};y.prototype.draw3D=function(){this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);const t=this.calculateMvpMatrix(this.volumeObject3D),i=this.calculateRayDirection();if(this.scene.mouseDepthPicker){this.scene.mouseDepthPicker=!1;for(const r of this.objectsToRender3D){if(!r.isVisible||!r.isPickable)continue;let a=r.pickingShader?r.pickingShader:this.pickingSurfaceShader;if(a.use(this.gl),r.glFlags&r.CULL_FACE?(this.gl.enable(this.gl.CULL_FACE),r.glFlags&r.CULL_FRONT?this.gl.cullFace(this.gl.FRONT):this.gl.cullFace(this.gl.FRONT)):this.gl.disable(this.gl.CULL_FACE),this.gl.uniformMatrix4fv(a.uniforms.mvpMtx,!1,t),a.rayDirUniformName){let c=this.calculateRayDirection();this.gl.uniform3fv(a.uniforms[a.rayDirUniformName],c)}a.clipPlaneUniformName&&this.gl.uniform4fv(a.uniforms.clipPlane,this.scene.clipPlane),this.gl.uniform1i(a.uniforms.id,r.id),this.gl.enableVertexAttribArray(0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r.vertexBuffer),this.gl.vertexAttribPointer(0,3,this.gl.FLOAT,!1,0,0),r.textureCoordinateBuffer?(this.gl.enableVertexAttribArray(1),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r.textureCoordinateBuffer),this.gl.vertexAttribPointer(1,3,this.gl.FLOAT,!1,0,0)):this.gl.disableVertexAttribArray(1),r.indexBuffer&&this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,r.indexBuffer),r.glFlags&r.CULL_FACE?(this.gl.enable(this.gl.CULL_FACE),r.glFlags&r.CULL_FRONT?this.gl.cullFace(this.gl.FRONT):this.gl.cullFace(this.gl.FRONT)):this.gl.disable(this.gl.CULL_FACE),r.mode!==this.gl.TRIANGLE_STRIP&&this.gl.drawElements(r.mode,r.indexCount,this.gl.UNSIGNED_SHORT,0)}const n=this.mousePos[0]*this.gl.canvas.width/this.gl.canvas.clientWidth,s=this.gl.canvas.height-this.mousePos[1]*this.gl.canvas.height/this.gl.canvas.clientHeight-1,o=new Uint8Array(4);if(this.gl.readPixels(n,s,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,o),this.gl.enableVertexAttribArray(0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cuboidVertexBuffer),this.gl.vertexAttribPointer(0,3,this.gl.FLOAT,!1,0,0),this.selectedObjectId=o[3],this.selectedObjectId===this.VOLUME_ID&&(this.scene.crosshairPos=new Float32Array(o.slice(0,3)).map(r=>r/255)),o[3]===253){let r=new Float32Array(o.slice(0,3)).map(a=>a/255);console.log(this.scene.clipPlaneDepthAziElev[0],"User clicked on the clip plane at "+r),this.scene.clipPlaneDepthAziElev[0]=this.scene.clipPlaneDepthAziElev[0]-.1,this.scene.clipPlaneDepthAziElev[0]<=-.4&&(this.scene.clipPlaneDepthAziElev[0]=.4),this.clipPlaneUpdate(this.scene.clipPlaneDepthAziElev)}}this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);for(const n of this.objectsToRender3D)if(!!n.isVisible){this.gl.enableVertexAttribArray(0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,n.vertexBuffer),this.gl.vertexAttribPointer(0,3,this.gl.FLOAT,!1,0,0),n.textureCoordinateBuffer&&(this.gl.enableVertexAttribArray(1),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,n.textureCoordinateBuffer),this.gl.vertexAttribPointer(1,3,this.gl.FLOAT,!1,0,0)),n.indexBuffer&&this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,n.indexBuffer),n.BLEND?(this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA)):this.gl.disable(this.gl.BLEND),n.glFlags&n.CULL_FACE?(this.gl.enable(this.gl.CULL_FACE),n.glFlags&n.CULL_FRONT?this.gl.cullFace(this.gl.FRONT):this.gl.cullFace(this.gl.FRONT)):this.gl.disable(this.gl.CULL_FACE);for(const s of n.renderShaders)s.use(this.gl),s.mvpUniformName&&this.gl.uniformMatrix4fv(s.uniforms[s.mvpUniformName],!1,t),s.matRASUniformName&&this.gl.uniformMatrix4fv(s.uniforms[s.matRASUniformName],!1,this.back.matRAS),s.rayDirUniformName&&this.gl.uniform3fv(s.uniforms[s.rayDirUniformName],i),s.clipPlaneUniformName&&this.gl.uniform4fv(s.uniforms.clipPlane,this.scene.clipPlane),this.gl.drawElements(n.mode,n.indexCount,this.gl.UNSIGNED_SHORT,0)}this.opts.show3Dcrosshair?(this.drawCrosshairs3D(!0,1),this.drawCrosshairs3D(!1,.35)):(this.gl.enableVertexAttribArray(0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cuboidVertexBuffer),this.gl.vertexAttribPointer(0,3,this.gl.FLOAT,!1,0,0));let e="azimuth: "+this.scene.renderAzimuth.toFixed(0)+" elevation: "+this.scene.renderElevation.toFixed(0);return this.sync(),e};y.prototype.drawCrosshairs3D=function(t=!0,i=1){if(!this.opts.show3Dcrosshair)return;let e=this.gl,n=this.frac2mm(this.scene.crosshairPos);if(this.crosshairs3D===null||this.crosshairs3D.mm[0]!==n[0]||this.crosshairs3D.mm[1]!==n[1]||this.crosshairs3D.mm[2]!==n[2]){this.crosshairs3D!==null&&(e.deleteBuffer(this.crosshairs3D.indexBuffer),e.deleteBuffer(this.crosshairs3D.vertexBuffer));let a=Math.min(Math.min(this.back.pixDims[1],this.back.pixDims[2]),this.back.pixDims[3]);this.crosshairs3D=Y.generateCrosshairs(this.gl,1,n,this.volumeObject3D.extentsMin,this.volumeObject3D.extentsMax,a),this.crosshairs3D.isPickable=!1,this.crosshairs3D.minExtent=this.volumeObject3D.minExtent,this.crosshairs3D.maxExtent=this.volumeObject3D.maxExtent,this.crosshairs3D.mm=n,this.crosshairs3D.originNegate=this.volumeObject3D.originNegate,this.crosshairs3D.furthestVertexFromOrigin=this.volumeObject3D.furthestVertexFromOrigin}let s=new Ue(this.surfaceShader);s.mvpUniformName="mvpMtx",this.crosshairs3D.renderShaders.push(s);{const c=e.FLOAT,l=!1,h=0,p=0;e.bindBuffer(e.ARRAY_BUFFER,this.crosshairs3D.vertexBuffer),e.vertexAttribPointer(this.surfaceShader.uniforms.pos,3,c,l,h,p),e.enableVertexAttribArray(this.surfaceShader.uniforms.pos)}s.use(this.gl);let o=this.calculateMvpMatrix(this.crosshairs3D);e.uniformMatrix4fv(s.uniforms.mvpMtx,!1,o),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.crosshairs3D.indexBuffer),e.enable(e.DEPTH_TEST);let r=[...this.opts.crosshairColor];t?(e.disable(e.BLEND),e.depthFunc(e.GREATER),r[3]=i):(e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.depthFunc(e.ALWAYS),r[3]=i),e.uniform4fv(s.uniforms.surfaceColor,r);{const a=this.crosshairs3D.indexCount,c=e.UNSIGNED_SHORT,l=0;e.drawElements(e.TRIANGLES,a,c,l)}e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.depthFunc(e.ALWAYS),this.gl.enableVertexAttribArray(0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.cuboidVertexBuffer),this.gl.vertexAttribPointer(0,3,this.gl.FLOAT,!1,0,0)};y.prototype.mm2frac=function(t,i=0){let e=yt(t[0],t[1],t[2],1),n=this.volumes[i].hdr.dims,s=[0,0,0];if(typeof n=="undefined"||n[1]<1||n[2]<1||n[3]<1)return s;let o=K(this.volumes[i].matRAS);return ue(o,o),Gt(o,o),Zt(e,e,o),s[0]=(e[0]+.5)/n[1],s[1]=(e[1]+.5)/n[2],s[2]=(e[2]+.5)/n[3],s};y.prototype.vox2frac=function(t,i=0){return[(t[0]+.5)/this.volumes[i].hdr.dims[1],(t[1]+.5)/this.volumes[i].hdr.dims[2],(t[2]+.5)/this.volumes[i].hdr.dims[3]]};y.prototype.frac2vox=function(t,i=0){return[Math.round(t[0]*this.volumes[i].hdr.dims[1]-.5),Math.round(t[1]*this.volumes[i].hdr.dims[2]-.5),Math.round(t[2]*this.volumes[i].hdr.dims[3]-.5)]};y.prototype.frac2mm=function(t,i=0){let e=yt(t[0],t[1],t[2],1),n=yt(this.volumes[i].dimsRAS[1],this.volumes[i].dimsRAS[2],this.volumes[i].dimsRAS[3],1),s=K(this.volumes[i].matRAS);ue(s,s),no(e,e,n);let o=yt(-.5,-.5,-.5,0);return eo(e,e,o),Zt(e,e,s),e};y.prototype.canvasPos2frac=function(t){let i,e,n;for(let c=0;c<this.numScreenSlices;c++){var s=this.screenSlices[c].axCorSag;if(s>this.sliceTypeSagittal)continue;var o=this.screenSlices[c].leftTopWidthHeight;let l=!1;o[2]<0&&(l=!0,o[0]+=o[2],o[2]=-o[2]);var r=(t[0]-o[0])/o[2];l&&(r=1-r);var a=1-(t[1]-o[1])/o[3];if(r>=0&&r<1&&a>=0&&a<1){switch(s){case this.sliceTypeAxial:break;case this.sliceTypeCoronal:break}s===this.sliceTypeAxial&&(i=r,e=a,n=this.scene.crosshairPos[2]),s===this.sliceTypeCoronal&&(i=r,e=this.scene.crosshairPos[1],n=a),s===this.sliceTypeSagittal&&(i=this.scene.crosshairPos[0],e=r,n=a);break}}return[i,e,n]};y.prototype.scaleSlice=function(t,i){let e=this.gl.canvas.clientWidth/t;i*e>this.gl.canvas.clientHeight&&(e=this.gl.canvas.clientHeight/i);let n=t*e,s=i*e;return[(this.gl.canvas.clientWidth-n)*.5,(this.gl.canvas.clientHeight-s)*.5,n,s]};y.prototype.drawScene=function(){if(!this.initialized)return;this.gl.clearColor(this.opts.backColor[0],this.opts.backColor[1],this.opts.backColor[2],this.opts.backColor[3]),this.gl.clear(this.gl.COLOR_BUFFER_BIT);let t="";if(this.volumes.length===0||typeof this.volumes[0].dims=="undefined"){this.drawLoadingText(this.loadingText);return}if(this.sliceType===this.sliceTypeRender){if(this.isDragging&&this.scene.clipPlaneDepthAziElev[0]<1.8){let s=this.dragStart[0]-this.dragEnd[0],o=this.dragStart[1]-this.dragEnd[1],r=this.dragClipPlaneStartDepthAziElev.slice();if(r[1]-=s,r[1]=r[1]%360,r[2]+=o,r[2]>90&&(r[2]=90),r[2]<-90&&(r[2]=-90),r[1]!==this.scene.clipPlaneDepthAziElev[1]||r[2]!==this.scene.clipPlaneDepthAziElev[2])return this.scene.clipPlaneDepthAziElev=r,this.clipPlaneUpdate(this.scene.clipPlaneDepthAziElev)}return this.draw3D()}let{volScale:i}=this.sliceScale();if(this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.numScreenSlices=0,this.sliceType===this.sliceTypeAxial){let s=this.scaleSlice(i[0],i[1]);this.draw2D(s,0)}else if(this.sliceType===this.sliceTypeCoronal){let s=this.scaleSlice(i[0],i[2]);this.draw2D(s,1)}else if(this.sliceType===this.sliceTypeSagittal){let s=this.scaleSlice(i[1],i[2]);this.draw2D(s,2)}else{let s=this.scaleSlice(i[0]+i[1],i[1]+i[2]),o=s[2]*i[0]/(i[0]+i[1]),r=this.scaleSlice(i[0]+i[0]+i[1],Math.max(i[1],i[2])),a=r[2]*i[0]/(i[0]+i[0]+i[1]);if(a>o){let c=a/i[0],l=i[1]*c,h=i[2]*c;this.draw2D([r[0],r[1],a,l],0),this.draw2D([r[0]+a,r[1],a,h],1),this.draw2D([r[0]+a+a,r[1],l,h],2)}else{let c=s[2]-o,l=s[3]*i[1]/(i[1]+i[2]),h=s[3]-l;this.draw2D([s[0],s[1]+h,o,l],0),this.draw2D([s[0],s[1],o,h],1),this.draw2D([s[0]+o,s[1],c,h],2);var e=this.opts.colorBarMargin*l;this.drawColorbar([s[0]+o+e,s[1]+h+e,c-e-e,l*this.opts.colorbarHeight])}}if(this.isDragging&&this.sliceType!==this.sliceTypeRender){let s=Math.abs(this.dragStart[0]-this.dragEnd[0]),o=Math.abs(this.dragStart[1]-this.dragEnd[1]);this.drawSelectionBox([Math.min(this.dragStart[0],this.dragEnd[0]),Math.min(this.dragStart[1],this.dragEnd[1]),s,o])}const n=this.frac2mm([this.scene.crosshairPos[0],this.scene.crosshairPos[1],this.scene.crosshairPos[2]]);return t=n[0].toFixed(2)+"\xD7"+n[1].toFixed(2)+"\xD7"+n[2].toFixed(2),this.gl.finish(),t};function ku(){return new Worker("/niivue-bet/assets/worker.83287f64.js",{type:"module"})}var Mn="/niivue-bet/assets/test_t1.69544152.nii",Pu="/niivue-bet/assets/bet2.5827c12e.wasm";let Di=null,ct={bet:null,mask:null,overlay:null,skull:null};function Mu(t){let i=t.lastIndexOf("//"),e=t.lastIndexOf("/");return t.substring(0,i)+"/"+t.substring(e+1,t.length)}function Lu(t,i){let e=["vol.nii","out/vol_bet.nii"].concat(Ls());console.log(e),t.postMessage({files:[{name:"vol.nii",data:new Uint8Array(i)}],args:e,wasmPath:Mu(Pu)})}function $t(t,i){let e=new N(i);t.setVolume(e,0)}function Ln(){document.querySelectorAll(".overlay-link").forEach(i=>{i.classList.add("hidden")})}function te(t){document.getElementById(t).classList.remove("hidden")}function $u(t,i){i.addEventListener("message",async function(e){if(e.data.length==1)$t(t,e.data[0].data),Ln(),te("betLink");else{Ln();for(let n of e.data)n.name.includes("skull")?(ct.skull=n.data,te("skullLink")):n.name.includes("mask")?(ct.mask=n.data,te("maskLink")):n.name.includes("overlay")?(ct.overlay=n.data,te("overlayLink")):(ct.bet=n.data,te("betLink"));$t(t,ct.bet)}}),i.addEventListener("onerror",function(e){console.log(e.message)})}async function Ou(t,i){const e=t.target.files[0];if(e){let n=await N.loadFromFile(e);i.setVolume(n,0);const s=new FileReader;s.onload=function(o){Di=o.target.result},s.readAsArrayBuffer(e)}}function Ls(){const i=document.getElementById("betForm").querySelectorAll("input"),e=[];for(let n of i)n.type==="checkbox"&&n.checked?e.push(n.name):(n.type==="range"||n.type==="number")&&(e.push(n.name),e.push(n.value));return e}async function zu(t){try{const i=await fetch(t);if(!i.ok)throw new Error(`HTTP error! Status: ${i.status}`);return await i.arrayBuffer()}catch(i){throw console.error("Fetching file failed:",i),i}}window.onload=async()=>{console.log(Ls());const t=document.getElementById("gl"),i=new ku,e=new y;document.getElementById("fileSelection").addEventListener("click",r=>{r.preventDefault(),fileInput.click()}),document.getElementById("submitBet").addEventListener("click",r=>{r.preventDefault(),Lu(i,Di),n.style.display="none"}),fileInput.addEventListener("change",r=>Ou(r,e));const n=document.getElementById("betModal"),s=document.getElementById("closeModal");document.getElementById("bet").addEventListener("click",function(r){r.preventDefault(),n.style.display="block"}),s.addEventListener("click",function(){n.style.display="none"}),document.querySelector('input[name="-f"]').addEventListener("input",function(r){document.getElementById("sliderValueF").textContent=r.target.value}),document.querySelector('input[name="-g"]').addEventListener("input",function(r){document.getElementById("sliderValueG").textContent=r.target.value});let o=document.querySelectorAll(".overlay-link");o.forEach(r=>{r.addEventListener("click",function(a){a.preventDefault(),o.forEach(c=>{c.classList.remove("selected")}),r.id.includes("skull")?$t(e,ct.skull):r.id.includes("overlay")?$t(e,ct.overlay):r.id.includes("mask")?$t(e,ct.mask):$t(e,ct.bet),this.classList.add("selected")})}),$u(e,i),Di=await zu(Mn),e.attachToCanvas(t),e.loadVolumes([{url:Mn,volume:{hdr:null,img:null},name:"test_image",colorMap:"gray",opacity:1,visible:!0}])};
